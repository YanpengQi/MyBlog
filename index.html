<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-big-counter.min.css?v=1.0.2">















  
  
  <link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css">







<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.0.1',
    sidebar: {"position":"left","display":"hide","offset":12,"onmobile":false,"dimmer":true},
    back2top: true,
    back2top_sidebar: false,
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Notes of study">
<meta property="og:type" content="website">
<meta property="og:title" content="Yanpeng">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Yanpeng">
<meta property="og:description" content="Notes of study">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Yanpeng">
<meta name="twitter:description" content="Notes of study">





  
  
  <link rel="canonical" href="http://yoursite.com/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Yanpeng</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Yanpeng</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">Notes of study, work and life</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags<span class="badge">22</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories<span class="badge">2</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives<span class="badge">26</span></a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    
  
  
  
  

  

  <a href="https://github.com/YanpengQi" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" style="fill: #222; color: #fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/07/[Notes] Notes of Algorithm CS5800/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yanpeng Luo">
      <meta itemprop="description" content="Notes of study, work and life">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yanpeng">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/05/07/[Notes] Notes of Algorithm CS5800/" class="post-title-link" itemprop="url">Notes of Algorithm</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-05-07 20:41:45" itemprop="dateCreated datePublished" datetime="2019-05-07T20:41:45-07:00">2019-05-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-10 17:46:41" itemprop="dateModified" datetime="2019-06-10T17:46:41-07:00">2019-06-10</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">26k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">24 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"></script>


<h1 id="Class-1-05-06-2019"><a href="#Class-1-05-06-2019" class="headerlink" title="Class 1 05/06/2019"></a>Class 1 05/06/2019</h1><h2 id="Fibonacci-numbers"><a href="#Fibonacci-numbers" class="headerlink" title="Fibonacci numbers"></a>Fibonacci numbers</h2><h3 id="Fibonacci-numbers-Exponential-Algorithm"><a href="#Fibonacci-numbers-Exponential-Algorithm" class="headerlink" title="Fibonacci numbers (Exponential Algorithm)"></a>Fibonacci numbers (Exponential Algorithm)</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0, 1, 1, 2, 3, 5, 8, 13, 21</span><br><span class="line">a0, a1, a3, a3, a4, a5, a6, a7</span><br><span class="line"></span><br><span class="line">an = an-1 + an-2</span><br><span class="line">a0 = 0</span><br><span class="line">a1 = 1</span><br></pre></td></tr></table></figure>
<h3 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fib1(<span class="keyword">int</span> n) &#123;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span> || n == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fib1(n-<span class="number">1</span>) + fib1(n-<span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Time-Complexity"><a href="#Time-Complexity" class="headerlink" title="Time Complexity"></a>Time Complexity</h3><p>Answer <code>O(2^n)</code></p>
<p>Less intuitive, not like<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    a[i] = a[i<span class="number">-1</span>] + <span class="number">2</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Recursion-Tree"><a href="#Recursion-Tree" class="headerlink" title="Recursion Tree"></a>Recursion Tree</h2><p>$ T(n) = \text {runtime of fib1(n)}$</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">              T(n)</span><br><span class="line">       /              \</span><br><span class="line">    T(n-1)           T(n-2)</span><br><span class="line">   /     \           /     \</span><br><span class="line">T(n-2)   T(n-3)    T(n-3)   T(n-4)</span><br><span class="line">            ......</span><br><span class="line">T(1)    T(0)    T(1)    T(0) ...</span><br></pre></td></tr></table></figure>
<p>When hit 0 or 1, the recursion ends.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">            /\</span><br><span class="line">           /  \</span><br><span class="line">          /____\</span><br><span class="line">         /     /</span><br><span class="line">        /  _ /</span><br><span class="line">       / _/</span><br><span class="line">      /_/</span><br><span class="line">left side = n</span><br><span class="line">right side = n/2</span><br><span class="line"></span><br><span class="line">T(n) = num of nodes in this recursion tree</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">in first half of this tree</span><br><span class="line">            /\</span><br><span class="line">           /  \</span><br><span class="line">          /____\</span><br><span class="line">num of nodes = 2^k-1 = 2 ^ (n/2) - 1</span><br></pre></td></tr></table></figure>
<p>Thus we have</p>
<p>$ 2 ^ {n/2} &lt;= T(n) &lt;= 2 ^ n $</p>
<p>Therefore </p>
<p>$ 2 ^ {n/2} = (\sqrt {2}) ^ n ~= 1.4n $</p>
<p>Clearly, this is a bad time complexity algorithm.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">                  T(n)</span><br><span class="line">           /              \</span><br><span class="line">        T(n-1)           T(n-2)</span><br><span class="line">       /     \           /     \</span><br><span class="line">    T(n-2)   T(n-3)    T(n-3)   T(n-4)</span><br><span class="line"></span><br><span class="line">There are a lot of repetition in the process of calculation. </span><br><span class="line"></span><br><span class="line">e.g. T(n-2) T(n-3)</span><br></pre></td></tr></table></figure>
<h2 id="Linear-algorithm"><a href="#Linear-algorithm" class="headerlink" title="Linear algorithm"></a>Linear algorithm</h2><h3 id="Code-1"><a href="#Code-1" class="headerlink" title="Code"></a>Code</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fib2(<span class="keyword">int</span> n) &#123;</span><br><span class="line">    <span class="keyword">int</span>[] A = <span class="keyword">new</span> <span class="keyword">int</span>[n];</span><br><span class="line">    A[<span class="number">0</span>] = <span class="number">0</span>; A[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        A[i] = A[i-<span class="number">1</span>] + A[i-<span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> A[n];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Time-Complexity-1"><a href="#Time-Complexity-1" class="headerlink" title="Time Complexity"></a>Time Complexity</h3><p>Linear time: <code>O(n)</code></p>
<h2 id="Constant-space-algorithm"><a href="#Constant-space-algorithm" class="headerlink" title="Constant space algorithm"></a>Constant space algorithm</h2><h3 id="Code-2"><a href="#Code-2" class="headerlink" title="Code"></a>Code</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fib2(<span class="keyword">int</span> n) &#123;</span><br><span class="line">    <span class="keyword">int</span>[] A = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</span><br><span class="line">    A[<span class="number">0</span>] = <span class="number">0</span>; A[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        A[i%<span class="number">2</span>] = A[(i-<span class="number">1</span>)%<span class="number">2</span>] + A[(i-<span class="number">2</span>)%<span class="number">2</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> A[n%<span class="number">2</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Analysis"><a href="#Analysis" class="headerlink" title="Analysis"></a>Analysis</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">i varies between 0 and 1</span><br><span class="line">A[1] = A[0] + A[1]</span><br><span class="line">A[0] = A[1] + A[0]</span><br></pre></td></tr></table></figure>
<h2 id="Matrix-solution"><a href="#Matrix-solution" class="headerlink" title="Matrix solution"></a>Matrix solution</h2><h3 id="Idea"><a href="#Idea" class="headerlink" title="Idea"></a>Idea</h3><p>$$<br> A = \left[<br> \begin{matrix}<br>   1 &amp; 1 \<br>   1 &amp; 0<br>  \end{matrix}<br>  \right]<br>$$</p>
<p>$$<br> A^2 = \left[<br> \begin{matrix}<br>   1 &amp; 1 \<br>   1 &amp; 0<br>  \end{matrix}<br>  \right] *<br>  \left[<br> \begin{matrix}<br>   1 &amp; 1 \<br>   1 &amp; 0<br>  \end{matrix}<br>  \right] =<br>  \left[<br> \begin{matrix}<br>   2 &amp; 1 \<br>   1 &amp; 1<br>  \end{matrix}<br>  \right] =<br>  \left[<br> \begin{matrix}<br>   1 &amp; 1 \<br>   1 &amp; 0<br>  \end{matrix}<br>  \right]<br>$$</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">A = | 1  1 | = | a2  a1 |</span><br><span class="line">    | 1  0 |   | a1  a0 |</span><br><span class="line"></span><br><span class="line">A^2 = | 1  1 |    | 1  1 |      | 2  1 |   | a3  a2 |</span><br><span class="line">      | 1  0 | *  | 1  0 |  =   | 1  1 | = | a2  a1 |</span><br><span class="line"></span><br><span class="line">A^3 = | 2  1 |    | 1  1 |      | 3  2 |   | a4  a5 |</span><br><span class="line">      | 1  1 | *  | 1  0 |  =   | 2  1 | = | a3  a2 |           </span><br><span class="line"></span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line"> A^k = | a(k+1)  ak   |   </span><br><span class="line">       | ak      ak-1 |</span><br></pre></td></tr></table></figure>
<h3 id="Time-Complexity-2"><a href="#Time-Complexity-2" class="headerlink" title="Time Complexity"></a>Time Complexity</h3><p>Basic: <code>O(n)</code></p>
<p>Optimized: <code>O(logn)</code></p>
<h3 id="Strategy"><a href="#Strategy" class="headerlink" title="Strategy"></a>Strategy</h3><p>Since we are dealing with A^n, the optimized time complexity of pow(x, n) is  <code>O(logn)</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">A^n =   |A(n/2)^2         | n is even</span><br><span class="line">        |A((n-1)/2)^2 * A | n is odd</span><br><span class="line"></span><br><span class="line">A^64 = (A^32)^2 = ((A^16))^2^2 = A^(2^6)</span><br></pre></td></tr></table></figure></p>
<h2 id="Asymptotic-Notation"><a href="#Asymptotic-Notation" class="headerlink" title="Asymptotic Notation"></a>Asymptotic Notation</h2><h3 id="Comparison-of-each-notation"><a href="#Comparison-of-each-notation" class="headerlink" title="Comparison of each notation"></a>Comparison of each notation</h3><table>
<thead>
<tr>
<th style="text-align:left">Compare Function Growth</th>
<th>Compare Numbers</th>
<th>f(n) = 5n</th>
<th>g(n) = n^2</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">O</td>
<td>&lt;=</td>
<td>f(n) = O(g(n))</td>
</tr>
<tr>
<td style="text-align:left">o</td>
<td>&lt;</td>
<td>f(n) = o(g(n)</td>
</tr>
<tr>
<td style="text-align:left">Θ</td>
<td>=</td>
<td>for f(n) = 100n</td>
<td>and g(n) = n + 100</td>
</tr>
<tr>
<td style="text-align:left">Ω</td>
<td>&gt;=</td>
<td>f(n) = Ω(g(n))</td>
<td>f(n) = Θ(g(n))</td>
</tr>
<tr>
<td style="text-align:left">ω</td>
<td>&gt;=</td>
<td>f(n) = ω(g(n))</td>
</tr>
</tbody>
</table>
<h3 id="Mathematical-Derivation"><a href="#Mathematical-Derivation" class="headerlink" title="Mathematical Derivation"></a>Mathematical Derivation</h3><p><strong>f(n) = O(g(n))</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iff exists constants C and n0</span><br><span class="line">s.t. when n &gt; n0, f(n) &lt;= C * g(n)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lim(n-&gt;inf) f(n)/g(n) =     0           | fn = O/o(g(n))</span><br><span class="line">                            constant    | fn = O/Θ/Ω(g(n))</span><br><span class="line">                            inf         | fn = Ω/ω(g(n))</span><br></pre></td></tr></table></figure>
<p>Practice:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">lim(n-&gt;inf) (100n)/(n+100) = 100 </span><br><span class="line">fn = O/Θ/Ω(g(n))</span><br><span class="line"></span><br><span class="line">f(n) = nlgn   g(n) = n^2</span><br><span class="line">f(n) = O/o(g(n))</span><br><span class="line"></span><br><span class="line">f(n) = 2^n   g(n) = 3^n</span><br><span class="line">f(n) = O/o(g(n))</span><br><span class="line">lim(n-&gt;inf) f(n)/g(n) = lim(n-&gt;inf) (2/3)^n = 0</span><br><span class="line"></span><br><span class="line">f(n) = n+3   g(n) = 2 * sqrt(n)</span><br><span class="line">f(n) = Ω/ω(g(n))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">f(n) = log2(n)   g(n) = log3(n)</span><br><span class="line">f(n) = Ω/ω/Θ(g(n))</span><br><span class="line">lim(n-&gt;inf) f(n)/g(n) = lim(n-&gt;inf) log2n/log3n = log3/log2</span><br><span class="line"></span><br><span class="line">f(n) = (logn)^2   g(n) = log(n^2) = 2logn</span><br><span class="line">f(n) = Ω/ω(g(n))</span><br></pre></td></tr></table></figure></p>
<h2 id="Master’s-Theorem"><a href="#Master’s-Theorem" class="headerlink" title="Master’s Theorem"></a>Master’s Theorem</h2><h3 id="Idea-of-merge-sort"><a href="#Idea-of-merge-sort" class="headerlink" title="Idea of merge sort"></a>Idea of merge sort</h3><p>T(n) = 2T(n/2) + n</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">             T(n) n                         | n</span><br><span class="line">          /          \</span><br><span class="line">    T(n/2) n/2          T(n/2) n/2          | n</span><br><span class="line">   /     \           /     \</span><br><span class="line">T(n/4)   T(n/4)    T(n/4)   T(n/4)          | n</span><br><span class="line">            ......</span><br><span class="line">T(1)    T(1)    T(1)    T(1) ...            | n</span><br></pre></td></tr></table></figure>
<h3 id="Time-Complexity-of-merge-sort"><a href="#Time-Complexity-of-merge-sort" class="headerlink" title="Time Complexity of merge sort"></a>Time Complexity of merge sort</h3><p>T(n) = height <em> T(level) = logn </em> n = nlogn</p>
<h3 id="Master’s-Theorem-1"><a href="#Master’s-Theorem-1" class="headerlink" title="Master’s Theorem"></a>Master’s Theorem</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">T(n) = a * T(n/b) + n^c, where a, b, c are constants</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line">T(n) = 2 * T(n/2) + n</span><br><span class="line">T(n) = 8 * T(n/2) + n^2</span><br><span class="line">T(n) = T(n/2) + 1</span><br><span class="line">T(n) = T(n/3) + T(2n/3) + n  (Not master&apos;s theorem)</span><br></pre></td></tr></table></figure>
<p>Now we have to compare logb(a) and c</p>
<ul>
<li>logb(a) &gt; c T(n) = Θ(n^(logb(a)))</li>
<li>logb(a) = c T(n) = Θ((n^c) * logn)</li>
<li>logb(a) &lt; c T(n) = Θ(n^c)</li>
</ul>
<p>Practice<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">T(n) = T(n/2) + 1   T(n) = Θ(lgn)</span><br><span class="line">T(n) = 8T(n/2) + n^2   T(n) = Θ(n^3)</span><br><span class="line">T(n) = 7T(n/2) + n^2   T(n) = Θ(n^(log2(7)))</span><br><span class="line">T(n) = 4T(n/2) + n^2   T(n) = Θ(n^2 * (log2n))</span><br><span class="line">T(n) = T(n/2) + n  T(n) = Θ(n)</span><br><span class="line">T(n) = T(n-1) + n  (Not master&apos;s theorem)</span><br></pre></td></tr></table></figure></p>
<p>Draw the Recursion Tree of the last one<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Recursion Tree of T(n) = T(n-1) + n </span><br><span class="line"></span><br><span class="line">        T(n) n</span><br><span class="line">        T(n-1) n-1</span><br><span class="line">        T(n-2) n-2</span><br><span class="line">        ...</span><br><span class="line">        T(1) 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">T(n) = 1 + 2 + 3 + ... + n = n(n+1)/2</span><br><span class="line">Θ(n) = n^2</span><br></pre></td></tr></table></figure></p>
<h3 id="Other-useful-Summation-Formula"><a href="#Other-useful-Summation-Formula" class="headerlink" title="Other useful Summation Formula"></a>Other useful Summation Formula</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1 + 2 + 3 + .. + n = n(n+1)/2</span><br><span class="line"></span><br><span class="line">q^0 + q^1 + q^2 + ... q^n = (q^(n+1) -1)/(q-1)</span><br><span class="line"></span><br><span class="line">1 + 1/2 + 1/3 + ... + 1/n = Θ(ln(n))</span><br></pre></td></tr></table></figure>
<h3 id="Normal-case"><a href="#Normal-case" class="headerlink" title="Normal case"></a>Normal case</h3><p>T(n) = T(n/3) + T(2n/3) + n</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">             T(n) n                         | n</span><br><span class="line">          /          \</span><br><span class="line">    T(n/3) n/3        T(2n/3)  2n/3         | n</span><br><span class="line">   /     \           /     \</span><br><span class="line">T(n/9)   T(2n/9)    T(2n/9)   T(4n/9)       | n</span><br><span class="line">            ......</span><br><span class="line">T(1)    T(1)    T(1)    T(1) ...            | n</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">            /\</span><br><span class="line">           /  \</span><br><span class="line">          /____\</span><br><span class="line">          \     \</span><br><span class="line">            \    \</span><br><span class="line">              \   \</span><br><span class="line">                \_\</span><br><span class="line"></span><br><span class="line">left side = log3n</span><br><span class="line">right side = log3/2(n)</span><br><span class="line"></span><br><span class="line">T(n) = num of nodes in this recursion tree</span><br><span class="line"></span><br><span class="line">n * log3(n) &lt;= T(n) &lt;= n * log3/2(n)</span><br></pre></td></tr></table></figure>
<h3 id="Time-Complexity-of-Normal-recursion-tree"><a href="#Time-Complexity-of-Normal-recursion-tree" class="headerlink" title="Time Complexity of Normal recursion tree"></a>Time Complexity of Normal recursion tree</h3><p><code>T(n) = Θ(nlgn)</code></p>
<h3 id="Some-examples"><a href="#Some-examples" class="headerlink" title="Some examples"></a>Some examples</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">T(n) = T(n/4) + T(3n/4) + n             T(n) = Θ(nlgn)</span><br><span class="line">T(n) = T(n/1000) + T(999n/1000) + n     T(n) = Θ(nlgn)</span><br><span class="line">T(n) = T(n-1) + T(1) + n                T(n) = Θ(n^2)</span><br></pre></td></tr></table></figure>
<h2 id="Quick-Sort"><a href="#Quick-Sort" class="headerlink" title="Quick Sort"></a>Quick Sort</h2><h3 id="Partition"><a href="#Partition" class="headerlink" title="Partition"></a>Partition</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Given array like</span><br><span class="line"></span><br><span class="line">|1 |9 |2 |8 |3 |8 |7 |5 |6 |</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Choose a pivot, put all num &lt; pivot in left, others in right</span><br><span class="line"></span><br><span class="line">|    nums &lt;=  pivot  |pivot|  nums &gt; pivot   |</span><br><span class="line"></span><br><span class="line">The process is partition(A[], i, j)</span><br></pre></td></tr></table></figure>
<h3 id="Code-3"><a href="#Code-3" class="headerlink" title="Code"></a>Code</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">QuickSort(<span class="keyword">int</span>[] A, <span class="keyword">int</span> i, <span class="keyword">int</span> j) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= j) &#123;<span class="keyword">return</span>;&#125;</span><br><span class="line">    <span class="keyword">int</span> pivot_pos = Partition(A, i, j);</span><br><span class="line">    QuickSort(A, i, pivot_pos-<span class="number">1</span>);</span><br><span class="line">    QuickSort(A, pivot_pos+<span class="number">1</span>, j);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Time-Complexity-3"><a href="#Time-Complexity-3" class="headerlink" title="Time Complexity"></a>Time Complexity</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">T(n) = 2T(n/2) + n = Θ(nlogn)</span><br><span class="line">T(n) = T(n/3) + T(2n/3) + n = Θ(nlogn)</span><br><span class="line">T(n) = T(n/1000) + T(999n/1000) + n = Θ(nlogn)</span><br><span class="line"></span><br><span class="line">Worst Case</span><br><span class="line">T(n) = T(n-1) + n = Θ(n^2)</span><br></pre></td></tr></table></figure>
<p>Average <code>T(n) = Θ(nlogn)</code></p>
<p>Worst   <code>T(n) = Θ(n^2)</code></p>
<h3 id="Code-of-Partition"><a href="#Code-of-Partition" class="headerlink" title="Code of Partition"></a>Code of Partition</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pivot = A[j]</span><br><span class="line">| i |  ... | p | p+1 |  ...  | cur |  ...  | j |</span><br><span class="line"></span><br><span class="line">i - p: &lt;= pivot</span><br><span class="line">p - p+1: &gt; pivot</span><br><span class="line">cur: current pointer</span><br></pre></td></tr></table></figure>
<ul>
<li><p>A[cur] &gt; pivot  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cur += <span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>A[cur] &lt;= pivot  </p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swap(A[cur], A[p+<span class="number">1</span>]);</span><br><span class="line">p += <span class="number">1</span>;</span><br><span class="line">cur += <span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Partition(<span class="keyword">int</span>[] A, <span class="keyword">int</span> i, <span class="keyword">int</span> j) &#123;</span><br><span class="line">    <span class="keyword">int</span> pivot = A[j];</span><br><span class="line">    <span class="keyword">int</span> p = i - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> cur = i; cur &lt;= j-<span class="number">1</span>; cur++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (A[cur] &lt;= pivot) &#123;</span><br><span class="line">            swap(A[cur], A[p+<span class="number">1</span>]);</span><br><span class="line">            p += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    swap(A[j], A[p+<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">return</span> p+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Class-2-05-13-2019"><a href="#Class-2-05-13-2019" class="headerlink" title="Class 2 05/13/2019"></a>Class 2 05/13/2019</h1><h2 id="Review"><a href="#Review" class="headerlink" title="Review"></a>Review</h2><h3 id="Review-of-quicksort"><a href="#Review-of-quicksort" class="headerlink" title="Review of quicksort"></a>Review of quicksort</h3><h3 id="Stable-Sort"><a href="#Stable-Sort" class="headerlink" title="Stable Sort"></a>Stable Sort</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">| ... | 5(1) | ...  |  ...  | 5(2) |  ...  |</span><br><span class="line"></span><br><span class="line">After sort</span><br><span class="line"></span><br><span class="line">| ... | 5(1)| 5(2) |  ...  |</span><br><span class="line"></span><br><span class="line">If two 5 are still in their relative positions, then this is a stable sort.</span><br></pre></td></tr></table></figure>
<h3 id="Runtime-of-Quick-Sort"><a href="#Runtime-of-Quick-Sort" class="headerlink" title="Runtime of Quick Sort"></a>Runtime of Quick Sort</h3><p>Runtime: </p>
<p>Average: $O(nlogn)$<br>Worst: $O(n^2)$</p>
<p>The worst case is $T(n) = T(n-1) + n$</p>
<h3 id="Pivot-Selection"><a href="#Pivot-Selection" class="headerlink" title="Pivot Selection"></a>Pivot Selection</h3><ul>
<li>Median of Three</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">| i | ... | (i+j)/2 | ... |  j  |</span><br></pre></td></tr></table></figure>
<h2 id="Heap-Sort"><a href="#Heap-Sort" class="headerlink" title="Heap Sort"></a>Heap Sort</h2><h3 id="Types-of-Heap"><a href="#Types-of-Heap" class="headerlink" title="Types of Heap"></a>Types of Heap</h3><ol>
<li>Max Heap</li>
<li>Min Heap</li>
</ol>
<h3 id="Operations-of-Heap"><a href="#Operations-of-Heap" class="headerlink" title="Operations (of Heap)"></a>Operations (of Heap)</h3><ul>
<li>Insert(E)    $O(logn)$</li>
<li>getMax()          $O(1)$</li>
<li>deleteMax()       $O(logn)$</li>
</ul>
<h3 id="Operations-of-Sorted-Array"><a href="#Operations-of-Sorted-Array" class="headerlink" title="Operations (of Sorted Array)"></a>Operations (of Sorted Array)</h3><ul>
<li>Insert(E)    $O(n)$</li>
<li>getMax()          $O(1)$</li>
<li>deleteMax()       $O(1)$</li>
</ul>
<h3 id="Comparison-of-array-and-heap"><a href="#Comparison-of-array-and-heap" class="headerlink" title="Comparison of array and heap"></a>Comparison of array and heap</h3><p>The worst time of heap operation is logn.</p>
<p>However, A sorted array takes On time to insert, which is the bottleneck of the overall time complexity. </p>
<h3 id="Logical-View-and-Physical-View"><a href="#Logical-View-and-Physical-View" class="headerlink" title="Logical View and Physical View"></a>Logical View and Physical View</h3><p><strong>Logical View</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">          7(1)</span><br><span class="line">         /    \</span><br><span class="line">      3(2)      6(3)</span><br><span class="line">     /   \       /</span><br><span class="line">   1(4)  2(5)  5(6)</span><br><span class="line"></span><br><span class="line">Almost-Full Binary Tree</span><br><span class="line">Parent must be &gt;= both children</span><br></pre></td></tr></table></figure></p>
<p><strong>Physical View</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">               1   2   3   4   5   6</span><br><span class="line">Array        | 7 | 3 | 6 | 1 | 2 | 5 |</span><br></pre></td></tr></table></figure>
<h3 id="helper-functions-of-heap"><a href="#helper-functions-of-heap" class="headerlink" title="helper functions of heap"></a>helper functions of heap</h3><p>i is the index</p>
<p><code>parent(i)</code> = i / 2<br><code>leftChild(i)</code> = i <em> 2<br><code>rightChild</code> = i </em> 2+1</p>
<h3 id="getMax-O-1"><a href="#getMax-O-1" class="headerlink" title="getMax() O(1)"></a>getMax() O(1)</h3><p>getMax() - return A[1]</p>
<h3 id="insert-O-logn"><a href="#insert-O-logn" class="headerlink" title="insert() O(logn)"></a>insert() O(logn)</h3><p><strong>Case 1</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">           7(1)</span><br><span class="line">         /      \</span><br><span class="line">      3(2)      6(3)</span><br><span class="line">     /   \       / \</span><br><span class="line">   1(4)  2(5)  5(6) 3(7)</span><br><span class="line"></span><br><span class="line">No need to adjust</span><br></pre></td></tr></table></figure>
<p><strong>Case 2</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">           7(1)</span><br><span class="line">         /      \</span><br><span class="line">      3(2)      6(3)</span><br><span class="line">     /   \       / \</span><br><span class="line">   1(4)  2(5)  5(6) 8(7)</span><br><span class="line"></span><br><span class="line">Swap 8 with 6</span><br><span class="line"></span><br><span class="line">           7(1)</span><br><span class="line">         /      \</span><br><span class="line">      3(2)      8(3)</span><br><span class="line">     /   \       / \</span><br><span class="line">   1(4)  2(5)  5(6) 6(7)</span><br><span class="line"></span><br><span class="line">Swap 7 with 8</span><br><span class="line"></span><br><span class="line">           8(1)</span><br><span class="line">         /      \</span><br><span class="line">      3(2)      7(3)</span><br><span class="line">     /   \       / \</span><br><span class="line">   1(4)  2(5)  5(6) 6(7)  </span><br><span class="line"></span><br><span class="line">Complete inserting.</span><br><span class="line"></span><br><span class="line">                        1   2   3   4   5   6   7</span><br><span class="line">Array(after insert)   | 8 | 3 | 7 | 1 | 2 | 5 | 6|</span><br></pre></td></tr></table></figure>
<h3 id="Code-of-insert"><a href="#Code-of-insert" class="headerlink" title="Code of insert()"></a>Code of insert()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> e)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// increase the size n of the heap</span></span><br><span class="line">    n += <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// insert the item to heap A</span></span><br><span class="line">    A[n] = e;</span><br><span class="line">    <span class="comment">// Adjust from index i=n</span></span><br><span class="line">    <span class="keyword">int</span> i = n;</span><br><span class="line">    <span class="comment">// if cur node has a parent and the parent is smaller</span></span><br><span class="line">    <span class="keyword">while</span> (parent(i) &gt; <span class="number">0</span> &amp;&amp; A[parent(i)] &lt; A[i]) &#123;</span><br><span class="line">        swap(A[parent(i)], A[i]);</span><br><span class="line">        i = parent(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="deleteMax"><a href="#deleteMax" class="headerlink" title="deleteMax()"></a>deleteMax()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">           8(1)</span><br><span class="line">         /      \</span><br><span class="line">      3(2)      7(3)</span><br><span class="line">     /   \       / \</span><br><span class="line">   1(4)  2(5)  5(6) 6(7)  </span><br><span class="line"></span><br><span class="line">Swap 6 with 8, and delete 8</span><br><span class="line"></span><br><span class="line">           6(1)</span><br><span class="line">         /      \</span><br><span class="line">      3(2)      7(3)</span><br><span class="line">     /   \       / </span><br><span class="line">   1(4)  2(5)  5(6) </span><br><span class="line"></span><br><span class="line">                      1   2   3   4   5   6  </span><br><span class="line">Array(after swap)   | 6 | 3 | 7 | 1 | 2 | 5 | </span><br><span class="line"></span><br><span class="line">Swap 6 with 7</span><br><span class="line"></span><br><span class="line">           7(1)</span><br><span class="line">         /      \</span><br><span class="line">      3(2)      6(3)</span><br><span class="line">     /   \       / </span><br><span class="line">   1(4)  2(5)  5(6) </span><br><span class="line"></span><br><span class="line">                      1   2   3   4   5   6  </span><br><span class="line">Array(after swap)   | 7 | 3 | 6 | 1 | 2 | 5 | </span><br><span class="line"></span><br><span class="line">Heap is balanced. </span><br><span class="line">deleteMax() completed.</span><br></pre></td></tr></table></figure>
<h3 id="heapify"><a href="#heapify" class="headerlink" title="heapify()"></a>heapify()</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">           6(1)</span><br><span class="line">         /      \</span><br><span class="line">      3(2)      7(3)</span><br><span class="line">     /   \       / </span><br><span class="line">   1(4)  2(5)  5(6)  </span><br><span class="line"></span><br><span class="line">The subTree of root 3 is a MaxHeap</span><br><span class="line">The subTree of root 7 is a MaxHeap</span><br><span class="line">However, the tree of root 6 is not a MaxHeap.</span><br><span class="line">Now we need the heapify().</span><br></pre></td></tr></table></figure>
<h3 id="Code-of-heapify"><a href="#Code-of-heapify" class="headerlink" title="Code of heapify()"></a>Code of heapify()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">heapify</span><span class="params">(<span class="keyword">int</span>[] A, i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> largest = i;</span><br><span class="line">    <span class="comment">// Find the largest of cur root(i) and its children</span></span><br><span class="line">    <span class="comment">// if left child exists and left child is bigger than cur root</span></span><br><span class="line">    <span class="keyword">if</span> (leftChild(i) &lt;= n &amp;&amp; A[leftChild(i)] &gt; A[largest]) &#123;</span><br><span class="line">        largest = leftChild(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// if left child exists and left child is bigger than cur root</span></span><br><span class="line">    <span class="keyword">if</span> (rightChild(i) &lt;= n &amp;&amp; A[rightChild(i)] &gt; A[largest]) &#123;</span><br><span class="line">        largest = rightChild(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// check largest</span></span><br><span class="line">    <span class="keyword">if</span> (largest == i) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// let the cur largest node be the root</span></span><br><span class="line">    swap(A[i], A[largest]);</span><br><span class="line">    <span class="comment">// continue heapifying down the swapped node recursively</span></span><br><span class="line">    heapify(A, largest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Code-of-deleteMax"><a href="#Code-of-deleteMax" class="headerlink" title="Code of deleteMax()"></a>Code of deleteMax()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">deleteMax</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// swap the cur root with the last node</span></span><br><span class="line">    swap(A[<span class="number">1</span>], A[n]);</span><br><span class="line">    <span class="comment">// delete the last node</span></span><br><span class="line">    n -= <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// heapify the whole heap</span></span><br><span class="line">    heapify(A, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Heap-Sort-1"><a href="#Heap-Sort-1" class="headerlink" title="Heap Sort"></a>Heap Sort</h3><p><strong>Max Heap</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">          1   2   3   4   5   6  </span><br><span class="line">Array   | 7 | 3 | 6 | 1 | 2 | 5 | </span><br><span class="line"></span><br><span class="line">Pretend we are deleting the max val.(deleteMax())</span><br><span class="line"></span><br><span class="line">                         1   2   3   4   5 || 6  </span><br><span class="line">Array(after deleted)   | 5 | 3 | 6 | 1 | 2 || 7(max) |</span><br><span class="line">Now we get the biggest node in the tail of the array.</span><br><span class="line">continue sort the rest.</span><br></pre></td></tr></table></figure></p>
<h3 id="Code-of-Heap-Sort"><a href="#Code-of-Heap-Sort" class="headerlink" title="Code of Heap Sort"></a>Code of Heap Sort</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">heapSort</span><span class="params">(<span class="keyword">int</span>[] A)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = n; i &gt;= <span class="number">1</span>; i--) &#123;</span><br><span class="line">        deleteHeap(A, <span class="number">1</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### makeHeap()</span><br><span class="line"></span><br><span class="line">Solution <span class="number">1</span> insert n times `O(nlogn)`</span><br><span class="line"></span><br><span class="line">Solution <span class="number">2</span></span><br></pre></td></tr></table></figure>
<pre><code>      6(1)
    /      \
 3(2)      7(3)
/   \       / 
</code></pre><p>   1(4)  2(5)  5(6)  </p>
<p>n = 3 is the last non-trivil node<br>we heapify the 7, 3, 6 nodes, where we ensure that all children are valid heap.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### Code of makeHeap()</span><br><span class="line"></span><br><span class="line">```Java</span><br><span class="line">// n/2 means the last non-trivil node in the heap</span><br><span class="line">for (int i = n/2; i &gt;=1; i--) &#123;</span><br><span class="line">    heapify(A, i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Example-of-heap-sort"><a href="#Example-of-heap-sort" class="headerlink" title="Example of heap sort"></a>Example of heap sort</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">First, make this into a heap.</span><br><span class="line"></span><br><span class="line">           9(1)</span><br><span class="line">         /      \</span><br><span class="line">      2(2)      6(3)</span><br><span class="line">     /   \       / </span><br><span class="line">   1(4)  4(5)  3(6)  </span><br><span class="line"></span><br><span class="line">          1   2   3   4   5   6  </span><br><span class="line">Array   | 9 | 2 | 6 | 1 | 4 | 3 |    </span><br><span class="line"></span><br><span class="line">call makeHeap() on 6</span><br><span class="line"></span><br><span class="line">call makeHeap() on 2</span><br><span class="line"></span><br><span class="line">           9(1)</span><br><span class="line">         /      \</span><br><span class="line">      4(2)      6(3)</span><br><span class="line">     /   \       / </span><br><span class="line">   1(4)  2(5)  3(6)  </span><br><span class="line"></span><br><span class="line">          1   2   3   4   5   6  </span><br><span class="line">Array   | 9 | 4 | 6 | 1 | 2 | 3 |  </span><br><span class="line"></span><br><span class="line">call deleteHeap() on 9</span><br><span class="line"></span><br><span class="line">           3(1)</span><br><span class="line">         /      \</span><br><span class="line">      4(2)      6(3)</span><br><span class="line">     /   \       </span><br><span class="line">   1(4)  2(5)  </span><br><span class="line"></span><br><span class="line">          1   2   3   4   5    6  </span><br><span class="line">Array   | 3 | 4 | 6 | 1 | 2 || 9 |</span><br><span class="line"></span><br><span class="line">call heapify() on 3</span><br><span class="line"></span><br><span class="line">           6(1)</span><br><span class="line">         /      \</span><br><span class="line">      4(2)      3(3)</span><br><span class="line">     /   \       </span><br><span class="line">   1(4)  2(5)  </span><br><span class="line"></span><br><span class="line">          1   2   3   4   5    6  </span><br><span class="line">Array   | 6 | 4 | 3 | 1 | 2 || 9 |</span><br><span class="line"></span><br><span class="line">call deleteHeap() on 6</span><br><span class="line"></span><br><span class="line">           2(1)</span><br><span class="line">         /      \</span><br><span class="line">      4(2)      3(3)</span><br><span class="line">     /       </span><br><span class="line">   1(4)  </span><br><span class="line"></span><br><span class="line">          1   2   3   4    5   6  </span><br><span class="line">Array   | 2 | 4 | 3 | 1 || 6 | 9 |</span><br><span class="line"></span><br><span class="line">call heapify() on 2</span><br><span class="line"></span><br><span class="line">           4(1)</span><br><span class="line">         /      \</span><br><span class="line">      2(2)      3(3)</span><br><span class="line">     /         </span><br><span class="line">   1(4)   </span><br><span class="line"></span><br><span class="line">          1   2   3   4    5   6  </span><br><span class="line">Array   | 4 | 2 | 3 | 1 || 6 | 9 |</span><br><span class="line"></span><br><span class="line">call deleteHeap() on 4</span><br><span class="line"></span><br><span class="line">           1(1)</span><br><span class="line">         /      \</span><br><span class="line">      2(2)      3(3)</span><br><span class="line">     /          </span><br><span class="line">   4(4)   </span><br><span class="line"></span><br><span class="line">          1   2   3    4   5   6  </span><br><span class="line">Array   | 1 | 2 | 3 || 4 | 6 | 9 |</span><br><span class="line">...</span><br><span class="line">The array is sorted.</span><br></pre></td></tr></table></figure>
<h2 id="Sorting-Algorithms"><a href="#Sorting-Algorithms" class="headerlink" title="Sorting Algorithms"></a>Sorting Algorithms</h2><h3 id="Types-of-sorting-algorithms"><a href="#Types-of-sorting-algorithms" class="headerlink" title="Types of sorting algorithms"></a>Types of sorting algorithms</h3><table>
<thead>
<tr>
<th style="text-align:center">Algorithm</th>
<th style="text-align:center">Time Complexity</th>
<th style="text-align:center">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Quick Sort</td>
<td style="text-align:center">$O(nlogn)$</td>
</tr>
<tr>
<td style="text-align:center">Merge Sort</td>
<td style="text-align:center">$O(nlogn)$</td>
</tr>
<tr>
<td style="text-align:center">Heap Sort</td>
<td style="text-align:center">$O(nlogn)$</td>
</tr>
<tr>
<td style="text-align:center">Bubble Sort</td>
<td style="text-align:center">$O(n^2)$</td>
</tr>
<tr>
<td style="text-align:center">Insertion SOrt</td>
<td style="text-align:center">$O(n^2)$</td>
</tr>
<tr>
<td style="text-align:center">Selection SOrt</td>
<td style="text-align:center">$O(n^2)$</td>
</tr>
<tr>
<td style="text-align:center">Counting SOrt</td>
<td style="text-align:center">$O(n)$</td>
<td style="text-align:center">Non-comparison based</td>
</tr>
<tr>
<td style="text-align:center">Radix SOrt</td>
<td style="text-align:center">$O(n)$</td>
<td style="text-align:center">Non-comparison based</td>
</tr>
</tbody>
</table>
<h3 id="Theorem-of-comparison-based-sorting-algorithm"><a href="#Theorem-of-comparison-based-sorting-algorithm" class="headerlink" title="Theorem of comparison based sorting algorithm"></a>Theorem of comparison based sorting algorithm</h3><p>Comparison based sorting algorithm always run in $Ω(nlogn)$.</p>
<h2 id="Counting-Sort"><a href="#Counting-Sort" class="headerlink" title="Counting Sort"></a>Counting Sort</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Assume we have array A</span><br><span class="line">The input nums should satisfy 0 &lt;= A[i] &lt;= k</span><br><span class="line"></span><br><span class="line">input   A    | 2 | 1 | 3 | 5 | 4 | 2 | 1 | 0 | 3 |</span><br><span class="line"></span><br><span class="line">               0   1   2   3   4   5</span><br><span class="line">bucket  B    | 1 | 2 | 2 | 2 | 1 | 1 |</span><br><span class="line"></span><br><span class="line">               0   1   2   3   4   5</span><br><span class="line">bucket  B&apos;   | 1 | 3 | 5 | 7 | 8 | 9 |</span><br><span class="line"></span><br><span class="line">output  C    | 0 | 1 | 1 | 2 | 2 | 3 | 3 | 4 | 5 |</span><br><span class="line"></span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">### Code of Counting Sort</span><br><span class="line"></span><br><span class="line">```Java</span><br><span class="line">//Step of counting sort</span><br><span class="line">// fill the num in the buckets</span><br><span class="line">for (int i = 0; i &lt; n; i++) &#123;</span><br><span class="line">    B[A[i]] += 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// indicates where the curr digit ends in the ouput array</span><br><span class="line">for (int i = 0; i &lt;= k; i++) &#123;</span><br><span class="line">    B[i] += B[i-1];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// fill the digit into the array</span><br><span class="line">for (int i = n-1; i &gt;= 0; i--) &#123;</span><br><span class="line">    C[B[A[i]]] = A[i];</span><br><span class="line">    B[A[i]] -= 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return C;</span><br></pre></td></tr></table></figure>
<h3 id="problems-of-Counting-Sort"><a href="#problems-of-Counting-Sort" class="headerlink" title="problems of Counting Sort"></a>problems of Counting Sort</h3><p>Q: Why 0-based?<br>A: To represent the case where the input has 0.</p>
<p>Q: what happened if we have negative input?<br>A: Map the input to the form we want. e.g. <code>[-10, 10] -&gt; [0, 20]</code></p>
<p>Q: Is this algorithm stable?<br>A: In this case, yes.</p>
<h3 id="Analysis-of-Counting-Sort"><a href="#Analysis-of-Counting-Sort" class="headerlink" title="Analysis of Counting Sort"></a>Analysis of Counting Sort</h3><p>Run time: $O(n+k)$<br>Space: $O(k)$</p>
<h2 id="Radix-Sort"><a href="#Radix-Sort" class="headerlink" title="Radix Sort"></a>Radix Sort</h2><h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>Also known as digit sort.</p>
<p>Only for positive base 10 integers.</p>
<h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Use the counting sort to sort the colomn</span><br><span class="line"></span><br><span class="line">100      100     100       4</span><br><span class="line"> 23       41       4      13</span><br><span class="line">123      512     512      23  </span><br><span class="line">512       23     013      41</span><br><span class="line">  4  =&gt;  123 =&gt;   23  =&gt; 100</span><br><span class="line"> 13       13     123     123</span><br><span class="line"> 41        4      41     512</span><br><span class="line">999      999     999     999</span><br></pre></td></tr></table></figure>
<h3 id="Analysis-1"><a href="#Analysis-1" class="headerlink" title="Analysis"></a>Analysis</h3><p>d is the number of digits, k is the range of the inputs(e.g. 32 bit integer)<br>Run time: $O((n+k)d)$<br>Space:</p>
<p>e.g.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">32-bit int</span><br><span class="line">| 8-bit | 8-bit | 8-bit | 8-bit |  </span><br><span class="line">d = 4 times of counting sort</span><br><span class="line">k = 2^8 = 256</span><br></pre></td></tr></table></figure></p>
<h1 id="Class-3-05-20-2019"><a href="#Class-3-05-20-2019" class="headerlink" title="Class 3 05/20/2019"></a>Class 3 05/20/2019</h1><h2 id="Questions-about-Order-Statistics"><a href="#Questions-about-Order-Statistics" class="headerlink" title="Questions about Order Statistics"></a>Questions about Order Statistics</h2><p>Given a collection of integers, get the min/max value, median, 25% element, rth smallest element, etc.</p>
<p>Question: How do we find the rth smallest element?</p>
<h3 id="Solution1-Sort-the-array"><a href="#Solution1-Sort-the-array" class="headerlink" title="Solution1 Sort the array"></a>Solution1 Sort the array</h3><ol>
<li>sort array</li>
<li>return A[k]</li>
</ol>
<p>The run time should be O(nlgn)</p>
<h3 id="Solution2-Based-Partition"><a href="#Solution2-Based-Partition" class="headerlink" title="Solution2 Based Partition"></a>Solution2 Based Partition</h3><h4 id="Idea-1"><a href="#Idea-1" class="headerlink" title="Idea"></a>Idea</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Definition 2</span><br><span class="line"></span><br><span class="line">| 1 | ... | start | ... | end | ... | 10 |</span><br><span class="line"></span><br><span class="line">A   | 1 | 2 | 3 | 6 | 7 | 5 | 4 |</span><br><span class="line"></span><br><span class="line">pos = partition(A, 1, 7, 5)</span><br><span class="line">pos = 3</span><br><span class="line"></span><br><span class="line">if we get the 3 as the pivot position, which means we still have to find 2 more elements</span><br><span class="line"></span><br><span class="line">we continue searching on kth(A, 4, 7, 2)</span><br></pre></td></tr></table></figure>
<h4 id="Code-4"><a href="#Code-4" class="headerlink" title="Code"></a>Code</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// definition 1</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">findKth</span><span class="params">(<span class="keyword">int</span>[] A, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pos = partition(A, <span class="number">1</span>, n);</span><br><span class="line">    <span class="keyword">if</span> (pos == k) <span class="keyword">return</span> A[k];</span><br><span class="line">    <span class="keyword">if</span> (pos &gt; k) <span class="keyword">return</span> findKth(A, <span class="number">1</span>, pos);</span><br><span class="line">    <span class="keyword">if</span> (pos &lt; k) <span class="keyword">return</span> findKth(A, pos+<span class="number">1</span>, n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// definition 2</span></span><br><span class="line"><span class="comment">// global index</span></span><br><span class="line"><span class="comment">// rank of number with A[begin...end]</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">findKth</span><span class="params">(<span class="keyword">int</span>[]A, <span class="keyword">int</span> begin, <span class="keyword">int</span> end, <span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Analysis-2"><a href="#Analysis-2" class="headerlink" title="Analysis"></a>Analysis</h4><p>$ T(n) = T(n/2) + n = O(n)$</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Example </span><br><span class="line">T(n) = T(2n/3) + n = O(n)</span><br><span class="line">T(n) = T(99n/100) + n = O(n)</span><br><span class="line">T(n) = T(n-1) + n = O(n^2)</span><br></pre></td></tr></table></figure>
<h2 id="Find-Top-K"><a href="#Find-Top-K" class="headerlink" title="Find Top K"></a>Find Top K</h2><h3 id="Solution-1-Sort-the-array"><a href="#Solution-1-Sort-the-array" class="headerlink" title="Solution 1 Sort the array"></a>Solution 1 Sort the array</h3><ol>
<li>Sort the array</li>
<li>return A[1:k]</li>
</ol>
<p>Time: $ O(nlogn) $</p>
<h3 id="Solution-2-findKth-algorithm"><a href="#Solution-2-findKth-algorithm" class="headerlink" title="Solution 2 findKth algorithm"></a>Solution 2 findKth algorithm</h3><ol>
<li>partition</li>
<li>return A[1:k]</li>
</ol>
<p>Time: $ O(n) $</p>
<h3 id="Solution-3-Min-Heap"><a href="#Solution-3-Min-Heap" class="headerlink" title="Solution 3 Min Heap"></a>Solution 3 Min Heap</h3><ol>
<li>make a min heap</li>
<li>delete k times</li>
</ol>
<p>Time: $O(n + klogn)$ (depends on which one’s bigger)</p>
<h3 id="Solution-4-Max-Heap"><a href="#Solution-4-Max-Heap" class="headerlink" title="Solution 4 Max Heap"></a>Solution 4 Max Heap</h3><ol>
<li>m make a max heap A[1:k]</li>
<li></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i = k+<span class="number">1</span>, ... , n)</span><br><span class="line">    <span class="keyword">if</span>(A[i] &lt; getMax()) &#123;</span><br><span class="line">        deleteMax();</span><br><span class="line">        insert(A[i]);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Time: $ O(k + (n-k)*logk)$<br>When n is large, $ O(nlogk) $<br>When k is large, $ O(k) $</p>
<h2 id="Big-Integer-Multiplication"><a href="#Big-Integer-Multiplication" class="headerlink" title="Big Integer Multiplication"></a>Big Integer Multiplication</h2><p>for integers of 32-bit(unsigned), we have a range of $ (0, 2^{32}-1) $, which are 10 digits</p>
<p>for integers of 64-bit(unsigned), we have a range of $ (0, 2^{64}-1) $, which are 10 digits</p>
<h3 id="RSA"><a href="#RSA" class="headerlink" title="RSA"></a>RSA</h3><p>An encryption algorithm using large integer multiplication.</p>
<h3 id="Idea-2"><a href="#Idea-2" class="headerlink" title="Idea"></a>Idea</h3><p>Input: 2 integers of n-bits<br>Example:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    1110 = 14</span><br><span class="line">*   0101 =  5</span><br><span class="line"> 1000110 = 70</span><br></pre></td></tr></table></figure></p>
<p>Time : $ O(n^2) $</p>
<h3 id="Divide-and-Conquer"><a href="#Divide-and-Conquer" class="headerlink" title="Divide and Conquer"></a>Divide and Conquer</h3><p>a can be split to | a1 | a2|</p>
<p>for example,<br>a = 1110 = $ 11 * 2^2 + 10 $ (Shift left by 2 bit)</p>
<p>Therefore,<br>$ a = a_1<em>2^{n/2} + a_2 $<br>$ b = b_1</em>2^{n/2} + b_2 $<br>$ a <em> b = a_1b_1</em>2^{n} + (a_1b_2+a_2b_1)2^{n/2} + a_2b_2 $</p>
<p>We divide the 1 problem to 4 child problem.</p>
<p><code>T(n) = 4T(n/2) + n(sum 2 n-bit integers) = O(n^2)</code></p>
<h3 id="Improve-the-running-time"><a href="#Improve-the-running-time" class="headerlink" title="Improve the running time"></a>Improve the running time</h3><p>$ p_1 = a_1b_1$<br>$ p_2 = a_2b_2$<br>$ p_3 = (a_1+a_2)(b_1+b_2)$<br>$ a <em> b = p_1</em>2^{n} + (p_3-p_1-p_2)2^{n/2} + p_2 $</p>
<p>We can save the Time to </p>
<p><code>T(n) = 3T(n/2) + n</code><br>$ T(n) = O(n^{log_2{3}}) $</p>
<h3 id="Extra-cases"><a href="#Extra-cases" class="headerlink" title="Extra cases"></a>Extra cases</h3><p>What if 2 integers are not with the same digits?<br>Pad the 0’s to the nearest exponential of 2.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">For example</span><br><span class="line">110 -&gt; 0110</span><br><span class="line">10010 -&gt; 00010010</span><br></pre></td></tr></table></figure>
<h2 id="Square-Matrix-Multiplication"><a href="#Square-Matrix-Multiplication" class="headerlink" title="Square Matrix Multiplication"></a>Square Matrix Multiplication</h2><h3 id="Idea-3"><a href="#Idea-3" class="headerlink" title="Idea"></a>Idea</h3><p>input: 2 n*n matrices</p>
<p>$<br> X = \left[<br> \begin{matrix}<br>   1 &amp; 1 \<br>   1 &amp; 0<br>  \end{matrix}<br>  \right]_{n*n}<br>$</p>
<p>$Y = \left[<br> \begin{matrix}<br>   1 &amp; 1 \<br>   1 &amp; 0<br>  \end{matrix}<br>  \right]_{n*n}<br>$</p>
<p>$ X*Y = O(n^3) $</p>
<p>Here we use the block of matrix to Divide &amp; Conquer</p>
<p>$<br> X = \left[<br> \begin{matrix}<br>   1 &amp; 1 \<br>   1 &amp; 0<br>  \end{matrix}<br>  \right]_{n*n} = \left[<br> \begin{matrix}<br>   A &amp; B \<br>   C &amp; D<br>  \end{matrix}<br>  \right]<br>$</p>
<p>$Y = \left[<br> \begin{matrix}<br>   1 &amp; 1 \<br>   1 &amp; 0<br>  \end{matrix}<br>  \right]_{n*n} = \left[<br> \begin{matrix}<br>   E &amp; F \<br>   G &amp; H<br>  \end{matrix}<br>  \right]<br>$</p>
<p>$ X<em>Y = \left[<br> \begin{matrix}<br>   {AE+BG} &amp; {AF+BH} \<br>   {CE+DG} &amp; {CF+DH}<br>  \end{matrix}<br>  \right]_{n</em>n}<br>$</p>
<p>Therefore, $ T(n) = 8T(\frac{n}{2}) + n^2 = O(n^3)$</p>
<h3 id="Optimization"><a href="#Optimization" class="headerlink" title="Optimization"></a>Optimization</h3><p>$ X<em>Y = \left[<br> \begin{matrix}<br>   {AE+BG} &amp; {AF+BH} \<br>   {CE+DG} &amp; {CF+DH}<br>  \end{matrix}<br>  \right]_{n</em>n} = \left[<br> \begin{matrix}<br>   {Q} &amp; {R} \<br>   {S} &amp; {T}<br>  \end{matrix}<br>  \right]<br>$</p>
<p>$Assume:$<br>$P_1 = A(F-H)$<br>$P_2 = H(A+B)$<br>$P_3 = E(C+D)$<br>$P_4 = D(G-E)$<br>$P_5 = (A+D)(E+H)$<br>$P_6 = (B-D)(G+H)$<br>$P_7 = (A-C)(E+F)$<br>$Q = P_4 + P_5 - P_2 + P_6$<br>$R = P_1 + P_2$<br>$S = P_3 + P_4$<br>$T = P_1 + P_5 - P_3 - P_7$</p>
<p>$ X*Y = \left[<br> \begin{matrix}<br>   {AE+BG} &amp; {AF+BH} \<br>   {CE+DG} &amp; {CF+DH}<br>  \end{matrix}<br>  \right] = \left[<br> \begin{matrix}<br>   {P_4 + P_5 - P_2 + P_6} &amp; {P_1 + P_2} \<br>   {P_3 + P_4} &amp; {P_1 + P_5 - P_3 - P_7}<br>  \end{matrix}<br>  \right]<br>$</p>
<p>Therefore, $ T(n) = 7T(\frac{n}{2}) + n^2 = O(n^3)$, Successfully optimized.</p>
<h2 id="Counting-Inversions"><a href="#Counting-Inversions" class="headerlink" title="Counting Inversions"></a>Counting Inversions</h2><h3 id="Idea-4"><a href="#Idea-4" class="headerlink" title="Idea"></a>Idea</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Inversion: if i &lt; j &amp;&amp; A[i] &gt; A[j], then (i, j) is an inversion.</span><br><span class="line"></span><br><span class="line">If my favorite list is [1, 2, 3], num of inversion is 0</span><br><span class="line">If list is [2, 1, 3], num of inversion is 1</span><br><span class="line">If list is [2, 3, 1], num of inversion is 2</span><br><span class="line">If list is [3, 2, 1], num of inversion is 3, we have a completely different taste</span><br></pre></td></tr></table></figure>
<p>Max num of inversions of a n list is $ C^{2}_{n} = O(n^2) $</p>
<h3 id="Code-5"><a href="#Code-5" class="headerlink" title="Code"></a>Code</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Brute force</span></span><br><span class="line"><span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;=n; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j = i+<span class="number">1</span>; j &lt;=n; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (A[i] &gt; A[j]) &#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Better-Implementation"><a href="#Better-Implementation" class="headerlink" title="Better Implementation"></a>Better Implementation</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">        1         n/2 n/2+1       n</span><br><span class="line">A       |      x     |       y    |</span><br><span class="line"></span><br><span class="line">num of cross inversions + x + y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        begin        mid mid+1      end</span><br><span class="line">A       |     1  3  5   |  0  2  6   |</span><br><span class="line">              p            q</span><br><span class="line"></span><br><span class="line">given A[p] = 1, A[q] = 0, A[p] &gt; A[q], we have inv += 3, q++</span><br><span class="line">A[p] &lt; A[q], p++</span><br><span class="line">A[q] &lt; A[p], inv += 2, q++</span><br><span class="line">A[p] &lt; A[q], p++</span><br><span class="line">A[p] &lt; A[q], p++, end</span><br></pre></td></tr></table></figure>
<h3 id="Code-6"><a href="#Code-6" class="headerlink" title="Code"></a>Code</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">CountInv</span><span class="params">(<span class="keyword">int</span>[] A, <span class="keyword">int</span> begin, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (begin &gt;= end) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> mid = (mid + end) / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> x = CountInv(A, begin, mid);</span><br><span class="line">    <span class="keyword">int</span> y = CountInv(A, mid+<span class="number">1</span>, end);</span><br><span class="line">    <span class="keyword">int</span> z = CrossInv(A, begin, mid, end);</span><br><span class="line">    <span class="keyword">return</span> x + y + z;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// o nlogn time</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">CrossInv</span><span class="params">(<span class="keyword">int</span>[] A, <span class="keyword">int</span> begin, <span class="keyword">int</span> mid, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">    sort(A, begin, mid);</span><br><span class="line">    sort(A, mid+<span class="number">1</span>, end);</span><br><span class="line">    <span class="keyword">int</span> p = begin, q = mid + <span class="number">1</span>, count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (p &lt;= mid &amp;&amp; q &lt;= end) &#123;</span><br><span class="line">        <span class="keyword">if</span> (A[p] &lt; A[q]) p++;</span><br><span class="line">        <span class="keyword">else</span> count += mid - p+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Analysis-3"><a href="#Analysis-3" class="headerlink" title="Analysis"></a>Analysis</h3><p>$ T(n) = 2T(\frac{n}{2}) + nlogn /= O(nlognlogn)$</p>
<h3 id="Optimization-1"><a href="#Optimization-1" class="headerlink" title="Optimization"></a>Optimization</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">CountInv</span><span class="params">(<span class="keyword">int</span>[] A, <span class="keyword">int</span> begin, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (begin &gt;= end) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> mid = (mid + end) / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> x = CountInv(A, begin, mid); <span class="comment">// sort the left</span></span><br><span class="line">    <span class="keyword">int</span> y = CountInv(A, mid+<span class="number">1</span>, end); <span class="comment">// sort the right</span></span><br><span class="line">    <span class="keyword">int</span> z = CrossInv(A, begin, mid, end); <span class="comment">// count the cross</span></span><br><span class="line">    <span class="comment">//merge left and right </span></span><br><span class="line">    merge(A, begin, mid, end);</span><br><span class="line">    <span class="keyword">return</span> x + y + z;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// on time</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">CrossInv</span><span class="params">(<span class="keyword">int</span>[] A, <span class="keyword">int</span> begin, <span class="keyword">int</span> mid, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> p = begin, q = mid + <span class="number">1</span>, count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (p &lt;= mid &amp;&amp; q &lt;= end) &#123;</span><br><span class="line">        <span class="keyword">if</span> (A[p] &lt; A[q]) p++;</span><br><span class="line">        <span class="keyword">else</span> count += mid - p+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>$ T(n) = 2T(\frac{n}{2}) + n = O(nlogn)$</p>
<h3 id="Example-1"><a href="#Example-1" class="headerlink" title="Example"></a>Example</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">        | 7 | 2 | 3 | 4 | 1 | 6 | 5 | 8 |</span><br><span class="line">        | 2 | 3 | 4 | 7 | 1 | 6 | 5 | 8 |</span><br><span class="line">                    /    \ </span><br><span class="line">           3                    </span><br><span class="line">  | 2 | 7 | 3 | 4 |         | 1 | 6 | 5 | 8 |</span><br><span class="line"></span><br><span class="line">    /       \                   /       \</span><br><span class="line">   1         0                 </span><br><span class="line">| 7 | 2 |  | 3 | 4 |        | 1 | 6 |   | 5 | 8 |</span><br></pre></td></tr></table></figure>
<h1 id="Class-4-06-03-2019"><a href="#Class-4-06-03-2019" class="headerlink" title="Class 4 06/03/2019"></a>Class 4 06/03/2019</h1><h2 id="Binary-Search-Tree-and-Hashtable"><a href="#Binary-Search-Tree-and-Hashtable" class="headerlink" title="Binary Search Tree and Hashtable"></a>Binary Search Tree and Hashtable</h2><h3 id="Difference-between-two-data-structures"><a href="#Difference-between-two-data-structures" class="headerlink" title="Difference between two data structures"></a>Difference between two data structures</h3><table>
<thead>
<tr>
<th style="text-align:center">Hashing</th>
<th style="text-align:center">BST</th>
<th style="text-align:center"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">O(1)</td>
<td style="text-align:center">h</td>
<td style="text-align:center">insert(key,value)</td>
</tr>
<tr>
<td style="text-align:center">O(1)</td>
<td style="text-align:center">h</td>
<td style="text-align:center">lookup(key)</td>
</tr>
<tr>
<td style="text-align:center">O(1)</td>
<td style="text-align:center">h</td>
<td style="text-align:center">delete(key)</td>
</tr>
<tr>
<td style="text-align:center">amartized running time</td>
<td style="text-align:center">O(logn) basically</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">support traversing by ordered keys</td>
</tr>
</tbody>
</table>
<h2 id="Binary-Search-Tree"><a href="#Binary-Search-Tree" class="headerlink" title="Binary Search Tree"></a>Binary Search Tree</h2><h3 id="Definition"><a href="#Definition" class="headerlink" title="Definition"></a>Definition</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> key;</span><br><span class="line">    Node left;</span><br><span class="line">    Node right;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">     5</span><br><span class="line">   /   \</span><br><span class="line">  3     8</span><br><span class="line">   \</span><br><span class="line">    4</span><br><span class="line">This is a BST</span><br><span class="line"></span><br><span class="line">     5</span><br><span class="line">   /   \</span><br><span class="line">  3     8</span><br><span class="line">   \</span><br><span class="line">    6</span><br><span class="line">This is not a BST</span><br></pre></td></tr></table></figure>
<ol>
<li>Left subtree is BST</li>
<li>Right subtree is BST</li>
<li>root.key &gt; all keys in left subtree<br>and root.key &lt; all keys in right subtree</li>
</ol>
<h3 id="Tree-Traversals"><a href="#Tree-Traversals" class="headerlink" title="Tree Traversals"></a>Tree Traversals</h3><ol>
<li>Level-order </li>
<li>Pre-order </li>
<li>Post-order </li>
<li>In-order </li>
</ol>
<h4 id="Level-order-Traversal"><a href="#Level-order-Traversal" class="headerlink" title="Level-order Traversal"></a>Level-order Traversal</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">LevelOrder</span><span class="params">(Node root)</span> </span>&#123;</span><br><span class="line">    Queue&lt;Node&gt; q = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">    q.offer(root);</span><br><span class="line">    <span class="keyword">while</span> (!q.isEmpty()) &#123;</span><br><span class="line">        Node cur = q.poll();</span><br><span class="line">        <span class="comment">// processing on cur; print cur.key;</span></span><br><span class="line">        <span class="keyword">if</span> (cur.left != <span class="keyword">null</span>) q.offer(cur.left);</span><br><span class="line">        <span class="keyword">if</span> (cur.right != <span class="keyword">null</span>) q.offer(cur.right);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Right-Side-View-Question"><a href="#Right-Side-View-Question" class="headerlink" title="Right Side View Question"></a>Right Side View Question</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">     5</span><br><span class="line">   /   \</span><br><span class="line">  3     8</span><br><span class="line">   \</span><br><span class="line">    4</span><br><span class="line">we get the right side view as [5, 8, 4]</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// we can just modify the original code by</span></span><br><span class="line">cur, curLevel = q.dequeue();</span><br><span class="line">res[cur_level] = cur.key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="comment">// level order traversal </span></span><br><span class="line">    <span class="comment">// on time on space</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title">rightSideView</span><span class="params">(TreeNode root)</span> </span>&#123;</span><br><span class="line">        List&lt;Integer&gt; res = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="keyword">null</span>) <span class="keyword">return</span> res;</span><br><span class="line">        LinkedList&lt;TreeNode&gt; queue = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        queue.offerLast(root);</span><br><span class="line">        <span class="keyword">int</span> size = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">int</span> temp=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                TreeNode cur = queue.pollFirst();</span><br><span class="line">                <span class="keyword">if</span> (cur.left != <span class="keyword">null</span>) queue.offerLast(cur.left);</span><br><span class="line">                <span class="keyword">if</span> (cur.right != <span class="keyword">null</span>) queue.offerLast(cur.right);</span><br><span class="line">                temp = cur.val;</span><br><span class="line">            &#125;</span><br><span class="line">            res.add(temp);</span><br><span class="line">            size = queue.size();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Pre-order-Traversal"><a href="#Pre-order-Traversal" class="headerlink" title="Pre-order Traversal"></a>Pre-order Traversal</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PreOrder</span><span class="params">(Node cur)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (cur == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    Process(cur);</span><br><span class="line">    PreOrder(cur.left);</span><br><span class="line">    PreOrder(cur.right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="In-order-Traversal"><a href="#In-order-Traversal" class="headerlink" title="In-order Traversal"></a>In-order Traversal</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">     5</span><br><span class="line">   /   \</span><br><span class="line">  3     8</span><br><span class="line">   \</span><br><span class="line">    4</span><br><span class="line">we get the inorder node list as [3, 4, 5, 8], which is  sorted.</span><br></pre></td></tr></table></figure>
<h3 id="Represent-duplicate-keys-in-BST"><a href="#Represent-duplicate-keys-in-BST" class="headerlink" title="Represent duplicate keys in BST"></a>Represent duplicate keys in BST</h3><h4 id="Requirement"><a href="#Requirement" class="headerlink" title="Requirement"></a>Requirement</h4><p>Has to support root &gt;= all left and root &lt; all right.</p>
<ol>
<li>MultiSet</li>
<li>MultiMap</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">       5</span><br><span class="line">     /   \</span><br><span class="line">    5     8</span><br><span class="line">  /</span><br><span class="line">  3     </span><br><span class="line">   \</span><br><span class="line">    4</span><br><span class="line">```    </span><br><span class="line"></span><br><span class="line">### Implementation</span><br><span class="line">#### Lookup</span><br><span class="line">```java</span><br><span class="line">boolean Lookup(Node cur, int key) &#123;</span><br><span class="line">    if (cur == null) return false;</span><br><span class="line">    if (cur.key == key) return true;</span><br><span class="line">    if (cur.key &lt; key) return Lookup(cur.right, key);</span><br><span class="line">    return Lookup(cur.left, key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Insert"><a href="#Insert" class="headerlink" title="Insert"></a>Insert</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Node <span class="title">insert</span><span class="params">(Node cur, <span class="keyword">int</span> key, String val)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (cur == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">new</span> Node(key, val);</span><br><span class="line">    <span class="keyword">if</span> (key == cur.key) cur.val = val;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (key &lt; cur.key) &#123;</span><br><span class="line">        cur.left = insert(cur.left, key, val);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cur.right = insert(cur.right, key, val);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cur;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h4><pre><code>          5
        /   \
       3     6
     /  \
    2    4

Delete 5(2 children)

          4
        /   \
       3     6
     /  
    2    
</code></pre><p><strong>Case 1: No children</strong><br>update parent’s reference</p>
<p><strong>Case 2: Single child</strong><br>Parent pointing to child</p>
<p><strong>Case 2: two children</strong></p>
<ol>
<li>find predecessor p</li>
<li>swap</li>
<li>delete recursively</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/03/Google Bigtable/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yanpeng Luo">
      <meta itemprop="description" content="Notes of study, work and life">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yanpeng">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/05/03/Google Bigtable/" class="post-title-link" itemprop="url">Google Bigtable</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-05-03 18:07:50 / Modified: 11:08:54" itemprop="dateCreated datePublished" datetime="2019-05-03T18:07:50-07:00">2019-05-03</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">6.2k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">6 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Please comment one line (fmt.Fprintf(w, “Search received: %s %s %s”, lat, lon, ran)) as IOS does not like to get string. Make sure the response of \post is empty</p>
<h1 id="Bigtable"><a href="#Bigtable" class="headerlink" title="Bigtable"></a>Bigtable</h1><p><code>BigTable</code> is one of the first <code>NoSQL</code> solutions in the world. It’s the same database that powers many core Google services, including Search, Analytics, Maps, and Gmail. </p>
<p><code>Apache HBase</code> is the open source version of BigTable.</p>
<p>By definition, A <code>Bigtable</code> is a <code>sparse</code>, <code>distributed</code>, <code>persistent multidimensional sorted map</code>. (In my word, it’s a key­value store.) The map is indexed by a row key, column key, and a timestamp; each value in the map is an uninterpreted array of bytes.</p>
<h2 id="Main-features-that-you-must-know-about-BigTable"><a href="#Main-features-that-you-must-know-about-BigTable" class="headerlink" title="Main features that you must know about BigTable"></a>Main features that you must know about BigTable</h2><ul>
<li>Map</li>
<li>Persistent: BigTable vs. Memcache</li>
<li>Distributed (GFS/HDFS, etc.): data is replicated across a number of participating nodes vs. MySQL</li>
<li>Multidimensional: row, column (column family), timestamp. You may scan based on their ranges.</li>
<li>Sparse: A given row can have any number of columns in each column family, or none at<br>all. The other type of sparseness is row­based gaps, which merely means that there may be gaps between keys.</li>
</ul>
<h2 id="BigTable-vs-ElasticSearch-vs-Datastore-vs…"><a href="#BigTable-vs-ElasticSearch-vs-Datastore-vs…" class="headerlink" title="BigTable vs. ElasticSearch vs. Datastore vs…."></a>BigTable vs. ElasticSearch vs. Datastore vs….</h2><ul>
<li>BigTable is persistent storage (ES is not persistent, may lose data)</li>
<li>ElasticSearch is search engine with complicated query support and better read<br>performance</li>
<li>BigQuery is for offline analysis not for serving user traffic (scale is small)</li>
<li>MongoDB is NoSQL.</li>
<li>BigTable vs. ElasticSearch vs. MongoDB vs. BigQuery vs. Dataflow<ul>
<li>BigTable = NoSQL + Cloud</li>
<li>MongoDB = NoSQL</li>
<li>ElasticSearch = NoSQL + Query Optimization</li>
<li>BigQuery = MySQL­like + Cloud</li>
<li>Dataflow = MapReduce + Cloud</li>
</ul>
</li>
</ul>
<p>Interview question:</p>
<p>Why you need BigTable (or BigQuery) while you already have ElasticSearch (BigTable/BigQuery)</p>
<p>More readings</p>
<ul>
<li><a href="http://chouqin.github.io/blog/2013/10/24/bigtable/" target="_blank" rel="noopener">http://chouqin.github.io/blog/2013/10/24/bigtable/</a></li>
<li><a href="http://blog.csdn.net/opennaive/article/details/7532589" target="_blank" rel="noopener">http://blog.csdn.net/opennaive/article/details/7532589</a></li>
<li><a href="https://www.quora.com/What­problems­did­Spanner­solve­that­BigTable­fall­short­of" target="_blank" rel="noopener">https://www.quora.com/What­problems­did­Spanner­solve­that­BigTable­fall­short­of</a></li>
</ul>
<p>Bigtable has a concept of <code>column family</code> and <code>column</code>. <code>Column family</code> is a set of columns.</p>
<p>Question: Why column family?<br>Answer: allow better management of data such as versioning strategy.</p>
<p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/6.%20Bigtable-2019-5-3-10-50-24.png" alt="6. Bigtable-2019-5-3-10-50-24.png"></p>
<h2 id="Create-BigTable-in-Google-Cloud"><a href="#Create-BigTable-in-Google-Cloud" class="headerlink" title="Create BigTable in Google Cloud"></a>Create BigTable in Google Cloud</h2><p>Click this link <a href="https://cloud.google.com/bigtable/docs/quickstart­cbt" target="_blank" rel="noopener">https://cloud.google.com/bigtable/docs/quickstart­cbt</a> and then click ‘<code>ENABLE THE APIS</code>’</p>
<h3 id="To-Enable-an-API"><a href="#To-Enable-an-API" class="headerlink" title="To Enable an API."></a>To Enable an API.</h3><h3 id="Open-‘BigTable’-in-Google-Cloud"><a href="#Open-‘BigTable’-in-Google-Cloud" class="headerlink" title="Open ‘BigTable’ in Google Cloud,"></a>Open ‘BigTable’ in Google Cloud,</h3><h3 id="Create-an-instance-called-‘around­post’-Change-instance-type-to-development"><a href="#Create-an-instance-called-‘around­post’-Change-instance-type-to-development" class="headerlink" title="Create an instance called ‘around­post’. Change instance type to development."></a>Create an instance called ‘around­post’. Change instance type to development.</h3><p>Set the type to ssd and instance type to development</p>
<h3 id="Enter-gcloud-in-your-terminal"><a href="#Enter-gcloud-in-your-terminal" class="headerlink" title="Enter gcloud in your terminal"></a>Enter gcloud in your terminal</h3><p>Install cbt in your cloud terminal (not your local terminal). When asked ‘Do you want to continue?’ Enter y. Proceed without waiting it to finish.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo gcloud components update sudo gcloud components install cbt</span><br><span class="line">```     </span><br><span class="line"></span><br><span class="line">To ensure cbt is installed, enter `which cbt` in your cloud terminal If you don’t see it, you cbt is not installed, please do the install again.</span><br></pre></td></tr></table></figure>
<p>/google/google-cloud-sdk/bin/cbt<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">In your cloud terminal, enter</span><br></pre></td></tr></table></figure></p>
<p>echo project = YOUR_PROJECT_ID &gt; ~/.cbtrc echo instance = around­post &gt;&gt; ~/.cbtrc<br>cbt createtable post<br>cbt createfamily post post<br>cbt createfamily post location<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">If you see such results, the bigtable column and column family are both created (This step is a MUST for next lessons). Please check it carefully.</span><br><span class="line"></span><br><span class="line">![6. Bigtable-2019-5-3-10-58-1.png](https://raw.githubusercontent.com/YanpengQi/images/master/6.%20Bigtable-2019-5-3-10-58-1.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## Write data into BigTable</span><br><span class="line">### Open your local terminal and cloud terminal, enter</span><br></pre></td></tr></table></figure></p>
<p>go get cloud.google.com/go/bigtable<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Instructions on writing data to BigTable</span><br><span class="line">+ https://cloud.google.com/bigtable/docs/go/reference</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### Update your code in handlerPost and saveToBigTable. Replace project name with your project.</span><br><span class="line">```Go</span><br><span class="line">func saveToBigTable(p *Post, id string) &#123;</span><br><span class="line">	ctx := context.Background()</span><br><span class="line">	// you must update project name here</span><br><span class="line">	bt_client, err := bigtable.NewClient(ctx, PROJECT_ID, BT_INSTANCE)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		panic(err)</span><br><span class="line">		return</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	tbl := bt_client.Open(&quot;post&quot;)</span><br><span class="line">	mut := bigtable.NewMutation()</span><br><span class="line">	t := bigtable.Now()</span><br><span class="line">	</span><br><span class="line">	mut.Set(&quot;post&quot;, &quot;user&quot;, t, []byte(p.User))</span><br><span class="line">	mut.Set(&quot;post&quot;, &quot;message&quot;, t, []byte(p.Message))</span><br><span class="line">	mut.Set(&quot;location&quot;, &quot;lat&quot;, t, []byte(strconv.FormatFloat(p.Location.Lat, &apos;f&apos;, -1, 64)))</span><br><span class="line">	mut.Set(&quot;location&quot;, &quot;lon&quot;, t, []byte(strconv.FormatFloat(p.Location.Lon, &apos;f&apos;, -1, 64)))</span><br><span class="line"></span><br><span class="line">	err = tbl.Apply(ctx, id, mut)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		panic(err)</span><br><span class="line">		return</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(&quot;Post is saved to Big Table : %s\n&quot;, p.Message)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Based on what Google suggest, how to save our Post into BT?<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tbl := client.Open(<span class="string">"mytable"</span>)</span><br><span class="line">mut := bigtable.NewMutation()</span><br><span class="line"></span><br><span class="line">mut.Set(<span class="string">"links"</span>, <span class="string">"maps.google.com"</span>, bigtable.Now(), []<span class="keyword">byte</span>(<span class="string">"1"</span>)) </span><br><span class="line"></span><br><span class="line">mut.Set(<span class="string">"links"</span>, <span class="string">"golang.org"</span>, bigtable.Now(), []<span class="keyword">byte</span>(<span class="string">"1"</span>))</span><br><span class="line"></span><br><span class="line">err := tbl.Apply(ctx, <span class="string">"com.google.cloud"</span>, mut)</span><br></pre></td></tr></table></figure></p>
<p>Uncomment the two lines in const and replace the <code>PROJECT_ID</code> with your own project id.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">INDEX = <span class="string">"around"</span></span><br><span class="line">TYPE = <span class="string">"post"</span></span><br><span class="line">DISTANCE = <span class="string">"200km"</span></span><br><span class="line"><span class="comment">// Needs to update with your real project id PROJECT_ID = "xxxx"</span></span><br><span class="line">BT_INSTANCE = <span class="string">"around­post"</span></span><br><span class="line"><span class="comment">// Needs to update this URL if you deploy it to cloud. ES_URL = "http://AWS_ADDRESS:9200"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>Add two imports</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">elastic <span class="string">"gopkg.in/olivere/elastic.v3"</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line"><span class="string">"encoding/json"</span></span><br><span class="line"><span class="string">"log"</span></span><br><span class="line"><span class="string">"strconv"</span></span><br><span class="line"><span class="string">"reflect"</span></span><br><span class="line"><span class="string">"context"</span> <span class="string">"cloud.google.com/go/bigtable"</span> <span class="string">"github.com/pborman/uuid"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>Try to build it locally to see if there are any errors.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go build *.go</span><br></pre></td></tr></table></figure>
<h3 id="Update-your-codes-in-cloud-terminal-Either-copy-or-github-Offer-share"><a href="#Update-your-codes-in-cloud-terminal-Either-copy-or-github-Offer-share" class="headerlink" title="Update your codes in cloud terminal (Either copy or github) Offer share"></a>Update your codes in cloud terminal (Either copy or github) Offer share</h3><h3 id="After-you-copy-or-update-codes-into-cloud-terminal-do-a-deployment-again"><a href="#After-you-copy-or-update-codes-into-cloud-terminal-do-a-deployment-again" class="headerlink" title="After you copy or update codes into cloud terminal, do a deployment again."></a>After you copy or update codes into cloud terminal, do a deployment again.</h3><h3 id="Open-Postman-test-post-and-search"><a href="#Open-Postman-test-post-and-search" class="headerlink" title="Open Postman, test post and search"></a>Open Postman, test post and search</h3><h3 id="Read-data-from-BigTable"><a href="#Read-data-from-BigTable" class="headerlink" title="Read data from BigTable"></a>Read data from BigTable</h3><h3 id="In-the-cloud-terminal-enter"><a href="#In-the-cloud-terminal-enter" class="headerlink" title="In the cloud terminal, enter"></a>In the cloud terminal, enter</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cbt read post</span><br></pre></td></tr></table></figure>
<p>You should be able to find all the entries stored in BT.</p>
<h3 id="How-to-debug-Check-Logging­-gt-logs"><a href="#How-to-debug-Check-Logging­-gt-logs" class="headerlink" title="How to debug? Check Logging­&gt;logs."></a>How to debug? Check Logging­&gt;logs.</h3><p>Note that: if you close your cloud terminal, you may or may not need to install cbt again as cloud terminal is actually a vm.</p>
<h1 id="Things-you-need-to-know"><a href="#Things-you-need-to-know" class="headerlink" title="Things you need to know"></a>Things you need to know</h1><ol>
<li>setup bigtable</li>
<li>BigTable vs. ElasticSearch vs. MongoDB vs. BigQuery vs. Dataflow<ul>
<li>BigTable = NoSQL + Cloud</li>
<li>MongoDB = NoSQL</li>
<li>ElasticSearch = NoSQL + Query Optimization</li>
<li>BigQuery = MySQL + Cloud</li>
<li>Dataflow = MapReduce + Cloud</li>
</ul>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/6.%20Bigtable-2019-5-3-11-6-46.png" alt="6. Bigtable-2019-5-3-11-6-46.png"></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/02/Authentication/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yanpeng Luo">
      <meta itemprop="description" content="Notes of study, work and life">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yanpeng">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/05/02/Authentication/" class="post-title-link" itemprop="url">Authentication</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-05-02 00:22:08" itemprop="dateCreated datePublished" datetime="2019-05-02T00:22:08-07:00">2019-05-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-05-01 17:30:44" itemprop="dateModified" datetime="2019-05-01T17:30:44-07:00">2019-05-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">15k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">13 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Credential-based-Authentication"><a href="#Credential-based-Authentication" class="headerlink" title="Credential based Authentication"></a>Credential based Authentication</h1><p>Login each time when you need to operate something</p>
<h1 id="Cookie-Based-Authentication"><a href="#Cookie-Based-Authentication" class="headerlink" title="Cookie Based Authentication"></a>Cookie Based Authentication</h1><ul>
<li>The traditional approach of authentication</li>
<li>Stateful. This means that an authentication record or session must be kept both server and client-side. The server needs to keep track of active sessions in a database (memory/local store), while on the front-end a cookie is created that holds a session identifier, thus the name cookie based authentication. </li>
</ul>
<p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/5.%20Authentication-2019-5-1-17-29-44.png" alt="5. Authentication-2019-5-1-17-29-44.png"></p>
<ol>
<li>User enters their login credentials</li>
<li>Server verifies the credentials are correct and creates a session which is then stored in a database</li>
<li>A cookie with the session ID is placed in the users browser</li>
<li>On subsequent requests, the session ID is verified against the database and if valid the request processed</li>
<li>Once a user logs out of the app, the session is destroyed both client and server side</li>
</ol>
<p>Question: what’s the problem of this method?</p>
<p>Imagine when you need to replace your ID?</p>
<ol>
<li>Go to government, apply for a temporary ID.</li>
<li>It may take them 1 months to send you a new ID.</li>
<li>During this period, you may use your temporary ID for some purposes. </li>
</ol>
<h1 id="Token-Based-Authentication"><a href="#Token-Based-Authentication" class="headerlink" title="Token-Based Authentication"></a>Token-Based Authentication</h1><ul>
<li>More and more popular (Yelp API, etc.)</li>
<li>Usually JSON Web Tokens (JWTs).</li>
</ul>
<h2 id="How-it-works"><a href="#How-it-works" class="headerlink" title="How it works"></a>How it works</h2><ul>
<li>User enters their login credentials (=username + password)</li>
<li>Server verifies the credentials are correct and returns an encrypted and signed token with a private key. <ul>
<li>Text: (JSON = {username: “abcd”, uuid=”1.2.3.4”}, private key) =&gt; token</li>
<li>Code: abccdeedddee</li>
<li>Decode: JSON = {username: “abcd”,  uuid=”1.2.3.4”}</li>
<li>Symmetric vs Asymmetric encryption.</li>
<li>This token is stored client-side, most commonly in local storage - but can be stored in session storage or a cookie as well</li>
</ul>
</li>
<li>Subsequent requests to the server include this token as an additional Authorization header or through one of the other methods mentioned above</li>
<li>The server decodes the JWT and if the token is valid processes the request</li>
<li>Once a user logs out, the token is destroyed client-side, no interaction with the server is necessary</li>
</ul>
<p>Encryption using asymmetric keys.</p>
<p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/5.%20Authentication-2019-5-1-17-30-10.png" alt="5. Authentication-2019-5-1-17-30-10.png"></p>
<p>Sign using asymmetric keys:</p>
<p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/5.%20Authentication-2019-5-1-17-30-17.png" alt="5. Authentication-2019-5-1-17-30-17.png"></p>
<p>More reading (symmetric vs asymmetric encryption):<br><a href="https://www.ssl2buy.com/wiki/symmetric-vs-asymmetric-encryption-what-are-differences" target="_blank" rel="noopener">https://www.ssl2buy.com/wiki/symmetric-vs-asymmetric-encryption-what-are-differences</a></p>
<h2 id="Advantages-of-Token-Based-Authentication"><a href="#Advantages-of-Token-Based-Authentication" class="headerlink" title="Advantages of Token-Based Authentication"></a>Advantages of Token-Based Authentication</h2><h3 id="Stateless-Scalable-and-Decoupled"><a href="#Stateless-Scalable-and-Decoupled" class="headerlink" title="Stateless, Scalable and Decoupled"></a>Stateless, Scalable and Decoupled</h3><ul>
<li>Stateless: The back-end does not need to keep a record of tokens. </li>
<li>Self-contained, containing all the data required to check its validity..</li>
<li>No DB look up is needed. </li>
</ul>
<h3 id="Store-Data-in-the-JWT"><a href="#Store-Data-in-the-JWT" class="headerlink" title="Store Data in the JWT"></a>Store Data in the JWT</h3><ul>
<li>With a cookie based approach, you simply store the session id in a cookie. </li>
<li>JWT’s on the other hand allow you to store any type of metadata, as long as it’s valid JSON. (username in our project, for example)</li>
</ul>
<h3 id="Mobile-Friendly"><a href="#Mobile-Friendly" class="headerlink" title="Mobile Friendly"></a>Mobile Friendly</h3><ul>
<li>Native mobile platforms and cookies do not mix well. </li>
<li>In our project, the same Go backend will serve traffic to both iOS and browser (React JS)<h2 id="Disadvantages-of-Token-Based-Authentication"><a href="#Disadvantages-of-Token-Based-Authentication" class="headerlink" title="Disadvantages of Token-Based Authentication"></a>Disadvantages of Token-Based Authentication</h2></li>
<li>Usually the size of token is larger than a session id.</li>
</ul>
<h1 id="Auth0-and-Golang"><a href="#Auth0-and-Golang" class="headerlink" title="Auth0 and Golang"></a>Auth0 and Golang</h1><p>Source of codes: <a href="https://auth0.com/blog/authentication-in-golang/" target="_blank" rel="noopener">https://auth0.com/blog/authentication-in-golang/</a> </p>
<p><code>JWT</code> = <code>JSON Web Toolkit</code></p>
<h3 id="use-jwt-to-protect-post-and-search-endpoints-reject-if-without-auth-token"><a href="#use-jwt-to-protect-post-and-search-endpoints-reject-if-without-auth-token" class="headerlink" title="use jwt to protect post and search endpoints (reject if without auth token)"></a>use jwt to protect post and search endpoints (reject if without auth token)</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">      <span class="comment">// new libs</span></span><br><span class="line">      <span class="string">"github.com/auth0/go-jwt-middleware"</span></span><br><span class="line">      <span class="string">"github.com/dgrijalva/jwt-go"</span></span><br><span class="line">      <span class="string">"github.com/gorilla/mux"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Other codes</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> mySigningKey = []<span class="keyword">byte</span>(<span class="string">"secret"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">      <span class="comment">// Create a client</span></span><br><span class="line">      client, err := elastic.NewClient(elastic.SetURL(ES_URL), elastic.SetSniff(<span class="literal">false</span>))</span><br><span class="line">     ….      </span><br><span class="line">      fmt.Println(<span class="string">"Started service successfully"</span>)</span><br><span class="line">      <span class="comment">// Here we are instantiating the gorilla/mux router</span></span><br><span class="line">      r := mux.NewRouter()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> jwtMiddleware = jwtmiddleware.New(jwtmiddleware.Options&#123;</span><br><span class="line">             ValidationKeyGetter: <span class="function"><span class="keyword">func</span><span class="params">(token *jwt.Token)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> mySigningKey, <span class="literal">nil</span></span><br><span class="line">             &#125;,</span><br><span class="line">             SigningMethod: jwt.SigningMethodHS256,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      r.Handle(<span class="string">"/post"</span>, jwtMiddleware.Handler(http.HandlerFunc(handlerPost))).Methods(<span class="string">"POST"</span>)</span><br><span class="line">      r.Handle(<span class="string">"/search"</span>, jwtMiddleware.Handler(http.HandlerFunc(handlerSearch))).Methods(<span class="string">"GET"</span>)</span><br><span class="line">      r.Handle(<span class="string">"/login"</span>, http.HandlerFunc(loginHandler)).Methods(<span class="string">"POST"</span>)</span><br><span class="line">      r.Handle(<span class="string">"/signup"</span>, http.HandlerFunc(signupHandler)).Methods(<span class="string">"POST"</span>)</span><br><span class="line"></span><br><span class="line">      http.Handle(<span class="string">"/"</span>, r)</span><br><span class="line">      log.Fatal(http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Let’s explain these codes line by line</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r := mux.NewRouter()</span><br></pre></td></tr></table></figure>
<p>Create a new router on top of the existing http router as we need to check auth.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> jwtMiddleware = jwtmiddleware.New(jwtmiddleware.Options&#123;</span><br><span class="line">             ValidationKeyGetter: <span class="function"><span class="keyword">func</span><span class="params">(token *jwt.Token)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> mySigningKey, <span class="literal">nil</span></span><br><span class="line">             &#125;,</span><br><span class="line">             SigningMethod: jwt.SigningMethodHS256,</span><br><span class="line">      &#125;)</span><br></pre></td></tr></table></figure>
<p>Create a new JWT middleware with a Option that uses the key ‘mySigningKey’ such that we know this token is from our server. The signing method is the default HS256 algorithm such that data is encrypted.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r.Handle(<span class="string">"/post"</span>, jwtMiddleware.Handler(http.HandlerFunc(handlerPost))).Methods(<span class="string">"POST"</span>)</span><br></pre></td></tr></table></figure>
<p>It means we use jwt middleware to manage these endpoints and if they don’t have valid token, we will reject them.</p>
<blockquote>
<p>First handle the jwt, then chandle the normal http request</p>
</blockquote>
<p>Question: if we reject it, what HttpResponse code we should return?<br><a href="https://golang.org/src/net/http/status.go" target="_blank" rel="noopener">https://golang.org/src/net/http/status.go</a></p>
<h3 id="Install-new-packages"><a href="#Install-new-packages" class="headerlink" title="Install new packages"></a>Install new packages</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">go get &quot;github.com/auth0/go-jwt-middleware&quot;</span><br><span class="line">go get &quot;github.com/dgrijalva/jwt-go&quot;</span><br><span class="line">go get &quot;github.com/gorilla/mux&quot;</span><br></pre></td></tr></table></figure>
<h3 id="Under-the-same-folder-add-a-new-file-called-user-go"><a href="#Under-the-same-folder-add-a-new-file-called-user-go" class="headerlink" title="Under the same folder, add a new file called user.go"></a>Under the same folder, add a new file called user.go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">      elastic <span class="string">"gopkg.in/olivere/elastic.v3"</span></span><br><span class="line"></span><br><span class="line">      <span class="string">"encoding/json"</span></span><br><span class="line">      <span class="string">"fmt"</span></span><br><span class="line">      <span class="string">"net/http"</span></span><br><span class="line">      <span class="string">"reflect"</span></span><br><span class="line">      <span class="string">"regexp"</span></span><br><span class="line">      <span class="string">"time"</span></span><br><span class="line"></span><br><span class="line">      <span class="string">"github.com/dgrijalva/jwt-go"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">      TYPE_USER = <span class="string">"user"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">      usernamePattern = regexp.MustCompile(<span class="string">`^[a-z0-9_]+$`</span>).MatchString</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">      Username <span class="keyword">string</span> <span class="string">`json:"username"`</span></span><br><span class="line">      Password <span class="keyword">string</span> <span class="string">`json:"password"`</span></span><br><span class="line">      Age <span class="keyword">int</span> <span class="string">`json:"age"`</span></span><br><span class="line">      Gender <span class="keyword">string</span> <span class="string">`json:"gender"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Implement-checkUser-method-in-user-go"><a href="#Implement-checkUser-method-in-user-go" class="headerlink" title="Implement checkUser method in user.go."></a>Implement checkUser method in user.go.</h3><p>What does this method do? </p>
<p>We need to check whether a pair of username and password is stored in <code>ES</code>.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// checkUser checks whether user is valid</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkUser</span><span class="params">(username, password <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">      es_client, err := elastic.NewClient(elastic.SetURL(ES_URL), elastic.SetSniff(<span class="literal">false</span>))</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">             fmt.Printf(<span class="string">"ES is not setup %v\n"</span>, err)</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Search with a term query</span></span><br><span class="line">      termQuery := elastic.NewTermQuery(<span class="string">"username"</span>, username)</span><br><span class="line">      queryResult, err := es_client.Search().</span><br><span class="line">             Index(INDEX).</span><br><span class="line">             Query(termQuery).</span><br><span class="line">             Pretty(<span class="literal">true</span>).</span><br><span class="line">             Do()</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">             fmt.Printf(<span class="string">"ES query failed %v\n"</span>, err)</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> tyu User</span><br><span class="line">      <span class="keyword">for</span> _, item := <span class="keyword">range</span> queryResult.Each(reflect.TypeOf(tyu)) &#123;</span><br><span class="line">             u := item.(User)</span><br><span class="line">             <span class="keyword">return</span> u.Password == password &amp;&amp; u.Username == username</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// If no user exist, return false.</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Implement-addUser-method"><a href="#Implement-addUser-method" class="headerlink" title="Implement addUser method."></a>Implement addUser method.</h3><p>Student question</p>
<ol>
<li>After we send the term query, how do we know whether this user has existed?</li>
<li>How to insert this user into ES? </li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add a new user. Return true if successfully.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addUser</span><span class="params">(user User)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	es_client, err := elastic.NewClient(elastic.SetURL(ES_URL), elastic.SetSniff(<span class="literal">false</span>))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"ES is not setup %v\n"</span>, err)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	termQuery := elastic.NewTermQuery(<span class="string">"username"</span>, user.Username)</span><br><span class="line">	queryResult, err := es_client.Search().</span><br><span class="line">		Index(INDEX).</span><br><span class="line">		Query(termQuery).</span><br><span class="line">		Pretty(<span class="literal">true</span>).</span><br><span class="line">		Do()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"ES query failed %v\n"</span>, err)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> queryResult.TotalHits() &gt; <span class="number">0</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"User %s already exists, cannot create duplicate user.\n"</span>, user.Username)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	_, err = es_client.Index().</span><br><span class="line">		Index(INDEX).</span><br><span class="line">		Type(TYPE_USER).</span><br><span class="line">		Id(user.Username).</span><br><span class="line">		BodyJson(user).</span><br><span class="line">		Refresh(<span class="literal">true</span>).</span><br><span class="line">		Do()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"ES save user failed %v\n"</span>, err)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Implement-signupHandler-method"><a href="#Implement-signupHandler-method" class="headerlink" title="Implement signupHandler method."></a>Implement signupHandler method.</h3><p>Student question: finish this method to support</p>
<ol>
<li>Decode a user from request (POST)</li>
<li>Check whether username and password are empty, if any of them is empty, call <code>http.Error(w, &quot;Empty password or username&quot;, http.StatusInternalServerError)</code></li>
<li>Otherwise, call addUser, if true, return a message “User added successfully”</li>
<li>If else, call http.Error(w, “Failed to add a new user”, http.StatusInternalServerError)</li>
<li>Set header to be  w.Header().Set(“Content-Type”, “text/plain”)  w.Header().Set(“Access-Control-Allow-Origin”, “*”)</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If signup is successful, a new session is created.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">signupHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">      fmt.Println(<span class="string">"Received one signup request"</span>)</span><br><span class="line"></span><br><span class="line">      decoder := json.NewDecoder(r.Body)</span><br><span class="line">      <span class="keyword">var</span> u User</span><br><span class="line">      <span class="keyword">if</span> err := decoder.Decode(&amp;u); err != <span class="literal">nil</span> &#123;</span><br><span class="line">             <span class="built_in">panic</span>(err)</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> u.Username != <span class="string">""</span> &amp;&amp; u.Password != <span class="string">""</span> &amp;&amp; usernamePattern(u.Username) &#123;</span><br><span class="line">             <span class="keyword">if</span> addUser(u) &#123;</span><br><span class="line">                    fmt.Println(<span class="string">"User added successfully."</span>)</span><br><span class="line">                    w.Write([]<span class="keyword">byte</span>(<span class="string">"User added successfully."</span>))</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    fmt.Println(<span class="string">"Failed to add a new user."</span>)</span><br><span class="line">                    http.Error(w, <span class="string">"Failed to add a new user"</span>, http.StatusInternalServerError)</span><br><span class="line">             &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             fmt.Println(<span class="string">"Empty password or username."</span>)</span><br><span class="line">             http.Error(w, <span class="string">"Empty password or username"</span>, http.StatusInternalServerError)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"text/plain"</span>)</span><br><span class="line">      w.Header().Set(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Implement-loginHandler"><a href="#Implement-loginHandler" class="headerlink" title="Implement loginHandler"></a>Implement loginHandler</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// If login is successful, a new token is created.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loginHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">      fmt.Println(<span class="string">"Received one login request"</span>)</span><br><span class="line"></span><br><span class="line">      decoder := json.NewDecoder(r.Body)</span><br><span class="line">      <span class="keyword">var</span> u User</span><br><span class="line">      <span class="keyword">if</span> err := decoder.Decode(&amp;u); err != <span class="literal">nil</span> &#123;</span><br><span class="line">             <span class="built_in">panic</span>(err)</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> checkUser(u.Username, u.Password) &#123;</span><br><span class="line">             token := jwt.New(jwt.SigningMethodHS256)</span><br><span class="line">             claims := token.Claims.(jwt.MapClaims)</span><br><span class="line">             <span class="comment">/* Set token claims */</span></span><br><span class="line">             claims[<span class="string">"username"</span>] = u.Username</span><br><span class="line">             claims[<span class="string">"exp"</span>] = time.Now().Add(time.Hour * <span class="number">24</span>).Unix()</span><br><span class="line"></span><br><span class="line">             <span class="comment">/* Sign the token with our secret */</span></span><br><span class="line">             tokenString, _ := token.SignedString(mySigningKey)</span><br><span class="line"></span><br><span class="line">             <span class="comment">/* Finally, write the token to the browser window */</span></span><br><span class="line">             w.Write([]<span class="keyword">byte</span>(tokenString))</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             fmt.Println(<span class="string">"Invalid password or username."</span>)</span><br><span class="line">             http.Error(w, <span class="string">"Invalid password or username"</span>, http.StatusForbidden)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"text/plain"</span>)</span><br><span class="line">      w.Header().Set(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Let’s explain the codes</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">decoder := json.NewDecoder(r.Body)</span><br><span class="line">      <span class="keyword">var</span> u User</span><br><span class="line">      <span class="keyword">if</span> err := decoder.Decode(&amp;u); err != <span class="literal">nil</span> &#123;</span><br><span class="line">             <span class="built_in">panic</span>(err)</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>Decode a user from request’s body<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> checkUser(u.Username, u.Password) &#123;</span><br></pre></td></tr></table></figure></p>
<p>Make sure user credential is correct.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">token := jwt.New(jwt.SigningMethodHS256)</span><br></pre></td></tr></table></figure>
<p>Create a new token object to store.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">claims := token.Claims.(jwt.MapClaims)</span><br></pre></td></tr></table></figure>
<p>Convert it into a map for lookup</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">claims[<span class="string">"username"</span>] = u.Username</span><br><span class="line">claims[<span class="string">"exp"</span>] = time.Now().Add(time.Hour * <span class="number">24</span>).Unix()</span><br></pre></td></tr></table></figure>
<p>Store username and expiration into it.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tokenString, _ := token.SignedString(mySigningKey)</span><br></pre></td></tr></table></figure>
<p>Sign (Encrypt) and token such that only server knows it.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">w.Write([]<span class="keyword">byte</span>(tokenString))</span><br></pre></td></tr></table></figure>
<p>Write it into response</p>
<h3 id="Update-handlerPost-in-main-go-to-populate-username"><a href="#Update-handlerPost-in-main-go-to-populate-username" class="headerlink" title="Update handlerPost in main.go to populate username"></a>Update handlerPost in main.go to populate username</h3><p>Question: why use the username in context? Why not ask user to send it as param?</p>
<p>Answer: </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handlerPost</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">      <span class="comment">// other codes</span></span><br><span class="line">      user := r.Context().Value(<span class="string">"user"</span>)</span><br><span class="line">      claims := user.(*jwt.Token).Claims</span><br><span class="line">      username := claims.(jwt.MapClaims)[<span class="string">"username"</span>]</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 32 &lt;&lt; 20 is the maxMemory param for ParseMultipartForm</span></span><br><span class="line">      <span class="comment">// After you call ParseMultipartForm, the file will be saved in the server memory with maxMemory size.</span></span><br><span class="line">      <span class="comment">// If the file size is larger than maxMemory, the rest of the data will be saved in a system temporary file.</span></span><br><span class="line">      r.ParseMultipartForm(<span class="number">32</span> &lt;&lt; <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Parse from form data.</span></span><br><span class="line">      fmt.Printf(<span class="string">"Received one post request %s\n"</span>, r.FormValue(<span class="string">"message"</span>))</span><br><span class="line">      lat, _ := strconv.ParseFloat(r.FormValue(<span class="string">"lat"</span>), <span class="number">64</span>)</span><br><span class="line">      lon, _ := strconv.ParseFloat(r.FormValue(<span class="string">"lon"</span>), <span class="number">64</span>)</span><br><span class="line">      p := &amp;Post&#123;</span><br><span class="line">             User:    username.(<span class="keyword">string</span>),</span><br><span class="line">             Message: r.FormValue(<span class="string">"message"</span>),</span><br><span class="line">             Location: Location&#123;</span><br><span class="line">                    Lat: lat,</span><br><span class="line">                    Lon: lon,</span><br><span class="line">             &#125;,</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h1><h2 id="Local-test"><a href="#Local-test" class="headerlink" title="Local test"></a>Local test</h2><h3 id="In-the-same-folder-where-you-have-main-go-and-user-go"><a href="#In-the-same-folder-where-you-have-main-go-and-user-go" class="headerlink" title="In the same folder where you have main.go and user.go"></a>In the same folder where you have main.go and user.go</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run *.go</span><br></pre></td></tr></table></figure>
<blockquote>
<p>In windows, execute <code>go run main.go users.go</code></p>
</blockquote>
<h3 id="Open-Postman-and-enter-‘http-localhost-8080-signup’-in-the-url-in-the-Body-add-a-new-json-object-as"><a href="#Open-Postman-and-enter-‘http-localhost-8080-signup’-in-the-url-in-the-Body-add-a-new-json-object-as" class="headerlink" title="Open Postman and enter ‘http://localhost:8080/signup’ in the url, in the Body add a new json object as"></a>Open Postman and enter ‘<a href="http://localhost:8080/signup’" target="_blank" rel="noopener">http://localhost:8080/signup’</a> in the url, in the Body add a new json object as</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"username"</span>:<span class="string">"jack"</span>,</span><br><span class="line">	<span class="attr">"password"</span>:<span class="string">"ABCD"</span>,</span><br><span class="line">	<span class="attr">"age"</span>:<span class="number">16</span>,</span><br><span class="line">	<span class="attr">"gender"</span>:<span class="string">"female"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Click Send and you should see a message like ‘User added successfully’. </p>
<h3 id="Change-the-url-to-be-‘http-localhost-8080-login’-and-in-the-body-use-the-same-json-object"><a href="#Change-the-url-to-be-‘http-localhost-8080-login’-and-in-the-body-use-the-same-json-object" class="headerlink" title="Change the url to be ‘http://localhost:8080/login’, and in the body use the same json object."></a>Change the url to be ‘<a href="http://localhost:8080/login’" target="_blank" rel="noopener">http://localhost:8080/login’</a>, and in the body use the same json object.</h3><p>It will return a token as response copy it</p>
<h3 id="Post"><a href="#Post" class="headerlink" title="Post"></a>Post</h3><p>change the url to ‘<code>http://localhost:8080/post</code>’ and then in the header add a new key value with a key as ‘<code>Authorization</code>’ and a value as ‘<code>Bearer YOUR_TOKEN</code>’. In the body, still add related input params and an image file. </p>
<blockquote>
<p>bearer is also fine</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/5.%20Authentication-2019-5-1-15-39-33.png" alt="5. Authentication-2019-5-1-15-39-33.png"></p>
<p>Click Send and make it works. </p>
<blockquote>
<p>在这里elastic search默认只显示10条结果，需要在search handler那里修改一下结果数量。</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/5.%20Authentication-2019-5-1-17-21-39.png" alt="5. Authentication-2019-5-1-17-21-39.png"></p>
<h3 id="Search"><a href="#Search" class="headerlink" title="Search"></a>Search</h3><p>change the url to ‘<a href="http://localhost:8080/search?lat=37.5&amp;lon=-120.5&amp;range=200’" target="_blank" rel="noopener">http://localhost:8080/search?lat=37.5&amp;lon=-120.5&amp;range=200’</a> and the method to be GET. Then in the Headers, similarly, add a new Authorization key value pair if not there. </p>
<p>Click send and you should get the same results as last time.<br>You can also verify the signed content on:<br><a href="https://jwt.io/" target="_blank" rel="noopener">https://jwt.io/</a></p>
<h2 id="Remote-test-Homework"><a href="#Remote-test-Homework" class="headerlink" title="Remote test (Homework)"></a>Remote test (Homework)</h2><p>Deploy a new instance in GCloud and then test it again</p>
<p>REMEMBER: Install new packages on Google Cloud Shell!<br>Note: some new package may need to be installed on Google cloud shell:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/googleapis/gax-go</span><br><span class="line">go get google.golang.org/api/googleapi</span><br><span class="line">go get go.opencensus.io/trace</span><br></pre></td></tr></table></figure>
<p>Homework</p>
<ol>
<li>Try to send some random string and see what’s the response</li>
<li>Why we don’t protect the two endpoints of ‘login’ and ‘signup’?</li>
<li>How to protect credentials from man-in-the-middle attack?</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/30/Google Cloud Storage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yanpeng Luo">
      <meta itemprop="description" content="Notes of study, work and life">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yanpeng">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/30/Google Cloud Storage/" class="post-title-link" itemprop="url">Google Cloud Storage</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-30 21:41:51 / Modified: 14:43:55" itemprop="dateCreated datePublished" datetime="2019-04-30T21:41:51-07:00">2019-04-30</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">13k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">12 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Google-Cloud-Storage-GCS"><a href="#Google-Cloud-Storage-GCS" class="headerlink" title="Google Cloud Storage (GCS)"></a>Google Cloud Storage (GCS)</h1><p><strong>Question</strong>: we have so many storage, why we still need GCS (Google Cloud Storage)?</p>
<p><strong>Answer</strong>: to store unstructured data (file, image, video, etc.) and implement CDN. BigTable, BigQuery, ElasticSearch are all for structured data.</p>
<p><strong>Definition</strong>: A Powerful, Simple and Cost Effective Object Storage Service.<br>Think it as Google Drive, Dropbox, Amazon S3.</p>
<h2 id="Features"><a href="#Features" class="headerlink" title="Features"></a>Features</h2><h3 id="Durable"><a href="#Durable" class="headerlink" title="Durable"></a>Durable</h3><ul>
<li>Google Cloud Storage is designed for 99.999999999% durability. It stores data redundantly, with automatic checksums to ensure data integrity. With Multi-Regional storage, your data is maintained in geographically distinct locations.<h3 id="Available"><a href="#Available" class="headerlink" title="Available"></a>Available</h3></li>
<li>All storage classes offer very high availability around the world.<h3 id="Scalable"><a href="#Scalable" class="headerlink" title="Scalable"></a>Scalable</h3><h3 id="Inexpensive"><a href="#Inexpensive" class="headerlink" title="Inexpensive"></a>Inexpensive</h3></li>
<li>Good to store unstructured data like image, file, video, etc.</li>
</ul>
<h1 id="Content-Delivery-Network-CDN"><a href="#Content-Delivery-Network-CDN" class="headerlink" title="Content Delivery Network (CDN)"></a>Content Delivery Network (CDN)</h1><p>A content delivery network or content distribution network (CDN) is a geographically distributed network of proxy servers and their data centers. </p>
<p>CDN, offers an efficient, cost-effective way of reducing both network I/O costs and content delivery latency for regularly accessed website assets. </p>
<p>A CDN can be understood as group of geographically distributed caches, with each cache locaœted in one of several global points of presence. </p>
<p>Traditional server vs. CDN<br><img src="https://raw.githubusercontent.com/YanpengQi/images/master/4.%20Google%20Cloud%20Storage-2019-4-29-11-31-29.png" alt="4. Google Cloud Storage-2019-4-29-11-31-29.png"><br>Companies like Akamai, Cloudflare, etc.</p>
<h1 id="GCS-Bucket"><a href="#GCS-Bucket" class="headerlink" title="GCS Bucket"></a>GCS Bucket</h1><p>First of all, we will need a gcs bucket. Why we need this bucket? It’s like a folder which we can have files (images/videos posted from user) in it. Bucket == Folder.</p>
<p>Open your console.cloud.google.com and choose Storage -&gt; Browser.</p>
<p>Then click ‘<code>CREATE BUCKET</code>’ to create a new bucket.</p>
<p>Pick a name for it, starts with <code>post-images-</code>, and the suffix is your project ID to avoid any conflict with other users. If used by others, add a random number. For example, I use <code>post-images-75015</code> while yours will be different. Please remember this bucket name and we will use it later. </p>
<p>When asked about ‘<code>Default storage class</code>’, Regional is ok as our servers (GAE flex) are in us-central-<em>, so we may put this bucket in us-central-</em> too. Click ‘<code>save</code>’ to save your changes. </p>
<h1 id="Multi-part-Form"><a href="#Multi-part-Form" class="headerlink" title="Multi part Form"></a>Multi part Form</h1><p>A HTTP multipart request is a HTTP request that HTTP clients construct to send files and data over to a HTTP Server. </p>
<p>It is commonly used by browsers and HTTP clients to upload files to the server. </p>
<p>The content type “<code>application/x-www-form-urlencoded</code>“ is inefficient for sending large quantities of binary data or text containing non-ASCII characters. </p>
<p>The content type “<code>multipart/form-data</code>“ should be used for submitting forms that contain files, non-ASCII data, and binary data.</p>
<p>How to send multipart request in Postman?</p>
<p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/4.%20Google%20Cloud%20Storage-2019-4-30-9-46-47.png" alt="4. Google Cloud Storage-2019-4-30-9-46-47.png"></p>
<p>How does it look like?</p>
<p> <img src="https://raw.githubusercontent.com/YanpengQi/images/master/4.%20Google%20Cloud%20Storage-2019-4-30-9-47-2.png" alt="4. Google Cloud Storage-2019-4-30-9-47-2.png"></p>
<p>How to parse multipart form in Go?</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Request)</span> <span class="title">ParseMultipartForm</span><span class="params">(maxMemory <span class="keyword">int64</span>)</span> <span class="title">error</span></span></span><br></pre></td></tr></table></figure>
<p><a href="https://golang.org/pkg/net/http/#Request.ParseMultipartForm" target="_blank" rel="noopener">https://golang.org/pkg/net/http/#Request.ParseMultipartForm</a></p>
<p><a href="https://github.com/golang-samples/http/blob/master/fileupload/main.go" target="_blank" rel="noopener">https://github.com/golang-samples/http/blob/master/fileupload/main.go</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1MB</span></span><br><span class="line"><span class="keyword">const</span> MAX_MEMORY = <span class="number">1</span> * <span class="number">1024</span> * <span class="number">1024</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">upload</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err := r.ParseMultipartForm(MAX_MEMORY); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(err)</span><br><span class="line">		http.Error(w, err.Error(), http.StatusForbidden)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> key, value := <span class="keyword">range</span> r.MultipartForm.Value &#123;</span><br><span class="line">		fmt.Fprintf(w, <span class="string">"%s:%s "</span>, key, value)</span><br><span class="line">		log.Printf(<span class="string">"%s:%s"</span>, key, value)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, fileHeaders := <span class="keyword">range</span> r.MultipartForm.File &#123;</span><br><span class="line">		<span class="keyword">for</span> _, fileHeader := <span class="keyword">range</span> fileHeaders &#123;</span><br><span class="line">			file, _ := fileHeader.Open()</span><br><span class="line">			path := fmt.Sprintf(<span class="string">"files/%s"</span>, fileHeader.Filename)</span><br><span class="line">			buf, _ := ioutil.ReadAll(file)</span><br><span class="line">			ioutil.WriteFile(path, buf, os.ModePerm)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	http.HandleFunc(<span class="string">"/upload"</span>, upload)</span><br><span class="line">	http.Handle(<span class="string">"/"</span>, http.FileServer(http.Dir(<span class="string">"static"</span>)))</span><br><span class="line">	log.Fatal(http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Code-changes"><a href="#Code-changes" class="headerlink" title="Code changes"></a>Code changes</h1><p>Question: Why we need GCS in this project?<br>Answer: to save the image uploaded from user and serve it.</p>
<p>Update handlerPost to support save image into GCS</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">      <span class="string">"context"</span></span><br><span class="line">      <span class="string">"cloud.google.com/go/storage"</span></span><br><span class="line">      <span class="comment">// other libs</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">      INDEX       = <span class="string">"around"</span></span><br><span class="line">      TYPE        = <span class="string">"post"</span></span><br><span class="line">      DISTANCE    = <span class="string">"200km"</span></span><br><span class="line">      PROJECT_ID  = <span class="string">"around-75015"</span></span><br><span class="line">      BT_INSTANCE = <span class="string">"around-post"</span></span><br><span class="line">      <span class="comment">// other configs</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Needs to update this bucket based on your gcs bucket name.</span></span><br><span class="line">      BUCKET_NAME = <span class="string">"post-images-75015"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Post <span class="keyword">struct</span> &#123;</span><br><span class="line">      <span class="comment">// `json:"user"` is for the json parsing of this User field. Otherwise, by default it's 'User'.</span></span><br><span class="line">      User     <span class="keyword">string</span> <span class="string">`json:"user"`</span></span><br><span class="line">      Message  <span class="keyword">string</span>  <span class="string">`json:"message"`</span></span><br><span class="line">      Location Location <span class="string">`json:"location"`</span></span><br><span class="line">      Url    <span class="keyword">string</span> <span class="string">`json:"url"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handlerPost</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">      <span class="comment">// Other codes</span></span><br><span class="line">     w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"application/json"</span>)</span><br><span class="line">     w.Header().Set(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>)</span><br><span class="line">     w.Header().Set(<span class="string">"Access-Control-Allow-Headers"</span>, <span class="string">"Content-Type,Authorization"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 32 &lt;&lt; 20 is the maxMemory param for ParseMultipartForm, equals to 32MB (1MB = 1024 * 1024 bytes = 2^20 bytes)</span></span><br><span class="line">      <span class="comment">// After you call ParseMultipartForm, the file will be saved in the server memory with maxMemory size.</span></span><br><span class="line">      <span class="comment">// If the file size is larger than maxMemory, the rest of the data will be saved in a system temporary file.</span></span><br><span class="line">      r.ParseMultipartForm(<span class="number">32</span> &lt;&lt; <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Parse from form data.</span></span><br><span class="line">      fmt.Printf(<span class="string">"Received one post request %s\n"</span>, r.FormValue(<span class="string">"message"</span>))</span><br><span class="line">      lat, _ := strconv.ParseFloat(r.FormValue(<span class="string">"lat"</span>), <span class="number">64</span>)</span><br><span class="line">      lon, _ := strconv.ParseFloat(r.FormValue(<span class="string">"lon"</span>), <span class="number">64</span>)</span><br><span class="line">      p := &amp;Post&#123;</span><br><span class="line">             User:    <span class="string">"1111"</span>,</span><br><span class="line">             Message: r.FormValue(<span class="string">"message"</span>),</span><br><span class="line">             Location: Location&#123;</span><br><span class="line">                    Lat: lat,</span><br><span class="line">                    Lon: lon,</span><br><span class="line">             &#125;,</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      id := uuid.New()</span><br><span class="line"></span><br><span class="line">      file, _, err := r.FormFile(<span class="string">"image"</span>)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">             http.Error(w, <span class="string">"Image is not available"</span>, http.StatusInternalServerError)</span><br><span class="line">             fmt.Printf(<span class="string">"Image is not available %v.\n"</span>, err)</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">defer</span> file.Close()</span><br><span class="line"></span><br><span class="line">      ctx := context.Background()</span><br><span class="line"></span><br><span class="line">     <span class="comment">// replace it with your real bucket name.</span></span><br><span class="line">      _, attrs, err := saveToGCS(ctx, file, BUCKET_NAME, id)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">             http.Error(w, <span class="string">"GCS is not setup"</span>, http.StatusInternalServerError)</span><br><span class="line">             fmt.Printf(<span class="string">"GCS is not setup %v\n"</span>, err)</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Update the media link after saving to GCS.</span></span><br><span class="line">      p.Url = attrs.MediaLink</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Save to ES.</span></span><br><span class="line">      saveToES(p, id)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Save to BigTable.</span></span><br><span class="line">      <span class="comment">//saveToBigTable(p, id)</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">saveToGCS</span><span class="params">(ctx context.Context, r io.Reader, bucketName, name <span class="keyword">string</span>)</span> <span class="params">(*storage.ObjectHandle, *storage.ObjectAttrs, error)</span></span> &#123;</span><br><span class="line">     <span class="comment">// Student questions</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Implement-saveToGCS"><a href="#Implement-saveToGCS" class="headerlink" title="Implement saveToGCS."></a>Implement saveToGCS.</h1><p>Google has provided a good example of writing objects to GCS. <a href="https://cloud.google.com/storage/docs/reference/libraries#client-libraries-install-go" target="_blank" rel="noopener">https://cloud.google.com/storage/docs/reference/libraries#client-libraries-install-go</a> </p>
<p>Google example of open a client connection to GCS</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">        <span class="string">"fmt"</span></span><br><span class="line">        <span class="string">"log"</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Imports the Google Cloud Storage client package.</span></span><br><span class="line">        <span class="string">"cloud.google.com/go/storage"</span></span><br><span class="line">        <span class="string">"golang.org/x/net/context"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">        ctx := context.Background()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Sets your Google Cloud Platform project ID.</span></span><br><span class="line">        projectID := <span class="string">"YOUR_PROJECT_ID"</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Creates a client.</span></span><br><span class="line">        client, err := storage.NewClient(ctx)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                log.Fatalf(<span class="string">"Failed to create client: %v"</span>, err)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Sets the name for the new bucket.</span></span><br><span class="line">        bucketName := <span class="string">"my-new-bucket"</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Creates a Bucket instance.</span></span><br><span class="line">        bucket := client.Bucket(bucketName)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Creates the new bucket.</span></span><br><span class="line">        <span class="keyword">if</span> err := bucket.Create(ctx, projectID, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                log.Fatalf(<span class="string">"Failed to create bucket: %v"</span>, err)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fmt.Printf(<span class="string">"Bucket %v created.\n"</span>, bucketName)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Google example of writing an object to GCS (copied from <a href="https://github.com/GoogleCloudPlatform/golang-samples/blob/master/storage/objects/main.go" target="_blank" rel="noopener">https://github.com/GoogleCloudPlatform/golang-samples/blob/master/storage/objects/main.go</a><br>) </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">write</span><span class="params">(client *storage.Client, bucket, object <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	ctx := context.Background()</span><br><span class="line">	<span class="comment">// [START upload_file]</span></span><br><span class="line">	f, err := os.Open(<span class="string">"notes.txt"</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> f.Close()</span><br><span class="line"></span><br><span class="line">	wc := client.Bucket(bucket).Object(object).NewWriter(ctx)</span><br><span class="line">	<span class="keyword">if</span> _, err = io.Copy(wc, f); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := wc.Close(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// [END upload_file]</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Answer: </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Save an image to GCS.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">saveToGCS</span><span class="params">(ctx context.Context, r io.Reader, bucketName, name <span class="keyword">string</span>)</span> <span class="params">(*storage.ObjectHandle, *storage.ObjectAttrs, error)</span></span> &#123;</span><br><span class="line">      client, err := storage.NewClient(ctx)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">defer</span> client.Close()</span><br><span class="line"></span><br><span class="line">      bucket := client.Bucket(bucketName)</span><br><span class="line">      <span class="comment">// Next check if the bucket exists</span></span><br><span class="line">      <span class="keyword">if</span> _, err = bucket.Attrs(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      obj := bucket.Object(name)</span><br><span class="line">      w := obj.NewWriter(ctx)</span><br><span class="line">      <span class="keyword">if</span> _, err := io.Copy(w, r); err != <span class="literal">nil</span> &#123;</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> err := w.Close(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> err := obj.ACL().Set(ctx, storage.AllUsers, storage.RoleReader); err != <span class="literal">nil</span> &#123;</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      attrs, err := obj.Attrs(ctx)</span><br><span class="line">      fmt.Printf(<span class="string">"Post is saved to GCS: %s\n"</span>, attrs.MediaLink)</span><br><span class="line">      <span class="keyword">return</span> obj, attrs, err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Remember to install package:</p>
<p><code>go get -u cloud.google.com/go/storage</code></p>
<blockquote>
<p>这里遇到了迷之bug <code>error: elastic: Error 400 (Bad Request): failed to parse [type=mapper_parsing_exception]</code> 问题出在postman上面， 重新开个post或者试试把url的类型改成plain text</p>
</blockquote>
<h1 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h1><h2 id="Local-test-on-your-own-computer"><a href="#Local-test-on-your-own-computer" class="headerlink" title="Local test (on your own computer)"></a>Local test (on your own computer)</h2><h3 id="cd-to-the-folder-where-you-have-main-go"><a href="#cd-to-the-folder-where-you-have-main-go" class="headerlink" title="cd to the folder where you have main.go"></a>cd to the folder where you have main.go</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run main.go</span><br></pre></td></tr></table></figure>
<h3 id="Open-your-Postman-change-the-method-to-POST-in-the-url-enter-‘http-localhost-8080-post’"><a href="#Open-your-Postman-change-the-method-to-POST-in-the-url-enter-‘http-localhost-8080-post’" class="headerlink" title="Open your Postman, change the method to POST, in the url enter ‘http://localhost:8080/post’"></a>Open your Postman, change the method to POST, in the url enter ‘<a href="http://localhost:8080/post’" target="_blank" rel="noopener">http://localhost:8080/post’</a></h3><p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/4.%20Google%20Cloud%20Storage-2019-4-30-14-5-10.png" alt="4. Google Cloud Storage-2019-4-30-14-5-10.png"></p>
<p>In the Body part, choose form-data, and then enter lat, lon, message and image. For image, the type is ‘file’ such that you may upload an image from your local storage. </p>
<h3 id="Verify-the-search-API-is-working"><a href="#Verify-the-search-API-is-working" class="headerlink" title="Verify the search API is working"></a>Verify the search API is working</h3><p>Open Postman, change the method to GET, in the url change it to ‘<a href="http://localhost:8080/search?lat=37.5&amp;lon=-120.5&amp;range=200’" target="_blank" rel="noopener">http://localhost:8080/search?lat=37.5&amp;lon=-120.5&amp;range=200’</a></p>
<p>Copy the url into your browser and download the image to verify that it’s the same image that you’ve downloaded. </p>
<p>If you have any auth issue, try</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcloud auth application-default login</span><br></pre></td></tr></table></figure>
<p>If you have permission problem, try</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chown -R $(whoami):staff ~/.config/gcloud/</span><br></pre></td></tr></table></figure>
<h1 id="Integration-test-TBD"><a href="#Integration-test-TBD" class="headerlink" title="Integration test (TBD)"></a>Integration test (TBD)</h1><h2 id="Remote-test-homework"><a href="#Remote-test-homework" class="headerlink" title="Remote test (homework)"></a>Remote test (homework)</h2><p>Commit your changes to github and then open a new cloud terminal. </p>
<h3 id="Check-out-from-github"><a href="#Check-out-from-github" class="headerlink" title="Check out from github"></a>Check out from github</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull origin master</span><br></pre></td></tr></table></figure>
<h3 id="cd-to-your-folder-with-main-go-and-app-yaml"><a href="#cd-to-your-folder-with-main-go-and-app-yaml" class="headerlink" title="cd to your folder with main.go and app.yaml"></a>cd to your folder with main.go and app.yaml</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcloud app deploy</span><br></pre></td></tr></table></figure>
<p>Wait until the deployment is done</p>
<h3 id="Open-Postman"><a href="#Open-Postman" class="headerlink" title="Open Postman."></a>Open Postman.</h3><p>Instead of using ‘<a href="http://localhost:8080’" target="_blank" rel="noopener">http://localhost:8080’</a> change it to your service url (without port) For example, ‘<a href="http://around-179500.appspot.com/post’" target="_blank" rel="noopener">http://around-179500.appspot.com/post’</a> and ‘<a href="http://around-179500.appspot.com/search?lat=37.5&amp;lon=-120.5&amp;range=200’" target="_blank" rel="noopener">http://around-179500.appspot.com/search?lat=37.5&amp;lon=-120.5&amp;range=200’</a> </p>
<p>The others are the same</p>
<h1 id="Cors"><a href="#Cors" class="headerlink" title="Cors"></a>Cors</h1><p><code>cross-origin sharing stYanpengrd</code></p>
<p>Pre-flight requests: You may have a content type like JSON, or some other custom header that’s triggering a pre-flight request, which your server may not be handling. </p>
<p>Try adding this one, if you’re using the ever-common AJAX in your front-end: <a href="https://en.wikipedia.org/wiki/List_of_HTTP_header_fields#Requested-With" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/List_of_HTTP_header_fields#Requested-With</a><br>Gorilla’s <code>handlers.CORS()</code> will set sane defaults to get the basics of CORS working for you;</p>
<p> however, you can (and maybe should) take control in a more functional manner.<br><a href="https://stackoverflow.com/questions/40985920/making-golang-gorilla-cors-handler-work" target="_blank" rel="noopener">https://stackoverflow.com/questions/40985920/making-golang-gorilla-cors-handler-work</a></p>
<h2 id="Optional-Vim-go-plugin"><a href="#Optional-Vim-go-plugin" class="headerlink" title="(Optional) Vim go plugin:"></a>(Optional) Vim go plugin:</h2><p><a href="https://github.com/fatih/vim-go" target="_blank" rel="noopener">https://github.com/fatih/vim-go</a></p>
<h1 id="Spam-and-Abuse-Detection"><a href="#Spam-and-Abuse-Detection" class="headerlink" title="Spam and Abuse Detection"></a>Spam and Abuse Detection</h1><p>Any user-facing IT company has to address the Spam and Abuse problem in production. </p>
<p><strong>Question</strong>: Why our project needs to think about spam problem?</p>
<p><strong>Answer</strong>:<br>Categories of Spam and Abuse in Industry<br>Racy/Nudity (Child Porn especially)</p>
<ul>
<li>Harassment or Hate Speech (n* word, etc.)</li>
<li>Fake News (Facebook)</li>
<li>Keyword Spam (Keyword stuffing)</li>
<li>Drug Abuse</li>
<li>Violence or Bully</li>
<li>Spam</li>
<li>Copycat (IP Infringement) </li>
<li>Phishing (CEO Phishing for SSN)</li>
<li>Privacy Leak<h2 id="Solutions"><a href="#Solutions" class="headerlink" title="Solutions"></a>Solutions</h2></li>
<li>Keyword based (rule based) <ul>
<li>n<em> words, s</em> words, f* words, etc.</li>
</ul>
</li>
<li>Machine Learning Model (images and videos)<ul>
<li>Open NSFW model </li>
</ul>
</li>
<li>Geo location based <ul>
<li>Strip clubs, etc.</li>
</ul>
</li>
<li>User based<ul>
<li>User ban</li>
<li>User warning</li>
<li>Aggregated user signals</li>
</ul>
</li>
<li>User feedback<ul>
<li>report</li>
<li>Machine Learning</li>
<li>Moderators</li>
</ul>
</li>
<li>External channels<ul>
<li>Internal users like employees</li>
<li>Media coverage</li>
</ul>
</li>
<li>Others</li>
</ul>
<p><strong>Question</strong>:<br>In our current design, we kind of spam filters we may enforce?</p>
<p><strong>Answer</strong>: For example, keyword based spam filter</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/29/GAE Basic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yanpeng Luo">
      <meta itemprop="description" content="Notes of study, work and life">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yanpeng">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/29/GAE Basic/" class="post-title-link" itemprop="url">GAE Basic</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-29 18:05:54 / Modified: 11:08:46" itemprop="dateCreated datePublished" datetime="2019-04-29T18:05:54-07:00">2019-04-29</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">9.8k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">9 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Google-Cloud-Platform"><a href="#Google-Cloud-Platform" class="headerlink" title="Google Cloud Platform"></a>Google Cloud Platform</h1><h2 id="GAE-Google-App-Engine"><a href="#GAE-Google-App-Engine" class="headerlink" title="GAE (Google App Engine)"></a>GAE (Google App Engine)</h2><p><code>Google App Engine</code> is a cloud computing platform for developing and hosting web applications in Google-managed data centers.</p>
<h2 id="GCE-Google-Compute-Engine"><a href="#GCE-Google-Compute-Engine" class="headerlink" title="GCE (Google Compute Engine)"></a>GCE (Google Compute Engine)</h2><p><code>Google Compute Engine</code> delivers virtual machines running in Google’s innovative data centers and worldwide fiber network.</p>
<h2 id="GKE-Google-Container-Engine"><a href="#GKE-Google-Container-Engine" class="headerlink" title="GKE (Google Container Engine)"></a>GKE (Google Container Engine)</h2><p><a href="https://cloud.google.com/containers/" target="_blank" rel="noopener">https://cloud.google.com/containers/</a></p>
<h2 id="Dataflow"><a href="#Dataflow" class="headerlink" title="Dataflow"></a>Dataflow</h2><p><code>Dataflow</code> is a unified programming model and a managed service for developing and executing a wide range of data processing patterns including ETL, batch computation, and continuous computation.</p>
<h2 id="BigTable"><a href="#BigTable" class="headerlink" title="BigTable"></a>BigTable</h2><p><code>Cloud Bigtable</code> is Google’s NoSQL Big Data database service. It’s the same database that powers many core Google services, including Search, Analytics, Maps, and Gmail.</p>
<h2 id="BigQuery"><a href="#BigQuery" class="headerlink" title="BigQuery"></a>BigQuery</h2><p><code>BigQuery</code> is Google’s fully managed, petabyte scale, low cost enterprise data warehouse for analytics.</p>
<h2 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h2><ul>
<li>PubSub</li>
<li>Datastore</li>
<li>Storage</li>
<li>Monitoring </li>
</ul>
<h1 id="What-is-a-typical-BigData-project-web-analysis"><a href="#What-is-a-typical-BigData-project-web-analysis" class="headerlink" title="What is a typical BigData project (web+analysis)"></a>What is a typical BigData project (web+analysis)</h1><p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/3.%20GAE%20Basic-2019-4-28-21-11-47.png" alt="3. GAE Basic-2019-4-28-21-11-47.png"></p>
<ul>
<li>Service (GAE/GKE) to receive user generated contents</li>
<li>Datastore (BigTable/Spanner) to save contents</li>
<li>Index (ElasticSearch) to query contents in runtime</li>
<li>Service (GAE/GKE) to serve contents in runtime</li>
<li>Dataflow (MapReduce) to dump data into BigQuery</li>
<li>BigQuery (SQL) to perform further analysis</li>
</ul>
<blockquote>
<p>GKE is more like a simple GCE</p>
</blockquote>
<h1 id="Google-App-Engine-Flex"><a href="#Google-App-Engine-Flex" class="headerlink" title="Google App Engine Flex"></a>Google App Engine Flex</h1><p><code>App Engine flexible environment</code> automatically scales your app up and down while balancing the load. Microservices, authorization, SQL and NoSQL databases, traffic splitting, logging. </p>
<p>Step 3.1.1 In your Intellij, create a new file called <code>app.yaml</code></p>
<p>The content has just two lines.</p>
<blockquote>
<p>GAE 通过flex实现负载均衡</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">runtime:</span> <span class="string">go</span></span><br><span class="line"><span class="attr">env:</span> <span class="string">flex</span></span><br></pre></td></tr></table></figure>
<p><strong>Recommended</strong>: upload your two files (main.go and app.yaml) into github. </p>
<p>Worst cast: just copy and paste in terminals.</p>
<p>More readings</p>
<ul>
<li>Overview <a href="https://cloud.google.com/docs/overview/" target="_blank" rel="noopener">https://cloud.google.com/docs/overview/</a> </li>
<li>Flex in GAE <a href="https://cloud.google.com/appengine/docs/flexible/" target="_blank" rel="noopener">https://cloud.google.com/appengine/docs/flexible/</a> </li>
<li>GAE on Golang <a href="https://cloud.google.com/appengine/docs/go/" target="_blank" rel="noopener">https://cloud.google.com/appengine/docs/go/</a> </li>
<li>GAE in go: <a href="https://cloud.google.com/appengine/docs/flexible/go/quickstart" target="_blank" rel="noopener">https://cloud.google.com/appengine/docs/flexible/go/quickstart</a> </li>
</ul>
<h1 id="Setup-cloud-terminal"><a href="#Setup-cloud-terminal" class="headerlink" title="Setup cloud terminal."></a>Setup cloud terminal.</h1><p>Question: Why use cloud terminal?<br>Answer: Such that we do not rely on the local environment (Windows vs. Mac). </p>
<h2 id="Click-‘Activate-Google-Cloud-Shell’-Wait-until-the-init-is-done"><a href="#Click-‘Activate-Google-Cloud-Shell’-Wait-until-the-init-is-done" class="headerlink" title="Click ‘Activate Google Cloud Shell’.  Wait until the init is done"></a>Click ‘Activate Google Cloud Shell’.  Wait until the init is done</h2><p>Then you will see a vm available for you to play. This is similar to the EC2 vm.</p>
<h2 id="Install-go-libraries-in-gcloud-terminal"><a href="#Install-go-libraries-in-gcloud-terminal" class="headerlink" title="Install go libraries in gcloud terminal."></a>Install go libraries in gcloud terminal.</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go get gopkg.in/olivere/elastic.v3</span><br><span class="line">go get github.com/pborman/uuid</span><br></pre></td></tr></table></figure>
<h2 id="Recommended-Checkout-your-codes-from-github"><a href="#Recommended-Checkout-your-codes-from-github" class="headerlink" title="(Recommended) Checkout your codes from github"></a>(Recommended) Checkout your codes from github</h2><p>git clone <a href="https://github.com/YanpengQi/Around.git" target="_blank" rel="noopener">https://github.com/YanpengQi/Around.git</a></p>
<p><strong>Question</strong>: what’s the purpose of app.yaml?</p>
<p><strong>Answer</strong>: to tell google that your program is a go program and use go compiler to run it.</p>
<p>Then enter this line of code to make sure you copy past is done.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat main.go | head -n 5</span><br></pre></td></tr></table></figure>
<p>You’re expected to see this<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">        elastic &quot;gopkg.in/olivere/elastic.v3&quot;</span><br><span class="line">        &quot;fmt&quot;</span><br></pre></td></tr></table></figure></p>
<h2 id="Enter-gcloud-app-deploy"><a href="#Enter-gcloud-app-deploy" class="headerlink" title="Enter gcloud app deploy"></a>Enter <code>gcloud app deploy</code></h2><p>When asked about site, enter 1, which is <code>us-west2</code></p>
<p>When asked Y/n, enter Y. The deployment may take more than 10 minutes to finish (next deployment will be faster).</p>
<p>Error: If you have error like this, you may have a wrong ES_URL. Update the value and deploy again.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Updating service [default]...failed.                                                                                         </span><br><span class="line">ERROR: (gcloud.app.deploy) Error Response: [9] </span><br><span class="line">Application startup error:</span><br><span class="line">+ exec app</span><br><span class="line">panic: no Elasticsearch node available</span><br></pre></td></tr></table></figure>
<h2 id="Open-Postman-find-the-post-query-from-history"><a href="#Open-Postman-find-the-post-query-from-history" class="headerlink" title="Open Postman, find the post query from history."></a>Open Postman, find the post query from history.</h2><p><code>(POST, url=http://xxx.appspot.com/post)</code></p>
<p>Replace xxx with your real project id</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"user"</span>:<span class="string">"1111"</span>,</span><br><span class="line">	<span class="attr">"message"</span>:<span class="string">"一生必去的100个地方"</span>,</span><br><span class="line">	<span class="attr">"location"</span>:&#123;</span><br><span class="line">		<span class="attr">"lat"</span>:<span class="number">37.5</span>,</span><br><span class="line">		<span class="attr">"lon"</span>:<span class="number">-120.1</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And then find the get query from history. (GET, url=<a href="http://around-xxxx.appspot.com/search?lat=37.5&amp;lon=-120" target="_blank" rel="noopener">http://around-xxxx.appspot.com/search?lat=37.5&amp;lon=-120</a>)<br>You should get the results back</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"user"</span>: <span class="string">"1111"</span>,</span><br><span class="line">        <span class="attr">"message"</span>: <span class="string">"一生必去的100个地方"</span>,</span><br><span class="line">        <span class="attr">"location"</span>: &#123;</span><br><span class="line">            <span class="attr">"lat"</span>: <span class="number">37.5</span>,</span><br><span class="line">            <span class="attr">"lon"</span>: <span class="number">-120.1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>Play with more examples. If you do not have any results back, try to change your lat or lon to make sure it’s within 200km.</p>
<h2 id="Check-the-logging-to-see-if-there-is-any-error-message"><a href="#Check-the-logging-to-see-if-there-is-any-error-message" class="headerlink" title="Check the logging to see if there is any error message"></a>Check the logging to see if there is any error message</h2><p>Choose SATCKDRIVER -&gt; Logging -&gt; Logs</p>
<h2 id="Optional-Stop-Instance-to-save-credit"><a href="#Optional-Stop-Instance-to-save-credit" class="headerlink" title="(Optional) Stop Instance to save credit."></a>(Optional) Stop Instance to save credit.</h2><h2 id="Optional-Start-the-instance-again-In-the-same-page-choose-one-instance-and-click-START-If-the-START-is-disabled-refresh-it-or-wait-a-minute"><a href="#Optional-Start-the-instance-again-In-the-same-page-choose-one-instance-and-click-START-If-the-START-is-disabled-refresh-it-or-wait-a-minute" class="headerlink" title="(Optional) Start the instance again. In the same page, choose one instance and click START. If the START is disabled, refresh it or wait a minute."></a>(Optional) Start the instance again. In the same page, choose one instance and click START. If the START is disabled, refresh it or wait a minute.</h2><h2 id="Optional-How-to-filter-word"><a href="#Optional-How-to-filter-word" class="headerlink" title="(Optional) How to filter word"></a>(Optional) How to filter word</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">containsFilteredWords</span><span class="params">(s *<span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">        filteredWords := []<span class="keyword">string</span>&#123;</span><br><span class="line">                <span class="string">"fuck"</span>,</span><br><span class="line">                <span class="string">"100"</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> _, word := <span class="keyword">range</span> filteredWords &#123;</span><br><span class="line">                <span class="keyword">if</span> strings.Contains(*s, word) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Update relevant part from your code</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handlerSearch</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> _, item := <span class="keyword">range</span> searchResult.Each(reflect.TypeOf(typ)) &#123;</span><br><span class="line">                p := item.(Post)</span><br><span class="line">                fmt.Printf(<span class="string">"Post by %s: %s at lat %v and lon %v\n"</span>, p.User, p.Message, p.Location.Lat, p.Location.Lon)</span><br><span class="line">                <span class="comment">// TODO(vincent): Perform filtering based on keywords such as web spam etc.</span></span><br><span class="line">                <span class="keyword">if</span> !containsFilteredWords(&amp;p.Message) &#123;</span><br><span class="line">                        ps = <span class="built_in">append</span>(ps, p)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Related string operations<br><code>https://golang.org/pkg/strings/</code></p>
<h2 id="Optional-Useful-Go-information"><a href="#Optional-Useful-Go-information" class="headerlink" title="(Optional) Useful Go information"></a>(Optional) Useful Go information</h2><h3 id="Error-vs-Panic"><a href="#Error-vs-Panic" class="headerlink" title="Error vs Panic"></a>Error vs Panic</h3><ul>
<li>Error: normal way to handle error status.</li>
<li><p>Panic: normally used when some “impossible” situation happens with no intend recover.</p>
<ul>
<li>Use “recover” to handle when exiting function.</li>
<li>recover is like catch</li>
</ul>
</li>
</ul>
<h3 id="“defer”-clause"><a href="#“defer”-clause" class="headerlink" title="“defer” clause"></a>“defer” clause</h3><ul>
<li>Preferred way to recycle resources<ul>
<li>E.g. file handles, network connections, etc.</li>
<li>Defer executes after return</li>
<li>First come last executes</li>
<li>Example</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Foo</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> f File</span><br><span class="line">        <span class="keyword">if</span> f, err = os.Open(“Somefile”); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="built_in">panic</span>(“Error open file”)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">defer</span> f.Close()</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// some other error happens</span></span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span>  &#123;</span><br><span class="line">                <span class="built_in">panic</span>(“Unexpected error”)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Combined with recover to handle panic</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Foo</span><span class="params">()</span> <span class="title">result</span> <span class="title">string</span>, <span class="title">err</span> <span class="title">error</span></span> &#123;</span><br><span class="line">        <span class="keyword">type</span> openFileError <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">        <span class="keyword">type</span> unexpectedError <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">                <span class="keyword">switch</span> p := <span class="built_in">recover</span>(); p &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="literal">nil</span>:</span><br><span class="line">                        <span class="comment">// no panic</span></span><br><span class="line">                <span class="keyword">case</span> openFileError&#123;&#125;:</span><br><span class="line">                        err = fmt.Errorf(“Open file error”)</span><br><span class="line">                <span class="keyword">case</span> unexpectedError&#123;&#125;:</span><br><span class="line">                        err = fmt.Errorf(“Unexpected error”)</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                        <span class="built_in">panic</span>(p)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> f File</span><br><span class="line">        <span class="keyword">if</span> f, err = os.Open(“Somefile”); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="built_in">panic</span>(openFileError&#123;&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">defer</span> f.Close()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Some work...</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Some other error happens</span></span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span>  &#123;</span><br><span class="line">                <span class="built_in">panic</span>(unexpectedError&#123;&#125;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Go’s multiprocessing facility: Communication Sequential Processes<ul>
<li><a href="https://en.wikipedia.org/wiki/Communicating_sequential_processes" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Communicating_sequential_processes</a></li>
<li>Lightweight concurrency, synchronize using message passing</li>
</ul>
</li>
<li>Go routine<ul>
<li>Go’s concurrency mechanism</li>
<li>Lightweight (corresponding to fiber)<ul>
<li>Growable stacks</li>
<li>Scheduling<ul>
<li>m:n scheduling - m goroutine on n OS threads</li>
<li>Scheduler invoked implicitly by language construct<ul>
<li>E.g. time.Sleep, I/O, etc.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Have no identity - nothing like thread id<ul>
<li>Avoid thread-local storage (TLS, tend to be misused, similar to global variable)</li>
<li>Easy go routine migration</li>
</ul>
</li>
<li>Example</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// clock.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">        <span class="string">"io"</span></span><br><span class="line">        <span class="string">"log"</span></span><br><span class="line">        <span class="string">"net"</span></span><br><span class="line">        <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleConn</span><span class="params">(c net.Conn)</span></span> &#123;</span><br><span class="line">        <span class="keyword">defer</span> c.Close()</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">                _, err := io.WriteString(c, time.Now().Format(<span class="string">"15:04:05\n"</span>))</span><br><span class="line">                <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="comment">// e.g., client disconnected</span></span><br><span class="line">                &#125;</span><br><span class="line">                time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">        listener, err := net.Listen(<span class="string">"tcp"</span>, <span class="string">"localhost:8000"</span>)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                log.Fatal(err)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">                conn, err := listener.Accept()</span><br><span class="line">                <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                        log.Print(err) <span class="comment">// e.g., connection aborted</span></span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                &#125;</span><br><span class="line">                handleConn(conn)</span><br><span class="line">                <span class="comment">//go handleConn(conn) // handle connections concurrently</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// netcat.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">        <span class="string">"io"</span></span><br><span class="line">        <span class="string">"log"</span></span><br><span class="line">        <span class="string">"net"</span></span><br><span class="line">        <span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">        conn, err := net.Dial(<span class="string">"tcp"</span>, <span class="string">"localhost:8000"</span>)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">                log.Fatal(err)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">defer</span> conn.Close()</span><br><span class="line">        mustCopy(os.Stdout, conn)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mustCopy</span><span class="params">(dst io.Writer, src io.Reader)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> _, err := io.Copy(dst, src); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                log.Fatal(err)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Go channel<ul>
<li>Communication mechanism for Go routine</li>
<li>Example</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// channel_example.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">        messages := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">                <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">                        fmt.Println(i)</span><br><span class="line">                &#125;</span><br><span class="line">                messages &lt;- <span class="string">"done"</span></span><br><span class="line">        &#125;()</span><br><span class="line"></span><br><span class="line">        msg := &lt;-messages</span><br><span class="line"></span><br><span class="line">        fmt.Println(msg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>More reading<ul>
<li><a href="https://golang.org/doc/" target="_blank" rel="noopener">https://golang.org/doc/</a></li>
<li>The Go Programming Language - <a href="http://www.gopl.io/" target="_blank" rel="noopener">http://www.gopl.io/</a></li>
<li><a href="https://blog.golang.org/" target="_blank" rel="noopener">https://blog.golang.org/</a></li>
</ul>
</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/29/ElasticSearch and GCE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yanpeng Luo">
      <meta itemprop="description" content="Notes of study, work and life">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yanpeng">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/29/ElasticSearch and GCE/" class="post-title-link" itemprop="url">ElasticSearch and GCE</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-29 02:41:05" itemprop="dateCreated datePublished" datetime="2019-04-29T02:41:05-07:00">2019-04-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-04-28 19:42:36" itemprop="dateModified" datetime="2019-04-28T19:42:36-07:00">2019-04-28</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">15k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">14 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Introduction-to-Around"><a href="#Introduction-to-Around" class="headerlink" title="Introduction to Around"></a>Introduction to Around</h1><p>Demo: <a href="http://recordit.co/awrQb1zn2I" target="_blank" rel="noopener">http://recordit.co/awrQb1zn2I</a></p>
<p><code>Around</code>: a Geo-index based social network</p>
<p>•    Built a scalable web service in Go to handle posts and deployed to Google Cloud (GAE flex) for better scaling</p>
<p>•    Utilized ElasticSearch (GCE) to provide geo-location based search functions such that users can search nearby posts within a distance (e.g. 200km)</p>
<p>•    Used Google Dataflow to implement a daily dump of posts to BigQuery table for offline analysis</p>
<p>•    Aggregated the data at the post level and user level to improve the keyword based spam detection (BigQuery)</p>
<h1 id="Create-a-new-cloud-project"><a href="#Create-a-new-cloud-project" class="headerlink" title="Create a new cloud project."></a>Create a new cloud project.</h1><p>Step 2.1.1 Open <a href="https://console.cloud.google.com/" target="_blank" rel="noopener">https://console.cloud.google.com/</a> and sign in with your gmail account. </p>
<p>Choose Sign up for free trial, enter a credit card (Must do). GCP has $300 discount for new users, which is enough for project purpose. </p>
<p>Step 2.1.2 Click ‘My Project’. Create a new Project called ‘Around’. Google Cloud will automatically generate a new project id for you. </p>
<h1 id="Geo-Index-and-ElasticSearch"><a href="#Geo-Index-and-ElasticSearch" class="headerlink" title="Geo-Index and ElasticSearch"></a>Geo-Index and ElasticSearch</h1><p>how to perform 1-d range search? For example, given a 1-d binary search tree, find all the values between [3, 18].<br><img src="https://raw.githubusercontent.com/YanpengQi/images/master/ElasticSearch%20and%20GCE-2019-4-28-14-47-57.png" alt="ElasticSearch and GCE-2019-4-28-14-47-57.png"></p>
<p>What about 2d data? </p>
<ul>
<li>Geo index: lat between [10.2, 10.3] and lon between [120.0, 120.5]</li>
<li>Price between [$10, $100], date between [Jan-01-2017, Jun-01-2017]</li>
<li>Weight between [120pb,140pb], height between [150cm, 180cm]</li>
<li>…</li>
</ul>
<p>K-D tree is one implementation to solve such k-dimensional search problem. </p>
<p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/ElasticSearch%20and%20GCE-2019-4-28-14-48-11.png" alt="ElasticSearch and GCE-2019-4-28-14-48-11.png"></p>
<p>Then we choose one median point and split the space into two parts horizontally. </p>
<p> <img src="https://raw.githubusercontent.com/YanpengQi/images/master/ElasticSearch%20and%20GCE-2019-4-28-14-48-18.png" alt="ElasticSearch and GCE-2019-4-28-14-48-18.png"></p>
<p>Continue to split them into more parts (vertically)</p>
<p> <img src="https://raw.githubusercontent.com/YanpengQi/images/master/ElasticSearch%20and%20GCE-2019-4-28-14-48-25.png" alt="ElasticSearch and GCE-2019-4-28-14-48-25.png"></p>
<p>Question: how to find all the points within a Range (R)?</p>
<p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/ElasticSearch%20and%20GCE-2019-4-28-14-48-32.png" alt="ElasticSearch and GCE-2019-4-28-14-48-32.png"></p>
<p>Range Search Algorithm:</p>
<ul>
<li>If query box doesn’t overlap bounding box, stop recursion </li>
<li>If bounding box is a subset of query box, report all the points in current subtree</li>
<li>If bounding box overlaps query box, recurse left and right</li>
</ul>
<p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/ElasticSearch%20and%20GCE-2019-4-28-14-48-40.png" alt="ElasticSearch and GCE-2019-4-28-14-48-40.png"></p>
<h2 id="ELK-ElasticSearch-Logstash-and-Kibana"><a href="#ELK-ElasticSearch-Logstash-and-Kibana" class="headerlink" title="ELK (ElasticSearch, Logstash and Kibana)"></a>ELK (ElasticSearch, Logstash and Kibana)</h2><p><code>Elasticsearch</code> is an open source, distributed, RESTful search engine. As the heart of the Elastic Stack, it centrally stores your data so you can query the data quickly.</p>
<blockquote>
<p>SQL is slower. Since ELK uses a pair to search directly.</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> LOCATIONS <span class="keyword">WHERE</span> lat &lt;= <span class="number">12</span> <span class="keyword">AND</span> lat &gt;= <span class="number">10</span> <span class="keyword">AND</span> lon &gt;= <span class="number">120</span> <span class="keyword">AND</span> lon &lt;= <span class="number">130</span></span><br></pre></td></tr></table></figure>
<h1 id="Google-Compute-Engine-GCE"><a href="#Google-Compute-Engine-GCE" class="headerlink" title="Google Compute Engine (GCE)"></a>Google Compute Engine (GCE)</h1><h2 id="Cloud-Model"><a href="#Cloud-Model" class="headerlink" title="Cloud Model"></a>Cloud Model</h2><ul>
<li>IaaS (Infrastructure as a service)</li>
</ul>
<p>Offers virtual machines (Xen, KVM, VirtualBox, VMware ESX, etc.). Amazon EC2 and Google Compute Engine belong to IaaS as well. </p>
<ul>
<li>PaaS (Platform as a service)</li>
</ul>
<p>computing platform including programming language execution environment, database and web server. Develop and run their software solutions on a cloud platform without the cost and complexity of buying and managing hardware and software layers Microsoft Azure, Google App Engine</p>
<ul>
<li>SaaS (Software as a service)</li>
</ul>
<p>users are provided access to application software and databases.<br>Google Apps, GoToMeeting</p>
<p>The overall structure (tech stack) of our project:</p>
<p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/1.%20Go%20and%20Web%20Service-2019-4-27-13-55-46.png" alt="1. Go and Web Service-2019-4-27-13-55-46.png"></p>
<p><strong>Question</strong>: why we need such a complicated infrastructure</p>
<p><strong>Answer</strong>: because in industry, we need to handle very different requirements compared to in school. </p>
<h2 id="Configure"><a href="#Configure" class="headerlink" title="Configure"></a>Configure</h2><h3 id="Find-NETWORKING-gt-VPC-network-gt-Firewall-rules"><a href="#Find-NETWORKING-gt-VPC-network-gt-Firewall-rules" class="headerlink" title="Find NETWORKING -&gt; VPC network -&gt; Firewall rules"></a>Find NETWORKING -&gt; VPC network -&gt; Firewall rules</h3><p>Click <code>CREATE FIREWALL RULE</code></p>
<p>In the next page, give it a name like <code>‘elasticsearch’</code>. Set the Target tags to be <code>‘es’</code>, source IP ranges to be <code>‘0.0.0.0/0’</code>, and the specified protocols and ports to be <code>‘tcp:9200’</code>. </p>
<p>Wait until the firewall rules is created. </p>
<h3 id="Find-Compute-Engine-gt-VM-instances"><a href="#Find-Compute-Engine-gt-VM-instances" class="headerlink" title="Find Compute Engine-&gt;VM instances"></a>Find Compute Engine-&gt;VM instances</h3><p>Choose ‘Change’ and switch to Ubuntu 16. Keep the size of 10GB is fine. </p>
<p>Then in the Networking -&gt; Network tags, set it to be <code>‘es’</code> (the firewall rule that we created). </p>
<h3 id="After-one-minute-you-will-see-the-instance-is-started-Choose-‘SSH’-and-then-‘Open-in-browser-window’"><a href="#After-one-minute-you-will-see-the-instance-is-started-Choose-‘SSH’-and-then-‘Open-in-browser-window’" class="headerlink" title="After one minute, you will see the instance is started. Choose ‘SSH’ and then ‘Open in browser window’."></a>After one minute, you will see the instance is started. Choose <code>‘SSH’</code> and then ‘Open in browser window’.</h3><h3 id="In-the-terminal-enter"><a href="#In-the-terminal-enter" class="headerlink" title="In the terminal, enter"></a>In the terminal, enter</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install default-jre</span><br></pre></td></tr></table></figure>
<p>It will install java to your vm. To verify, enter <code>‘which java’</code> and <code>‘java -version’</code> to check</p>
<p>Install ElasticSearch as below </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://download.elastic.co/elasticsearch/release/org/elasticsearch/distribution/deb/elasticsearch/2.3.1/elasticsearch-2.3.1.deb</span><br><span class="line">sudo dpkg -i elasticsearch-2.3.1.deb</span><br><span class="line">sudo systemctl enable elasticsearch.service</span><br></pre></td></tr></table></figure>
<p>Edit the configuration file</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/elasticsearch/elasticsearch.yml</span><br></pre></td></tr></table></figure>
<p>Add two lines to the config, to allow all traffic and listen on port 9200.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br></pre></td></tr></table></figure>
<p>Save this and Start ElasticSearch</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service elasticsearch start</span><br></pre></td></tr></table></figure>
<p>Check the status of ElasticSearch<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service elasticsearch status</span><br></pre></td></tr></table></figure></p>
<p>You should be able to see ‘active’ in the status</p>
<p>Back to your console.cloud.google.com, find the public IP address(external)</p>
<p>Put the IP address and port together (:9200) in a new tab and see whether the server is on. The name or version might be different.</p>
<blockquote>
<p>NOTE: Don’t use https! Should use http.</p>
</blockquote>
<p>You should get something like this:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span> : <span class="string">"Honey Lemon"</span>,</span><br><span class="line">  <span class="attr">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</span><br><span class="line">  <span class="attr">"version"</span> : &#123;</span><br><span class="line">    <span class="attr">"number"</span> : <span class="string">"2.3.1"</span>,</span><br><span class="line">    <span class="attr">"build_hash"</span> : <span class="string">"bd980929010aef404e7cb0843e61d0665269fc39"</span>,</span><br><span class="line">    <span class="attr">"build_timestamp"</span> : <span class="string">"2016-04-04T12:25:05Z"</span>,</span><br><span class="line">    <span class="attr">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"lucene_version"</span> : <span class="string">"5.5.0"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Which means your ES server is running as expected. </p>
<h2 id="Update-Go-Code"><a href="#Update-Go-Code" class="headerlink" title="Update Go Code"></a>Update Go Code</h2><h3 id="Update-handlerSearch"><a href="#Update-handlerSearch" class="headerlink" title="Update handlerSearch"></a>Update handlerSearch</h3><p>Original source of codes (<a href="https://olivere.github.io/elastic/" target="_blank" rel="noopener">https://olivere.github.io/elastic/</a>)  </p>
<blockquote>
<p>In here we have to import source code of elastic.(v3)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">To get the package, execute:</span><br><span class="line"></span><br><span class="line">go get gopkg.in/olivere/elastic.v3</span><br><span class="line"></span><br><span class="line">To import this package, add the following line to your code:</span><br><span class="line"></span><br><span class="line">import &quot;gopkg.in/olivere/elastic.v3&quot;</span><br><span class="line"></span><br><span class="line">Refer to it as elastic.</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handlerSearch</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">      fmt.Println(<span class="string">"Received one request for search"</span>)</span><br><span class="line">      lat, _ := strconv.ParseFloat(r.URL.Query().Get(<span class="string">"lat"</span>), <span class="number">64</span>)</span><br><span class="line">      lon, _ := strconv.ParseFloat(r.URL.Query().Get(<span class="string">"lon"</span>), <span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// range is optional </span></span><br><span class="line">      ran := DISTANCE </span><br><span class="line">      <span class="keyword">if</span> val := r.URL.Query().Get(<span class="string">"range"</span>); val != <span class="string">""</span> &#123; </span><br><span class="line">         ran = val + <span class="string">"km"</span> </span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">     fmt.Printf( <span class="string">"Search received: %f %f %s\n"</span>, lat, lon, ran)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Create a client</span></span><br><span class="line">      client, err := elastic.NewClient(elastic.SetURL(ES_URL), elastic.SetSniff(<span class="literal">false</span>))</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">             <span class="built_in">panic</span>(err)</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Define geo distance query as specified in</span></span><br><span class="line">      <span class="comment">// https://www.elastic.co/guide/en/elasticsearch/reference/5.2/query-dsl-geo-distance-query.html</span></span><br><span class="line">      q := elastic.NewGeoDistanceQuery(<span class="string">"location"</span>)</span><br><span class="line">      q = q.Distance(ran).Lat(lat).Lon(lon)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Some delay may range from seconds to minutes. So if you don't get enough results. Try it later.</span></span><br><span class="line">      searchResult, err := client.Search().</span><br><span class="line">             Index(INDEX).</span><br><span class="line">             Query(q).</span><br><span class="line">             Pretty(<span class="literal">true</span>).</span><br><span class="line">             Do()</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">             <span class="comment">// Handle error</span></span><br><span class="line">             <span class="built_in">panic</span>(err)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// searchResult is of type SearchResult and returns hits, suggestions,</span></span><br><span class="line">      <span class="comment">// and all kinds of other information from Elasticsearch.</span></span><br><span class="line">      fmt.Printf(<span class="string">"Query took %d milliseconds\n"</span>, searchResult.TookInMillis)</span><br><span class="line">      <span class="comment">// TotalHits is another convenience function that works even when something goes wrong.</span></span><br><span class="line">      fmt.Printf(<span class="string">"Found a total of %d post\n"</span>, searchResult.TotalHits())</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Each is a convenience function that iterates over hits in a search result.</span></span><br><span class="line">      <span class="comment">// It makes sure you don't need to check for nil values in the response.</span></span><br><span class="line">      <span class="comment">// However, it ignores errors in serialization.</span></span><br><span class="line">      <span class="keyword">var</span> typ Post</span><br><span class="line">      <span class="keyword">var</span> ps []Post</span><br><span class="line">      <span class="keyword">for</span> _, item := <span class="keyword">range</span> searchResult.Each(reflect.TypeOf(typ)) &#123; <span class="comment">// instance of</span></span><br><span class="line">             p := item.(Post) <span class="comment">// p = (Post) item</span></span><br><span class="line">             fmt.Printf(<span class="string">"Post by %s: %s at lat %v and lon %v\n"</span>, p.User, p.Message, p.Location.Lat, p.Location.Lon)</span><br><span class="line">             <span class="comment">// TODO(student homework): Perform filtering based on keywords such as web spam etc.</span></span><br><span class="line">             ps = <span class="built_in">append</span>(ps, p)</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">      js, err := json.Marshal(ps)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">             <span class="built_in">panic</span>(err)</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"application/json"</span>)</span><br><span class="line">      w.Header().Set(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>)</span><br><span class="line">      w.Write(js)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Code-explanation"><a href="#Code-explanation" class="headerlink" title="Code explanation"></a>Code explanation</h2><p>Let’s explain these codes line by line<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client, err := elastic.NewClient(elastic.SetURL(ES_URL), elastic.SetSniff(<span class="literal">false</span>))</span><br></pre></td></tr></table></figure></p>
<p>It means we create a connection to ES. If there is err, return. </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">q := elastic.NewGeoDistanceQuery(<span class="string">"location"</span>)</span><br></pre></td></tr></table></figure>
<p>Prepare a geo based query to find posts within a geo box.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">searchResult, err := client.Search().</span><br><span class="line">             Index(INDEX).</span><br><span class="line">             Query(q).</span><br><span class="line">             Pretty(<span class="literal">true</span>).</span><br><span class="line">             Do()</span><br></pre></td></tr></table></figure>
<p>Get the results based on <code>Index</code> (similar to <code>dataset</code>) and <code>query</code> (<code>q</code> that we just prepared). <code>Pretty</code> means to format the output. </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> _, item := <span class="keyword">range</span> searchResult.Each(reflect.TypeOf(typ)) &#123;</span><br></pre></td></tr></table></figure>
<p>Iterate the result in results which are type of Post (typ)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p := item.(Post)</span><br></pre></td></tr></table></figure>
<p>Cast an item to Post, equals to <code>p = (Post) item</code>  in java</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps = <span class="built_in">append</span>(ps, p)</span><br></pre></td></tr></table></figure>
<p>Add the p to an array, equals <code>ps.add(p)</code> in java</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">js, err := json.Marshal(ps)</span><br></pre></td></tr></table></figure>
<p>Convert the go object(array) to a string<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">w.Header().Set(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>)</span><br></pre></td></tr></table></figure></p>
<p>Allow cross domain visit for javascript.</p>
<p>We also need to put ES library in import<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">      elastic <span class="string">"gopkg.in/olivere/elastic.v3"</span></span><br><span class="line">      <span class="string">"fmt"</span></span><br><span class="line">      <span class="string">"net/http"</span></span><br><span class="line">      <span class="string">"encoding/json"</span></span><br><span class="line">      <span class="string">"log"</span></span><br><span class="line">      <span class="string">"strconv"</span></span><br><span class="line">      <span class="string">"reflect"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>Add const before main function</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">      INDEX = <span class="string">"around"</span></span><br><span class="line">      TYPE = <span class="string">"post"</span></span><br><span class="line">      DISTANCE = <span class="string">"200km"</span></span><br><span class="line">      <span class="comment">// Needs to update</span></span><br><span class="line">      <span class="comment">//PROJECT_ID = "around-xxx"</span></span><br><span class="line">      <span class="comment">//BT_INSTANCE = "around-post"</span></span><br><span class="line">      <span class="comment">// Needs to update this URL if you deploy it to cloud.</span></span><br><span class="line">      ES_URL = <span class="string">"http://YOUR_ES_IP_ADDRESS:9200"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">      fmt.Println(<span class="string">"started-service"</span>)</span><br><span class="line">      http.HandleFunc(<span class="string">"/post"</span>, handlerPost)</span><br><span class="line">      http.HandleFunc(<span class="string">"/search"</span>, handlerSearch)</span><br><span class="line">      log.Fatal(http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Replace <code>YOUR_ES_IP_ADDRESS</code> with your ES address (public IP).</p>
<blockquote>
<p><a href="http://externalIp:9200" target="_blank" rel="noopener">http://externalIp:9200</a></p>
</blockquote>
<p>Step 2.2.5 Open your terminal (Mac and Windows). Enter</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get  gopkg.in/olivere/elastic.v3</span><br></pre></td></tr></table></figure>
<p>Once it is done, you won’t be able to see any more compile errors in Intellij. If it does not work (elastic is still red), try to restart it. </p>
<p>More readings</p>
<ul>
<li>Reflect type <a href="https://golang.org/pkg/reflect/" target="_blank" rel="noopener">https://golang.org/pkg/reflect/</a> </li>
<li>ES in Go <a href="https://github.com/olivere/elastic" target="_blank" rel="noopener">https://github.com/olivere/elastic</a> </li>
</ul>
<p>Step 2.2.6 In order to create index in ES, we need to update main</p>
<p><strong>What’s mapping in ES?</strong> It tells you what’s the type of a variable if not default.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// Create a client</span></span><br><span class="line">	client, err := elastic.NewClient(elastic.SetURL(ES_URL), elastic.SetSniff(<span class="literal">false</span>))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Use the IndexExists service to check if a specified index exists.</span></span><br><span class="line">	exists, err := client.IndexExists(INDEX).Do()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> !exists &#123;</span><br><span class="line">		<span class="comment">// Create a new index.</span></span><br><span class="line">		mapping := <span class="string">`&#123;</span></span><br><span class="line"><span class="string">			"mappings":&#123;</span></span><br><span class="line"><span class="string">				"post":&#123;</span></span><br><span class="line"><span class="string">					"properties":&#123;</span></span><br><span class="line"><span class="string">						"location":&#123;</span></span><br><span class="line"><span class="string">							"type":"geo_point"</span></span><br><span class="line"><span class="string">						&#125;</span></span><br><span class="line"><span class="string">					&#125;</span></span><br><span class="line"><span class="string">				&#125;</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;`</span></span><br><span class="line">		_, err := client.CreateIndex(INDEX).Body(mapping).Do()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="comment">// Handle error</span></span><br><span class="line">			<span class="built_in">panic</span>(err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">"started-service"</span>)</span><br><span class="line">	http.HandleFunc(<span class="string">"/post"</span>, handlerPost)</span><br><span class="line">	http.HandleFunc(<span class="string">"/search"</span>, handlerSearch)</span><br><span class="line">	log.Fatal(http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exists, err := client.IndexExists(INDEX).Do()</span><br></pre></td></tr></table></figure>
<p>Check if the index exists. </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mapping := <span class="string">`&#123;</span></span><br><span class="line"><span class="string">                    "mappings":&#123;</span></span><br><span class="line"><span class="string">                           "post":&#123;</span></span><br><span class="line"><span class="string">                                  "properties":&#123;</span></span><br><span class="line"><span class="string">                                         "location":&#123;</span></span><br><span class="line"><span class="string">                                                "type":"geo_point"</span></span><br><span class="line"><span class="string">                                         &#125;</span></span><br><span class="line"><span class="string">                                  &#125;</span></span><br><span class="line"><span class="string">                           &#125;</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br></pre></td></tr></table></figure>
<p>If not, create a new mapping. For other fields (user, message, etc.) no need to have mapping as they are default. For geo location (lat, lon), we need to tell ES that they are geo points instead of two float points such that ES will use Geo-indexing for them (K-D tree)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_, err := client.CreateIndex(INDEX).Body(mapping).Do()</span><br></pre></td></tr></table></figure>
<p>Create this index</p>
<p>More readings</p>
<ul>
<li>ES in Go <a href="https://github.com/olivere/elastic" target="_blank" rel="noopener">https://github.com/olivere/elastic</a> </li>
<li>Mapping in ES <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html</a> </li>
</ul>
<p>Step 2.2.7 Update handlerPost</p>
<p>Add external import of uuid</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">      elastic <span class="string">"gopkg.in/olivere/elastic.v3"</span></span><br><span class="line">      <span class="string">"fmt"</span></span><br><span class="line">      <span class="string">"net/http"</span></span><br><span class="line">      <span class="string">"encoding/json"</span></span><br><span class="line">      <span class="string">"log"</span></span><br><span class="line">      <span class="string">"strconv"</span></span><br><span class="line">      <span class="string">"reflect"</span></span><br><span class="line">      <span class="string">"github.com/pborman/uuid"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>How to add a new document to the index?</p>
<p><a href="https://github.com/olivere/elastic" target="_blank" rel="noopener">https://github.com/olivere/elastic</a> has an example</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add a document to the index</span></span><br><span class="line"><span class="comment">// Refresh(true) means if duplicate appears, overwrite it</span></span><br><span class="line">tweet := Tweet&#123;User: <span class="string">"olivere"</span>, Message: <span class="string">"Take Five"</span>&#125;</span><br><span class="line">_, err = client.Index().</span><br><span class="line">    Index(<span class="string">"twitter"</span>).</span><br><span class="line">    Type(<span class="string">"tweet"</span>).</span><br><span class="line">    Id(<span class="string">"1"</span>).</span><br><span class="line">    BodyJson(tweet).</span><br><span class="line">    Refresh(<span class="literal">true</span>).</span><br><span class="line">    Do(ctx)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// Handle error</span></span><br><span class="line">    <span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Student Question: how to complete this one?</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handlerPost</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">      <span class="comment">// Parse from body of request to get a json object.</span></span><br><span class="line">      fmt.Println(<span class="string">"Received one post request"</span>)</span><br><span class="line">      decoder := json.NewDecoder(r.Body)</span><br><span class="line">      <span class="keyword">var</span> p Post</span><br><span class="line">      <span class="keyword">if</span> err := decoder.Decode(&amp;p); err != <span class="literal">nil</span> &#123;</span><br><span class="line">             <span class="built_in">panic</span>(err)</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      id := uuid.New()</span><br><span class="line">      <span class="comment">// Save to ES.</span></span><br><span class="line">      saveToES(&amp;p, id)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Save a post to ElasticSearch</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">saveToES</span><span class="params">(p *Post, id <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">// Create a client</span></span><br><span class="line">	es_client, err := elastic.NewClient(elastic.SetURL(ES_URL), elastic.SetSniff(<span class="literal">false</span>))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Save it to index</span></span><br><span class="line">	_, err = es_client.Index().</span><br><span class="line">		Index(INDEX).</span><br><span class="line">		Type(TYPE).</span><br><span class="line">		Id(id).</span><br><span class="line">		BodyJson(p).</span><br><span class="line">		Refresh(<span class="literal">true</span>).</span><br><span class="line">		Do()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">"Post is saved to Index: %s\n"</span>, p.Message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Step 2.2.8 Open terminal, enter</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/pborman/uuid</span><br></pre></td></tr></table></figure>
<p>Make sure your ES_URL is updated from your aws instance in step 1.</p>
<p>Step 2.2.9 Run your main.go again</p>
<h2 id="Errors"><a href="#Errors" class="headerlink" title="Errors"></a>Errors</h2><p>If you have such an error, your ES_URL is incorrect.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">panic: no Elasticsearch node available</span><br></pre></td></tr></table></figure>
<p>If you have such error, you have started two <code>main.go</code>, stop the other one.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2017/06/30 07:07:01 listen tcp :8080: bind: Only one usage of each socket address (protocol/network address/port) is normally permitted.</span><br><span class="line">exit status 1</span><br></pre></td></tr></table></figure>
<p>If you have such error, you forgot to comment one line <code>fmt.Fprintf(w, &quot;Search received: %s %s %s&quot;, lat, lon, ran)</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Search received: %!s(float64=37.4) %...</span><br></pre></td></tr></table></figure>
<p>Step 2.2.10 Open Postman, find the post query from history. (POST, <a href="http://localhost:8080/post" target="_blank" rel="noopener">http://localhost:8080/post</a>)</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"user"</span>:<span class="string">"1111"</span>,</span><br><span class="line">	<span class="attr">"message"</span>:<span class="string">"一生必去的100个地方"</span>,</span><br><span class="line">	<span class="attr">"location"</span>:&#123;</span><br><span class="line">		<span class="attr">"lat"</span>:<span class="number">37.5</span>,</span><br><span class="line">		<span class="attr">"lon"</span>:<span class="number">-120.1</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And then find the get query from history. (GET, url=<a href="http://localhost:8080/search?lat=37.5&amp;lon=-120" target="_blank" rel="noopener">http://localhost:8080/search?lat=37.5&amp;lon=-120</a>)<br>You should get the results back</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"user"</span>: <span class="string">"1111"</span>,</span><br><span class="line">        <span class="attr">"message"</span>: <span class="string">"一生必去的100个地方"</span>,</span><br><span class="line">        <span class="attr">"location"</span>: &#123;</span><br><span class="line">            <span class="attr">"lat"</span>: <span class="number">37.5</span>,</span><br><span class="line">            <span class="attr">"lon"</span>: <span class="number">-120.1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>Post more examples with different locations and then get with different lat/lon to see how many results you may get. If you have zero result back and no error, probably your geo location is wrong.</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/28/Go Basic & Around project/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yanpeng Luo">
      <meta itemprop="description" content="Notes of study, work and life">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yanpeng">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/28/Go Basic & Around project/" class="post-title-link" itemprop="url">Go Basic &amp; Around project</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-28 20:25:31 / Modified: 13:26:45" itemprop="dateCreated datePublished" datetime="2019-04-28T20:25:31-07:00">2019-04-28</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">8.6k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">8 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Project-Introduction"><a href="#Project-Introduction" class="headerlink" title="Project Introduction"></a>Project Introduction</h1><p><strong>Around</strong>: a Geo-index based social network</p>
<p>•    Built a scalable web service in Go to handle posts and deployed to Google Cloud (GAE flex) for better scaling</p>
<p>•    Utilized ElasticSearch (GCE) to provide geo-location based search functions such that users can search nearby posts within a distance (e.g. 200km)</p>
<p>•    Used Google Dataflow to implement a daily dump of posts to BigQuery table for offline analysis</p>
<p>•    Aggregated the data at the post level and user level to improve the keyword based spam detection (BigQuery)</p>
<p><strong><code>constants.js</code></strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export const API_ROOT = &apos;https://around-75015.appspot.com&apos;;</span><br><span class="line">export const TOKEN_KEY = &apos;TOKEN&apos;;</span><br><span class="line">export const AUTH_PREFIX = &apos;Bearer&apos;;</span><br></pre></td></tr></table></figure></p>
<p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/1.%20Go%20and%20Web%20Service-2019-4-27-13-55-46.png" alt="1. Go and Web Service-2019-4-27-13-55-46.png"></p>
<h1 id="Why-we-need-to-learn-about-Go"><a href="#Why-we-need-to-learn-about-Go" class="headerlink" title="Why we need to learn about Go?"></a>Why we need to learn about Go?</h1><p><strong>Answer</strong>: server language for next generation (both computer friendly and developer friendly)</p>
<h2 id="Who-is-using-Golang"><a href="#Who-is-using-Golang" class="headerlink" title="Who is using Golang"></a>Who is using Golang</h2><ul>
<li>Google (Creator), Uber, AirBnb</li>
<li>Dropbox, Facebook, eBay, Heroku, Douban, Jingdong, Meituan</li>
</ul>
<p>As opposed to Java, Go is compiled to machine code and is executed directly. Much like C. </p>
<p>Go example</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">f, err := os.Open(<span class="string">"filename.ext"</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Other benefits</p>
<ul>
<li>Multiple return values</li>
<li>Multi-threading<ul>
<li>Go Routine</li>
<li>Channels</li>
</ul>
</li>
<li>Has borrowed many good ideas from python</li>
</ul>
<p>Python is really easy to break.</p>
<ul>
<li>Does not compile. You will never know it breaks until it breaks.</li>
<li>Language is confusing.</li>
<li>Good for testing and evaluation with many excellent machine learning libraries.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = set([<span class="string">'hippo'</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a</span><br><span class="line">set([<span class="string">'hippo'</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a = set(<span class="string">'hippo'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a</span><br><span class="line">set([<span class="string">'h'</span>, <span class="string">'i'</span>, <span class="string">'p'</span>, <span class="string">'o'</span>])</span><br></pre></td></tr></table></figure>
<h1 id="Setup-Local-Environment-Go"><a href="#Setup-Local-Environment-Go" class="headerlink" title="Setup Local Environment (Go)"></a>Setup Local Environment (Go)</h1><p>Make sure you have installed Go based on Prerequisite.<br>Mac Users (Windows User wait a minute)</p>
<p>Step 1.1.1 Open Terminal, enter</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go version</span><br></pre></td></tr></table></figure>
<p>It should show something like <code>go version go1.10.2 darwin/amd64</code>.</p>
<p>Step 1.1.2(Optional: GOPATH default to ~/go) In the same Terminal, enter</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/go</span><br><span class="line"><span class="built_in">echo</span> <span class="built_in">export</span> GOPATH=~/go &gt;&gt; ~/.bash_profile</span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$GOPATH</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>In here we must not overwrite the bin of go, add <code>export PATH=$PATH:/usr/local/go/bin to .bash_profile and update zsh profile</code></p>
</blockquote>
<p>Step 1.1.3 In the same Terminal, enter</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p  ~/Documents/Around/service</span><br><span class="line"><span class="built_in">cd</span>  ~/Documents/Around/service</span><br><span class="line">vim main.go</span><br></pre></td></tr></table></figure>
<p>Step 1.1.4 Type ‘a’ or ‘i’ and then copy a hello world program into main.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">"Hello, world"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Step 1.1.5 Exit with <code>:wq</code> , in the terminal, type</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run main.go</span><br></pre></td></tr></table></figure>
<p>You should be able to see the output of <code>“Hello, world”</code></p>
<h1 id="First-Go-program"><a href="#First-Go-program" class="headerlink" title="First Go program"></a>First Go program</h1><p>First, we need to define some objects in a Go program to represent the data we store. </p>
<p>Step 1.3.1 let’s define the struct for post and location. </p>
<p>Encode json object (<a href="https://golang.org/pkg/encoding/json/" target="_blank" rel="noopener">https://golang.org/pkg/encoding/json/</a>)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Location <span class="keyword">struct</span> &#123;</span><br><span class="line">      Lat <span class="keyword">float64</span> <span class="string">`json:"lat"`</span></span><br><span class="line">      Lon <span class="keyword">float64</span> <span class="string">`json:"lon"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Post <span class="keyword">struct</span> &#123;</span><br><span class="line">      <span class="comment">// `json:"user"` is for the json parsing of this User field. Otherwise, by default it's 'User'.</span></span><br><span class="line">      User     <span class="keyword">string</span> <span class="string">`json:"user"`</span></span><br><span class="line">      Message  <span class="keyword">string</span>  <span class="string">`json:"message"`</span></span><br><span class="line">      Location Location <span class="string">`json:"location"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">      fmt.Println(<span class="string">"Hello, world"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Step 1.3.2 Add one method <code>handlerPost()</code> after <code>main()</code> to handle Post. </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">      fmt.Println(<span class="string">"Hello, world"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handlerPost</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">      <span class="comment">// Parse from body of request to get a json object.</span></span><br><span class="line">      fmt.Println(<span class="string">"Received one post request"</span>)</span><br><span class="line">      decoder := json.NewDecoder(r.Body)</span><br><span class="line">      <span class="keyword">var</span> p Post</span><br><span class="line">      <span class="keyword">if</span> err := decoder.Decode(&amp;p); err != <span class="literal">nil</span> &#123;</span><br><span class="line">             <span class="built_in">panic</span>(err)</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      fmt.Fprintf(w, <span class="string">"Post received: %s\n"</span>, p.Message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>In here if you add rawString <code>json:&quot;lat&quot;</code> after variable, it will parse it automatically</p>
</blockquote>
<p>What does this method do? If user sends a http request with a body as</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  “user”: “jack”</span><br><span class="line">  “message”: “this is a message”</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Then it will automatically construct a Post object named <code>p</code> and update its values to be <code>p.User = “jack”</code> and <code>p.Message = “this  is a message”</code></p>
<p><code>Fmt</code> <code>%s</code> means string</p>
<p>Just one line of code to decode json object into go object. In comparison, if you do it in java. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">JSONObject venue = getVenue(event);</span><br><span class="line">      <span class="keyword">if</span> (venue != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!venue.isNull(<span class="string">"address"</span>)) &#123;</span><br><span class="line">          JSONObject address = venue.getJSONObject(<span class="string">"address"</span>);</span><br><span class="line">          StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">          <span class="keyword">if</span> (!address.isNull(<span class="string">"line1"</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            sb.append(address.getString(<span class="string">"line1"</span>));</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (!address.isNull(<span class="string">"line2"</span>)) &#123;</span><br><span class="line">            sb.append(address.getString(<span class="string">"line2"</span>));</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (!address.isNull(<span class="string">"line3"</span>)) &#123;</span><br><span class="line">            sb.append(address.getString(<span class="string">"line3"</span>));</span><br><span class="line">          &#125;</span><br><span class="line">          builder.setAddress(sb.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!venue.isNull(<span class="string">"city"</span>)) &#123;</span><br><span class="line">          JSONObject city = venue.getJSONObject(<span class="string">"city"</span>);</span><br><span class="line">          builder.setCity(getStringFieldOrNull(city, <span class="string">"name"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!venue.isNull(<span class="string">"country"</span>)) &#123;</span><br><span class="line">          JSONObject country = venue.getJSONObject(<span class="string">"country"</span>);</span><br><span class="line">          builder.setCountry(getStringFieldOrNull(country, <span class="string">"name"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!venue.isNull(<span class="string">"state"</span>)) &#123;</span><br><span class="line">          JSONObject state = venue.getJSONObject(<span class="string">"state"</span>);</span><br><span class="line">          builder.setState(getStringFieldOrNull(state, <span class="string">"name"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        builder.setZipcode(getStringFieldOrNull(venue, <span class="string">"postalCode"</span>));</span><br><span class="line">        <span class="keyword">if</span> (!venue.isNull(<span class="string">"location"</span>)) &#123;</span><br><span class="line">          JSONObject location = venue.getJSONObject(<span class="string">"location"</span>);</span><br><span class="line">          builder.setLatitude(getNumericFieldOrNull(location, <span class="string">"latitude"</span>));</span><br><span class="line">          builder.setLongitude(getNumericFieldOrNull(location, <span class="string">"longitude"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>Step 1.3.3 Replace main function to call handlerPost when started. Final version:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">      <span class="string">"fmt"</span></span><br><span class="line">      <span class="string">"net/http"</span></span><br><span class="line">      <span class="string">"encoding/json"</span></span><br><span class="line">      <span class="string">"log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">      fmt.Println(<span class="string">"started-service"</span>)</span><br><span class="line">      http.HandleFunc(<span class="string">"/post"</span>, handlerPost)</span><br><span class="line">      log.Fatal(http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Step 1.3.5 Open your postman,<br>Choose ‘POST’, the url is <a href="http://localhost:8080/post" target="_blank" rel="noopener">http://localhost:8080/post</a>, in the request body, enter<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">"user"</span>:<span class="string">"1111"</span>,</span><br><span class="line">	<span class="attr">"message"</span>:<span class="string">"一生必去的100个地方"</span>,</span><br><span class="line">	<span class="attr">"location"</span>:&#123;</span><br><span class="line">		<span class="attr">"lat"</span>:<span class="number">37.5</span>,</span><br><span class="line">		<span class="attr">"lon"</span>:<span class="number">-120.1</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Click ‘Send’, you should be able to see a response with</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Post received: 一生必去的100个地方</span><br></pre></td></tr></table></figure>
<p>Add another handler for <code>search</code> (called it <code>handlerSearch</code>), the request has a url pattern like<br><a href="http://localhost:8080/search?lat=10.0&amp;lon=20.0" target="_blank" rel="noopener">http://localhost:8080/search?lat=10.0&amp;lon=20.0</a>. Parse it and then print out the lat and lon.</p>
<p>Note: to get request parameters from url</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lat := r.URL.Query().Get(<span class="string">"lat"</span>)</span><br></pre></td></tr></table></figure>
<p>Step 1.3.6 Answer<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">      fmt.Println(<span class="string">"started-service"</span>)</span><br><span class="line">      http.HandleFunc(<span class="string">"/post"</span>, handlerPost)</span><br><span class="line">      http.HandleFunc(<span class="string">"/search"</span>, handlerSearch)</span><br><span class="line">      log.Fatal(http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handlerSearch</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">      fmt.Println(<span class="string">"Received one request for search"</span>)</span><br><span class="line">      lat := r.URL.Query().Get(<span class="string">"lat"</span>)</span><br><span class="line">      lon := r.URL.Query().Get(<span class="string">"lon"</span>)</span><br><span class="line"></span><br><span class="line">      fmt.Fprintf(w, <span class="string">"Search received: %s %s"</span>, lat, lon)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Step 1.3.7  return a JSON object. Change handlerSearch to be</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Import (</span><br><span class="line">      …</span><br><span class="line">      <span class="string">"strconv"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">      DISTANCE = <span class="string">"200km"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handlerSearch</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">      fmt.Println(<span class="string">"Received one request for search"</span>)</span><br><span class="line">      lat, _ := strconv.ParseFloat(r.URL.Query().Get(<span class="string">"lat"</span>), <span class="number">64</span>)</span><br><span class="line">      lon, _ := strconv.ParseFloat(r.URL.Query().Get(<span class="string">"lon"</span>), <span class="number">64</span>)</span><br><span class="line">      <span class="comment">// range is optional </span></span><br><span class="line">      ran := DISTANCE </span><br><span class="line">      <span class="keyword">if</span> val := r.URL.Query().Get(<span class="string">"range"</span>); val != <span class="string">""</span> &#123; </span><br><span class="line">         ran = val + <span class="string">"km"</span> </span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      fmt.Println(<span class="string">"range is "</span>, ran)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Return a fake post</span></span><br><span class="line">      p := &amp;Post&#123;</span><br><span class="line">             User:<span class="string">"1111"</span>,</span><br><span class="line">             Message:<span class="string">"一生必去的100个地方"</span>,</span><br><span class="line">             Location: Location&#123;</span><br><span class="line">                    Lat:lat,</span><br><span class="line">                    Lon:lon,</span><br><span class="line">             &#125;,</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      js, err := json.Marshal(p)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">             <span class="built_in">panic</span>(err)</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"application/json"</span>)</span><br><span class="line">      w.Write(js)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在Go里面，变量必须得用到，不然会报错，除非用下划线做变量名</p>
</blockquote>
<p>Step 1.3.8 Open Postman, url is <a href="http://localhost:8080/search?lat=10.0&amp;lon=20.0&amp;range=300" target="_blank" rel="noopener">http://localhost:8080/search?lat=10.0&amp;lon=20.0&amp;range=300</a> click send again. You should see something like this</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"user"</span>: <span class="string">"1111"</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"一生必去的100个地方"</span>,</span><br><span class="line">    <span class="attr">"location"</span>: &#123;</span><br><span class="line">        <span class="attr">"lat"</span>: <span class="number">10</span>,</span><br><span class="line">        <span class="attr">"lon"</span>: <span class="number">20</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/28/[Notes] Git notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yanpeng Luo">
      <meta itemprop="description" content="Notes of study, work and life">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yanpeng">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/28/[Notes] Git notes/" class="post-title-link" itemprop="url">[Notes] Git notes</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-28 00:02:06 / Modified: 10:55:50" itemprop="dateCreated datePublished" datetime="2019-04-28T00:02:06-07:00">2019-04-28</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">512</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">1 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Create-a-remote-repository-and-push"><a href="#Create-a-remote-repository-and-push" class="headerlink" title="Create a remote repository and push"></a>Create a remote repository and push</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br><span class="line">git add .</span><br><span class="line">git commit -am &apos;init&apos;</span><br><span class="line"></span><br><span class="line">git config --local user.name username</span><br><span class="line">git config --local user.email email</span><br><span class="line"></span><br><span class="line">git config --list   //check config</span><br><span class="line"></span><br><span class="line">git config --local core.ignorecase false // turn case sensitivity off</span><br><span class="line"></span><br><span class="line">// use http to connect</span><br><span class="line">curl -u username https://api.github.com/user/repos -d &apos;&#123;&quot;name&quot;:&quot;RepoName&quot;&#125;&apos;</span><br><span class="line"></span><br><span class="line">// update</span><br><span class="line">git remote add origin git@github.com:username/RepoName.git </span><br><span class="line"></span><br><span class="line">git push origin master</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/18/[Notes] Cloud Computing Basic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yanpeng Luo">
      <meta itemprop="description" content="Notes of study, work and life">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yanpeng">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/18/[Notes] Cloud Computing Basic/" class="post-title-link" itemprop="url">[Notes] Cloud Computing Basic</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-18 19:26:54 / Modified: 12:28:15" itemprop="dateCreated datePublished" datetime="2019-04-18T19:26:54-07:00">2019-04-18</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">11k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">10 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Implement-verifyLogin-and-getFullname"><a href="#Implement-verifyLogin-and-getFullname" class="headerlink" title="Implement verifyLogin and getFullname"></a>Implement verifyLogin and getFullname</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Get the first name and last name and concat them to full name, given the userId</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getFullname</span><span class="params">(String userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    String name = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String sql = <span class="string">"SELECT first_name, last_name FROM users WHERE user_id = ?"</span>;</span><br><span class="line">        PreparedStatement stmt = conn.prepareStatement(sql);</span><br><span class="line">        stmt.setString(<span class="number">1</span>, userId);</span><br><span class="line">        ResultSet res = stmt.executeQuery();</span><br><span class="line">        <span class="keyword">if</span> (res.next()) name = String.join(<span class="string">" "</span>, res.getString(<span class="string">"first_name"</span>), res.getString(<span class="string">"last_name"</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Verify the userId and password</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">verifyLogin</span><span class="params">(String userId, String password)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (conn == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String sql = <span class="string">"SELECT user_id FROM users WHERE user_id = ? AND password = ?"</span>;</span><br><span class="line">        PreparedStatement stmt = conn.prepareStatement(sql);</span><br><span class="line">        stmt.setString(<span class="number">1</span>, userId);</span><br><span class="line">        stmt.setString(<span class="number">2</span>, password);</span><br><span class="line">        ResultSet res = stmt.executeQuery();</span><br><span class="line">        <span class="keyword">if</span> (res.next()) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Make-search-result-aware-of-favorite-history"><a href="#Make-search-result-aware-of-favorite-history" class="headerlink" title="Make search result aware of favorite history"></a>Make search result aware of favorite history</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * get the info from request, query, and response</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    </span><br><span class="line">    String userId = request.getParameter(<span class="string">"user_id"</span>);</span><br><span class="line">    <span class="keyword">double</span> lat = Double.parseDouble(request.getParameter(<span class="string">"lat"</span>));</span><br><span class="line">    <span class="keyword">double</span> lon = Double.parseDouble(request.getParameter(<span class="string">"lon"</span>));</span><br><span class="line">    </span><br><span class="line">    String keyword = request.getParameter(<span class="string">"term"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Connect db first</span></span><br><span class="line">    DBConnection conn = DBConnectionFactory.getConnection();</span><br><span class="line">    List&lt;Item&gt; items = conn.searchItems(lat, lon, keyword);</span><br><span class="line">    </span><br><span class="line">    Set&lt;String&gt; favorite = conn.getFavoriteItemIds(userId);</span><br><span class="line">    conn.close();</span><br><span class="line">    </span><br><span class="line">    JSONArray array = <span class="keyword">new</span> JSONArray();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Item item : items) &#123;</span><br><span class="line">            JSONObject obj = item.toJSONObject();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// check if current item is a favorite item</span></span><br><span class="line">            <span class="comment">// this field is required by front end to control the fav status</span></span><br><span class="line">            obj.put(<span class="string">"favorite"</span>, favorite.contains(item.getItemId()));</span><br><span class="line">            array.put(obj);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    RpcHelper.writeJSONArray(response, array);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="What’s-Cloud-Computing"><a href="#What’s-Cloud-Computing" class="headerlink" title="What’s Cloud Computing"></a>What’s Cloud Computing</h1><p>Cloud computing is the delivery of on-demand computing resources—everything from applications to data centers—over the Internet on a pay-for-use basis.</p>
<p>Since 2006 when Amazon introduced the Elastic Compute Cloud</p>
<p>Features:</p>
<ul>
<li>scalability,</li>
<li>flexibility,</li>
<li>on-demand,</li>
<li>reduced labor cost and data center cost, handled by SREs</li>
</ul>
<p>Bad</p>
<ul>
<li>data safety and privacy</li>
<li>cannot control downtime</li>
</ul>
<p>Types</p>
<ul>
<li>private cloud (VMware)</li>
<li>public cloud (Microsoft Azure, Google App Engine, Amazon EC2)</li>
<li>hybrid cloud</li>
</ul>
<h1 id="Amazon-EC2"><a href="#Amazon-EC2" class="headerlink" title="Amazon EC2"></a>Amazon EC2</h1><h2 id="Elastic-Compute-Cloud-EC2"><a href="#Elastic-Compute-Cloud-EC2" class="headerlink" title="Elastic Compute Cloud (EC2)"></a>Elastic Compute Cloud (EC2)</h2><p>EC2 allows scalable deployment of applications by providing a Web service through which a user can boot an Amazon Machine Image to create a virtual machine, which Amazon calls an “instance”, containing any software desired. A user can create, launch, and terminate server instances as needed, paying by the hour for active servers, hence the term “elastic”.</p>
<h2 id="Launch-an-instance-Ubuntu-linux"><a href="#Launch-an-instance-Ubuntu-linux" class="headerlink" title="Launch an instance (Ubuntu linux)"></a>Launch an instance (Ubuntu linux)</h2><p>Step 1, go to <a href="http://aws.amazon.com" target="_blank" rel="noopener">http://aws.amazon.com</a>, sign into your account and then open EC2 dashboard. Launch an instance.</p>
<p>Step 2, Select the Ubuntu Server 16.04 image.</p>
<p>Step 3, Use t2.micro as instance, which is free tier eligible. Click next instead of launch.</p>
<p>Step 4, Jump to security group setup. You need to add 2 more TCP ports: 80, 8080.</p>
<p>Step 5, Click Launch, you will be asked to create a new key pair and download the private key. You can name it as mykey.pem</p>
<h2 id="Connect-to-the-instance"><a href="#Connect-to-the-instance" class="headerlink" title="Connect to the instance"></a>Connect to the instance</h2><h3 id="Mac"><a href="#Mac" class="headerlink" title="Mac"></a>Mac</h3><p>Open your terminal, run:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 600 ~/Downloads/mykey.pem</span><br><span class="line">ssh -i ~/Downloads/mykey.pem ubuntu@YOUR_INSTANCE_IP</span><br></pre></td></tr></table></figure></p>
<p>if asked “Are you sure you want to continue connecting (yes/no)? ”, type “yes”, enter.</p>
<p>You are now on the remote server, you can play with Linux commands. <code>hostname, ifconfig, whoami, uptime, pwd, ls</code></p>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>Windows (Putty)</p>
<ul>
<li><p>Download Putty and Puttygen from <a href="https://the.earth.li/~sgtatham/putty/latest/x86/putty.zip" target="_blank" rel="noopener">https://the.earth.li/~sgtatham/putty/latest/x86/putty.zip</a> </p>
</li>
<li><p>Open Puttygen,  “Conversions”-&gt;”Import key”, select mykey.pem file, Save private key as mykey.ppk</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/14.%20Cloud%20Computing-2019-4-17-20-13-19.png" alt="14. Cloud Computing-2019-4-17-20-13-19.png"></p>
<ul>
<li>Open Putty, enter host ip, in SSH-&gt;Auth, choose your ppk file</li>
</ul>
<p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/14.%20Cloud%20Computing-2019-4-17-20-13-30.png" alt="14. Cloud Computing-2019-4-17-20-13-30.png"></p>
<ul>
<li>Click Open, enter the username ubuntu</li>
</ul>
<p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/14.%20Cloud%20Computing-2019-4-17-20-13-42.png" alt="14. Cloud Computing-2019-4-17-20-13-42.png"></p>
<h2 id="Install-Java"><a href="#Install-Java" class="headerlink" title="Install Java"></a>Install Java</h2><p>Step 1, In your instance’s terminal, execute the following commands:</p>
<ul>
<li>sudo apt-get update</li>
<li>sudo apt-get install default-jre</li>
</ul>
<p>Step 2, You can verify with</p>
<ul>
<li>java -version</li>
</ul>
<h2 id="Install-MySQL"><a href="#Install-MySQL" class="headerlink" title="Install MySQL"></a>Install MySQL</h2><p>Step 1, sudo apt-get install mysql-server. When you are asked for new mysql password, use “root”.</p>
<p>Step 2, after installation, type <code>mysql -u root -p</code> in your terminal, then input the “root” as password.</p>
<p>Step 3, In the mysql shell, paste the following SQL statements to install the tables:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">DATABASE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> myproject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> myproject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">USE</span> myproject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> items (item_id <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>, <span class="keyword">name</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>), rating <span class="built_in">FLOAT</span>, address <span class="built_in">VARCHAR</span>(<span class="number">255</span>), image_url <span class="built_in">VARCHAR</span>(<span class="number">255</span>), <span class="keyword">url</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>), distance <span class="built_in">FLOAT</span>, PRIMARY <span class="keyword">KEY</span> ( item_id));</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> categories (item_id <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>, <span class="keyword">category</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>, PRIMARY <span class="keyword">KEY</span> ( item_id, <span class="keyword">category</span>), <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (item_id) <span class="keyword">REFERENCES</span> items(item_id));    </span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">users</span> (user_id <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>, <span class="keyword">password</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>, first_name <span class="built_in">VARCHAR</span>(<span class="number">255</span>), last_name <span class="built_in">VARCHAR</span>(<span class="number">255</span>), PRIMARY <span class="keyword">KEY</span> ( user_id ));</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> history (user_id <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>, item_id <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>, last_favor_time <span class="built_in">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span>, PRIMARY <span class="keyword">KEY</span> (user_id, item_id), <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (item_id) <span class="keyword">REFERENCES</span> items(item_id), <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (user_id) <span class="keyword">REFERENCES</span> <span class="keyword">users</span>(user_id));</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">users</span> <span class="keyword">VALUES</span> (<span class="string">"1111"</span>, <span class="string">"3229c1097c00d497a0fd282d586be050"</span>, <span class="string">"John"</span>, <span class="string">"Smith"</span>);</span><br></pre></td></tr></table></figure>
<p>Step 4, Type “exit” to quit mysql shell.</p>
<h2 id="Install-Tomcat-9"><a href="#Install-Tomcat-9" class="headerlink" title="Install Tomcat 9"></a>Install Tomcat 9</h2><p>Step 1, Execute the following commands<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/</span><br><span class="line">sudo wget http://apache.mirrors.hoobly.com/tomcat/tomcat-9/v9.0.19/bin/apache-tomcat-9.0.19.tar.gz</span><br><span class="line">sudo tar xzf apache-tomcat-9.0.8.tar.gz</span><br><span class="line">sudo ln -s apache-tomcat-9.0.8 tomcat</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"export CATALINA_HOME=\"/opt/tomcat\""</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br><span class="line"><span class="built_in">cd</span> /opt/tomcat</span><br><span class="line">sudo bin/startup.sh</span><br></pre></td></tr></table></figure></p>
<p>Step 2, Verify with <a href="http://YOUR_INSTANCE_IP:8080/" target="_blank" rel="noopener">http://YOUR_INSTANCE_IP:8080/</a></p>
<h2 id="Run-Jupiter-on-EC2"><a href="#Run-Jupiter-on-EC2" class="headerlink" title="Run Jupiter on EC2"></a>Run Jupiter on EC2</h2><p><code>WAR</code> file (or Web application ARchive) is a JAR file used to distribute a collection of JavaServer Pages, Java Servlets, Java classes, XML files, tag libraries, static web pages (HTML and related files) and other resources that together constitute a web application.</p>
<p>Step 1, Open Eclipse and MAMP, verify your website works correctly on local environment:<br><a href="http://localhost:8080/Jupiter/" target="_blank" rel="noopener">http://localhost:8080/Jupiter/</a></p>
<p>Step 2, open your MySQLDBUtil.java, change and make sure port is 3306, and username and password are root.</p>
<blockquote>
<p>3306 is default port in MySQL</p>
</blockquote>
<p>Step 3, In Eclipse, select File -&gt; Export -&gt; Web-&gt;war File, save the war file to disk.</p>
<p>Step 4, Copy the war file to your instance.</p>
<p><strong><code>MAC</code></strong>:<br>Open a new terminal window and type:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -i ~/Downloads/mykey.pem  ~/Downloads/Jupiter.war ubuntu@YOUR_INSTANCE_IP:~/</span><br></pre></td></tr></table></figure></p>
<p>Windows (MSYS2): </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -i /c/Users/&lt;YOUR_USERNAME&gt;/Downloads/mykey.pem  /c/Users/&lt;YOUR_PATH&gt;/Jupiter.war ubuntu@YOUR_INSTANCE_IP:~/</span><br></pre></td></tr></table></figure>
<p>Windows (putty):<br>use WinSCP, <a href="https://winscp.net/download/WinSCP-5.13.2-Setup.exe" target="_blank" rel="noopener">https://winscp.net/download/WinSCP-5.13.2-Setup.exe</a></p>
<p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/14.%20Cloud%20Computing-2019-4-18-10-31-3.png" alt="14. Cloud Computing-2019-4-18-10-31-3.png"></p>
<p>Click Advanced-&gt;SSH-&gt;Authentication-&gt;Private key file: choose *.ppk </p>
<p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/14.%20Cloud%20Computing-2019-4-18-10-31-14.png" alt="14. Cloud Computing-2019-4-18-10-31-14.png"></p>
<p>Drag the Jupiter.war to the left (into /home/ubuntu/).</p>
<p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/14.%20Cloud%20Computing-2019-4-18-10-31-26.png" alt="14. Cloud Computing-2019-4-18-10-31-26.png"></p>
<p>Step 5, Both Mac and Windows, back to your terminal/putty, type the following command</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo cp ~/Jupiter.war /opt/tomcat/webapps/</span><br></pre></td></tr></table></figure>
<p>Step 6, Wait for a few seconds, then you can verify the server on your browser:<br><a href="http://YOUR_INSTANCE_IP:8080/Jupiter/" target="_blank" rel="noopener">http://YOUR_INSTANCE_IP:8080/Jupiter/</a></p>
<p><strong>Redeploy application</strong>: redo step 3-5.</p>
<h2 id="Debug-configuration"><a href="#Debug-configuration" class="headerlink" title="Debug configuration"></a>Debug configuration</h2><p>此处需要将eclipse的jdk jre compiler全部设为1.8并重新编译，即可解决版本问题。</p>
<h2 id="optional-Change-the-HTTP-port-from-8080-to-80"><a href="#optional-Change-the-HTTP-port-from-8080-to-80" class="headerlink" title="(optional) Change the HTTP port from 8080 to 80"></a>(optional) Change the HTTP port from 8080 to 80</h2><p>Step 1, On the remote command-line terminal, edit the tomcat configuration by:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /opt/tomcat/conf/server.xml</span><br></pre></td></tr></table></figure>
<p>Step 2, Press i to enter edit mode, scroll down to find the following line (around line 69):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;</span><br><span class="line">change &quot;8080&quot; to &quot;80&quot;</span><br></pre></td></tr></table></figure>
<p>Step 3, Press <code>ESC</code> to exit edit mode, then type <code>:wq</code> to save and exit.</p>
<p>Step 4, Restart tomcat by:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo /opt/tomcat/bin/shutdown.sh</span><br><span class="line">sudo /opt/tomcat/bin/startup.sh</span><br></pre></td></tr></table></figure>
<p>Step 5, Visit <a href="http://YOUR_IP_ADDRESS/Jupiter/" target="_blank" rel="noopener">http://YOUR_IP_ADDRESS/Jupiter/</a> to see if the server is started correctly.</p>
<blockquote>
<p>此处端口设为80，以后访问时就不需要再额外输入端口号了</p>
</blockquote>
<h2 id="optional-Make-tomcat-auto-start-when-Linux-boots"><a href="#optional-Make-tomcat-auto-start-when-Linux-boots" class="headerlink" title="(optional) Make tomcat auto start when Linux boots"></a>(optional) Make tomcat auto start when Linux boots</h2><p>Step 1, On you instance’s terminal, type the following command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/init.d/tomcat</span><br></pre></td></tr></table></figure>
<p>Step 2, Press i to enter the INSERT mode, then paste the following contents:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### BEGIN INIT INFO</span></span><br><span class="line"><span class="comment"># Provides: tomcat</span></span><br><span class="line"><span class="comment"># Required-Start: $network</span></span><br><span class="line"><span class="comment"># Required-Stop: $network</span></span><br><span class="line"><span class="comment"># Default-Start: 2 3 4 5</span></span><br><span class="line"><span class="comment"># Default-Stop: 0 1 6</span></span><br><span class="line"><span class="comment"># Short-Description: Start/Stop Tomcat server</span></span><br><span class="line"><span class="comment">### END INIT INFO</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start</span></span>() &#123;</span><br><span class="line"> sh /opt/tomcat/bin/startup.sh</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">stop</span></span>() &#123;</span><br><span class="line"> sh /opt/tomcat/bin/shutdown.sh</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">  start|stop) <span class="variable">$1</span>;;</span><br><span class="line">  restart) stop; start;;</span><br><span class="line">  *) <span class="built_in">echo</span> <span class="string">"Run as <span class="variable">$0</span> &lt;start|stop|restart&gt;"</span>; <span class="built_in">exit</span> 1;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure>
<p>Step 3, Press Esc to exit INSERT mode, then type <code>:wq</code> to save and quit.</p>
<p>Step 4, Make the new file executable: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /etc/init.d/tomcat</span><br></pre></td></tr></table></figure>
<p>Step 5, update <code>bashrc</code> to catch your script:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo update-rc.d tomcat defaults</span><br></pre></td></tr></table></figure>
<p>Step 6, (optional) you can use <code>sudo /etc/init.d/tomcat restart</code> to manually restart tomcat.</p>
<h2 id="optional-Make-tomcat-auto-restart-everyday"><a href="#optional-Make-tomcat-auto-restart-everyday" class="headerlink" title="(optional) Make tomcat auto restart everyday"></a>(optional) Make tomcat auto restart everyday</h2><p>Your web app may be not that stable to run for months. You can restart it every night to keep it healthy.</p>
<p>Step 1, On you instance’s terminal, type the following command: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo crontab -e</span><br></pre></td></tr></table></figure>
<p>Step 2, Input <code>3</code> to select <code>vim.basic</code> as the editor</p>
<p>Step 3, Move the cursor to the end, press i to enter edit mode. Input the following, It means restart tomcat at 1:00 and 13:00 UTC everyday.:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1,13   *   *   *   sudo /etc/init.d/tomcat restart</span><br></pre></td></tr></table></figure>
<blockquote>
<p>定时在1:00和13:00tomcat重启</p>
</blockquote>
<p>Step 4, Press Esc to exit INSERT mode, then type :wq to save and quit.</p>
<h1 id="Remote-debug"><a href="#Remote-debug" class="headerlink" title="Remote debug:"></a>Remote debug:</h1><p>You can check Java error from Tomcat runtime log. Location:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/opt/tomcat/logs/localhost.&lt;date&gt;.log</span><br></pre></td></tr></table></figure>
<ul>
<li>Check tomcat process:<br><code>ps aux|grep tomcat</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root     17273 78.3  7.9 2225932 80404 pts/0   Sl   20:30   0:02 /usr/bin/java -Djava.util.logging.config.file=/opt/tomcat/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Dorg.apache.catalina.security.SecurityListener.UMASK=0027 -Dignore.endorsed.dirs= -classpath /opt/tomcat/bin/bootstrap.jar:/opt/tomcat/bin/tomcat-juli.jar -Dcatalina.base=/opt/tomcat -Dcatalina.home=/opt/tomcat -Djava.io.tmpdir=/opt/tomcat/temp org.apache.catalina.startup.Bootstrap start</span><br></pre></td></tr></table></figure>
<blockquote>
<p>17273 is the process id</p>
</blockquote>
<ul>
<li>To kill the process</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Sudo kill -9 17273</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/18/[Notes] AJAX Basic/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yanpeng Luo">
      <meta itemprop="description" content="Notes of study, work and life">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yanpeng">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/18/[Notes] AJAX Basic/" class="post-title-link" itemprop="url">[Notes] AJAX Basic</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-18 02:00:51" itemprop="dateCreated datePublished" datetime="2019-04-18T02:00:51-07:00">2019-04-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-04-17 19:01:37" itemprop="dateModified" datetime="2019-04-17T19:01:37-07:00">2019-04-17</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CS/" itemprop="url" rel="index"><span itemprop="name">CS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">9.8k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">9 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="What-is-AJAX"><a href="#What-is-AJAX" class="headerlink" title="What is AJAX?"></a>What is AJAX?</h1><p>AJAX is not a programming language.<br>AJAX just uses a combination of:</p>
<ul>
<li>A browser built-in XMLHttpRequest object (to request data from a web server)</li>
<li>JavaScript and HTML DOM (to display or use the data)</li>
</ul>
<blockquote>
<p>AJAX 可以实现异步通信</p>
</blockquote>
<h1 id="How-AJAX-Works"><a href="#How-AJAX-Works" class="headerlink" title="How AJAX Works"></a>How AJAX Works</h1><p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/13.%20AJAX%20Basic-2019-4-17-13-40-54.png" alt="13. AJAX Basic-2019-4-17-13-40-54.png"></p>
<h1 id="How-to-use-AJAX"><a href="#How-to-use-AJAX" class="headerlink" title="How to use AJAX"></a>How to use AJAX</h1><p>The keystone of AJAX is the XMLHttpRequest object.</p>
<h2 id="creating-an-XMLHttpRequest-object"><a href="#creating-an-XMLHttpRequest-object" class="headerlink" title="creating an XMLHttpRequest object"></a>creating an XMLHttpRequest object</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xhttp = <span class="keyword">new</span> XMLHttpRequest();</span><br></pre></td></tr></table></figure>
<h2 id="send-a-request-to-a-server-we-use-the-open-and-send-methods-of-the-XMLHttpRequest-object"><a href="#send-a-request-to-a-server-we-use-the-open-and-send-methods-of-the-XMLHttpRequest-object" class="headerlink" title="send a request to a server, we use the open() and send() methods of the XMLHttpRequest object"></a>send a request to a server, we use the <code>open()</code> and <code>send()</code> methods of the <code>XMLHttpRequest</code> object</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xhttp.open(<span class="string">"GET"</span>, <span class="string">"ajax_info.txt"</span>, <span class="literal">true</span>);</span><br><span class="line">xhttp.send();</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/YanpengQi/images/master/13.%20AJAX%20Basic-2019-4-17-13-46-10.png" alt="13. AJAX Basic-2019-4-17-13-46-10.png"></p>
<h2 id="GET-or-POST"><a href="#GET-or-POST" class="headerlink" title="GET or POST?"></a>GET or POST?</h2><p>GET is simpler and faster than POST, and can be used in most cases.<br>However, always use POST requests when:</p>
<ul>
<li>A cached file is not an option (update a file or database on the server).</li>
<li>Sending a large amount of data to the server (POST has no size limitations).</li>
<li>Sending user input (which can contain unknown characters), POST is more robust and secure than GET.</li>
</ul>
<h2 id="Project"><a href="#Project" class="headerlink" title="Project"></a>Project</h2><p>demo of our web applications: <a href="http://34.211.21.63/Event/" target="_blank" rel="noopener">http://34.211.21.63/Event/</a> </p>
<h1 id="Complete-HTML-CSS-Javascript-code"><a href="#Complete-HTML-CSS-Javascript-code" class="headerlink" title="Complete HTML/CSS/Javascript code"></a>Complete HTML/CSS/Javascript code</h1><p><a href="http://jsbin.com/hocukukiva/edit?html,css,js" target="_blank" rel="noopener">http://jsbin.com/hocukukiva/edit?html,css,js</a></p>
<p>将JSBin里面的代码分别放在：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/WebContent/index.html</span><br><span class="line">/WebContent/styles/main.css</span><br><span class="line">/WebContent/scripts/main.js</span><br></pre></td></tr></table></figure></p>
<p>访问： <a href="http://localhost:8080/Jupiter" target="_blank" rel="noopener">http://localhost:8080/Jupiter</a></p>
<blockquote>
<p>自动跳转至index.html<br><a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/dataset" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/dataset</a></p>
</blockquote>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">font-size</span>: 0<span class="selector-class">.9em</span>; </span><br><span class="line"><span class="comment">/* means 0.9 * parent's font-size  */</span></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.top-nav</span> &#123;</span><br><span class="line">	<span class="comment">/* flex means listed from left to right  */</span></span><br><span class="line">	<span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="JavaScript"><a href="#JavaScript" class="headerlink" title="JavaScript"></a>JavaScript</h1><h2 id="Step-1-Run-the-scripts"><a href="#Step-1-Run-the-scripts" class="headerlink" title="Step 1 ()() Run the scripts"></a>Step 1 ()() Run the scripts</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run all following scripts</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>
<h2 id="Step-2-Gloval-Variables"><a href="#Step-2-Gloval-Variables" class="headerlink" title="Step 2 Gloval Variables"></a>Step 2 Gloval Variables</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> user_id = <span class="string">'1111'</span>;</span><br><span class="line"><span class="keyword">var</span> user_fullname = <span class="string">'John Smith'</span>;</span><br><span class="line"><span class="keyword">var</span> lng = <span class="number">-122.08</span>;</span><br><span class="line"><span class="keyword">var</span> lat = <span class="number">37.38</span>;</span><br></pre></td></tr></table></figure>
<h2 id="step3-main-function-entrance"><a href="#step3-main-function-entrance" class="headerlink" title="step3: main function(entrance)"></a>step3: main function(entrance)</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">init();</span><br><span class="line"><span class="comment">/* step4: define init function */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Register event listeners</span></span><br><span class="line">  $(<span class="string">'nearby-btn'</span>).addEventListener(<span class="string">'click'</span>, loadNearbyItems);</span><br><span class="line"><span class="comment">//		$('fav-btn').addEventListener('click', loadFavoriteItems);</span></span><br><span class="line"><span class="comment">//		$('recommend-btn').addEventListener('click', loadRecommendedItems);</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">var</span> welcomeMsg = $(<span class="string">'welcome-msg'</span>);</span><br><span class="line">          welcomeMsg.innerHTML = <span class="string">'Welcome, '</span> + user_fullname;</span><br><span class="line">      </span><br><span class="line">          <span class="comment">// step 7</span></span><br><span class="line">          initGeoLocation();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step5-create-function"><a href="#step5-create-function" class="headerlink" title="step5: create $ function"></a>step5: create $ function</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A helper function that creates a DOM element &lt;tag options...&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> $(<span class="params">tag, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!options) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">document</span>.getElementById(tag);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> element = <span class="built_in">document</span>.createElement(tag);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( <span class="keyword">var</span> option <span class="keyword">in</span> options) &#123;</span><br><span class="line">    <span class="keyword">if</span> (options.hasOwnProperty(option)) &#123;</span><br><span class="line">      element[option] = options[option];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> element;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step6-create-AJAX-helper-function"><a href="#step6-create-AJAX-helper-function" class="headerlink" title="step6: create AJAX helper function"></a>step6: create AJAX helper function</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param method - GET|POST|PUT|DELETE</span></span><br><span class="line"><span class="comment"> * @param url - API end point</span></span><br><span class="line"><span class="comment"> * @param callback - This the successful callback</span></span><br><span class="line"><span class="comment"> * @param errorHandler - This is the failed callback</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ajax</span>(<span class="params">method, url, data, callback, errorHandler</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line"></span><br><span class="line">  xhr.open(method, url, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断request</span></span><br><span class="line">  xhr.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 判断 resopnse</span></span><br><span class="line">    <span class="keyword">if</span> (xhr.status === <span class="number">200</span>) &#123;</span><br><span class="line">      <span class="comment">// callback 属于回调函数</span></span><br><span class="line">      callback(xhr.responseText);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (xhr.status === <span class="number">403</span>) &#123;</span><br><span class="line">      onSessionInvalid();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      errorHandler();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  xhr.onerror = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">"The request couldn't be completed."</span>);</span><br><span class="line">    errorHandler();</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (data === <span class="literal">null</span>) &#123;</span><br><span class="line">    xhr.send();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    xhr.setRequestHeader(<span class="string">"Content-Type"</span>,</span><br><span class="line">        <span class="string">"application/json;charset=utf-8"</span>);</span><br><span class="line">    xhr.send(data);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step-7-initGeoLocation-function"><a href="#step-7-initGeoLocation-function" class="headerlink" title="step 7: initGeoLocation function"></a>step 7: initGeoLocation function</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initGeoLocation</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (navigator.geolocation) &#123;</span><br><span class="line">    <span class="comment">// step 8</span></span><br><span class="line">    <span class="comment">// get current position by browser.</span></span><br><span class="line">    navigator.geolocation.getCurrentPosition(onPositionUpdated,</span><br><span class="line">        onLoadPositionFailed, &#123;</span><br><span class="line">          maximumAge : <span class="number">60000</span></span><br><span class="line">        &#125;);</span><br><span class="line">    showLoadingMessage(<span class="string">'Retrieving your location...'</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// step 9</span></span><br><span class="line">    onLoadPositionFailed();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step-8-onPositionUpdated-function"><a href="#step-8-onPositionUpdated-function" class="headerlink" title="step 8: onPositionUpdated function"></a>step 8: onPositionUpdated function</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onPositionUpdated</span>(<span class="params">position</span>) </span>&#123;</span><br><span class="line">  lat = position.coords.latitude;</span><br><span class="line">  lng = position.coords.longitude;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// step 11</span></span><br><span class="line">  loadNearbyItems();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step-9-onLoadPositionFailed-function"><a href="#step-9-onLoadPositionFailed-function" class="headerlink" title="step 9: onLoadPositionFailed function"></a>step 9: onLoadPositionFailed function</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onLoadPositionFailed</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.warn(<span class="string">'navigator.geolocation is not available'</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//step 10</span></span><br><span class="line">  getLocationFromIP();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step-10-getLocationFromIP-function"><a href="#step-10-getLocationFromIP-function" class="headerlink" title="step 10: getLocationFromIP function"></a>step 10: getLocationFromIP function</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getLocationFromIP</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Get location from http://ipinfo.io/json</span></span><br><span class="line">  <span class="keyword">var</span> url = <span class="string">'http://ipinfo.io/json'</span></span><br><span class="line">  <span class="keyword">var</span> req = <span class="literal">null</span>;</span><br><span class="line">  ajax(<span class="string">'GET'</span>, url, req, <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="built_in">JSON</span>.parse(res);</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'loc'</span> <span class="keyword">in</span> result) &#123;</span><br><span class="line">      <span class="keyword">var</span> loc = result.loc.split(<span class="string">','</span>);</span><br><span class="line">      lat = loc[<span class="number">0</span>];</span><br><span class="line">      lng = loc[<span class="number">1</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.warn(<span class="string">'Getting location by IP failed.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// step 11</span></span><br><span class="line">    loadNearbyItems();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step-11-loadNearbyItems-function"><a href="#step-11-loadNearbyItems-function" class="headerlink" title="step 11: loadNearbyItems function"></a>step 11: loadNearbyItems function</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * API #1 Load the nearby items API end point: [GET]</span></span><br><span class="line"><span class="comment"> * /Dashi/search?user_id=1111&amp;lat=37.38&amp;lon=-122.08</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadNearbyItems</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'loadNearbyItems'</span>);</span><br><span class="line">  <span class="comment">// step 12</span></span><br><span class="line">  activeBtn(<span class="string">'nearby-btn'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The request parameters</span></span><br><span class="line">  <span class="keyword">var</span> url = <span class="string">'./search'</span>;</span><br><span class="line">  <span class="keyword">var</span> params = <span class="string">'user_id='</span> + user_id + <span class="string">'&amp;lat='</span> + lat + <span class="string">'&amp;lon='</span> + lng;</span><br><span class="line">  <span class="keyword">var</span> req = <span class="built_in">JSON</span>.stringify(&#123;&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// step 13</span></span><br><span class="line">  <span class="comment">// display loading message</span></span><br><span class="line">  showLoadingMessage(<span class="string">'Loading nearby items...'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// make AJAX call</span></span><br><span class="line">  ajax(<span class="string">'GET'</span>, url + <span class="string">'?'</span> + params, req,</span><br><span class="line">  <span class="comment">// successful callback</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> items = <span class="built_in">JSON</span>.parse(res);</span><br><span class="line">    <span class="keyword">if</span> (!items || items.length === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// step 14</span></span><br><span class="line">      showWarningMessage(<span class="string">'No nearby item.'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// step 16</span></span><br><span class="line">      listItems(items);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// failed callback</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// step 15</span></span><br><span class="line">    showErrorMessage(<span class="string">'Cannot load nearby items.'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step-12-activeBtn-function"><a href="#step-12-activeBtn-function" class="headerlink" title="step 12: activeBtn function"></a>step 12: activeBtn function</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A helper function that makes a navigation button active</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param btnId - The id of the navigation button</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">activeBtn</span>(<span class="params">btnId</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> btns = <span class="built_in">document</span>.getElementsByClassName(<span class="string">'main-nav-btn'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// deactivate all navigation buttons</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; btns.length; i++) &#123;</span><br><span class="line">    btns[i].className = btns[i].className.replace(<span class="regexp">/\bactive\b/</span>, <span class="string">''</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// active the one that has id = btnId</span></span><br><span class="line">  <span class="keyword">var</span> btn = $(btnId);</span><br><span class="line">  btn.className += <span class="string">' active'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step-13-showLoadingMessage-function"><a href="#step-13-showLoadingMessage-function" class="headerlink" title="step 13: showLoadingMessage function"></a>step 13: showLoadingMessage function</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showLoadingMessage</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> itemList = $(<span class="string">'item-list'</span>);</span><br><span class="line">  itemList.innerHTML = <span class="string">'&lt;p class="notice"&gt;&lt;i class="fa fa-spinner fa-spin"&gt;&lt;/i&gt; '</span></span><br><span class="line">      + msg + <span class="string">'&lt;/p&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** step 14: showWarningMessage function **/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showWarningMessage</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> itemList = $(<span class="string">'item-list'</span>);</span><br><span class="line">  itemList.innerHTML = <span class="string">'&lt;p class="notice"&gt;&lt;i class="fa fa-exclamation-triangle"&gt;&lt;/i&gt; '</span></span><br><span class="line">      + msg + <span class="string">'&lt;/p&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** step15: showErrorMessage function **/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showErrorMessage</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> itemList = $(<span class="string">'item-list'</span>);</span><br><span class="line">  itemList.innerHTML = <span class="string">'&lt;p class="notice"&gt;&lt;i class="fa fa-exclamation-circle"&gt;&lt;/i&gt; '</span></span><br><span class="line">      + msg + <span class="string">'&lt;/p&gt;'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step16-listItems-function"><a href="#step16-listItems-function" class="headerlink" title="step16: listItems function"></a>step16: listItems function</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @param items - An array of item JSON objects</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">listItems</span>(<span class="params">items</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Clear the current results</span></span><br><span class="line">  <span class="keyword">var</span> itemList = $(<span class="string">'item-list'</span>);</span><br><span class="line">  itemList.innerHTML = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; items.length; i++) &#123;</span><br><span class="line">    <span class="comment">// step 17</span></span><br><span class="line">    addItem(itemList, items[i]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step17-addItem-function"><a href="#step17-addItem-function" class="headerlink" title="step17: addItem function"></a>step17: addItem function</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add item to the list</span></span><br><span class="line"><span class="comment"> * @param itemList - The &lt;ul id="item-list"&gt; tag</span></span><br><span class="line"><span class="comment"> * @param item - The item data (JSON object)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addItem</span>(<span class="params">itemList, item</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> item_id = item.item_id;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// create the &lt;li&gt; tag and specify the id and class attributes</span></span><br><span class="line">  <span class="keyword">var</span> li = $(<span class="string">'li'</span>, &#123;</span><br><span class="line">    id : <span class="string">'item-'</span> + item_id,</span><br><span class="line">    className : <span class="string">'item'</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set the data attribute</span></span><br><span class="line">  li.dataset.item_id = item_id;</span><br><span class="line">  li.dataset.favorite = item.favorite;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// item image</span></span><br><span class="line">  <span class="keyword">if</span> (item.image_url) &#123;</span><br><span class="line">    li.appendChild($(<span class="string">'img'</span>, &#123;</span><br><span class="line">      src : item.image_url</span><br><span class="line">    &#125;));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    li.appendChild($(<span class="string">'img'</span>, &#123;</span><br><span class="line">      src : <span class="string">'https://assets-cdn.github.com/images/modules/logos_page/GitHub-Mark.png'</span></span><br><span class="line">    &#125;))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// section</span></span><br><span class="line">  <span class="keyword">var</span> section = $(<span class="string">'div'</span>, &#123;&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// title</span></span><br><span class="line">  <span class="keyword">var</span> title = $(<span class="string">'a'</span>, &#123;</span><br><span class="line">    href : item.url,</span><br><span class="line">    target : <span class="string">'_blank'</span>,</span><br><span class="line">    className : <span class="string">'item-name'</span></span><br><span class="line">  &#125;);</span><br><span class="line">  title.innerHTML = item.name;</span><br><span class="line">  section.appendChild(title);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// category</span></span><br><span class="line">  <span class="keyword">var</span> category = $(<span class="string">'p'</span>, &#123;</span><br><span class="line">    className : <span class="string">'item-category'</span></span><br><span class="line">  &#125;);</span><br><span class="line">  category.innerHTML = <span class="string">'Category: '</span> + item.categories.join(<span class="string">', '</span>);</span><br><span class="line">  section.appendChild(category);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> stars = $(<span class="string">'div'</span>, &#123;</span><br><span class="line">    className : <span class="string">'stars'</span></span><br><span class="line">  &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; item.rating; i++) &#123;</span><br><span class="line">    <span class="keyword">var</span> star = $(<span class="string">'i'</span>, &#123;</span><br><span class="line">      className : <span class="string">'fa fa-star'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    stars.appendChild(star);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((<span class="string">''</span> + item.rating).match(<span class="regexp">/\.5$/</span>)) &#123;</span><br><span class="line">    stars.appendChild($(<span class="string">'i'</span>, &#123;</span><br><span class="line">      className : <span class="string">'fa fa-star-half-o'</span></span><br><span class="line">    &#125;));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  section.appendChild(stars);</span><br><span class="line"></span><br><span class="line">  li.appendChild(section);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// address</span></span><br><span class="line">  <span class="keyword">var</span> address = $(<span class="string">'p'</span>, &#123;</span><br><span class="line">    className : <span class="string">'item-address'</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  address.innerHTML = item.address.replace(<span class="regexp">/,/g</span>, <span class="string">'&lt;br/&gt;'</span>).replace(<span class="regexp">/\"/g</span>,</span><br><span class="line">      <span class="string">''</span>);</span><br><span class="line">  li.appendChild(address);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// favorite link</span></span><br><span class="line">  <span class="keyword">var</span> favLink = $(<span class="string">'p'</span>, &#123;</span><br><span class="line">    className : <span class="string">'fav-link'</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  favLink.onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    changeFavoriteItem(item_id);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  favLink.appendChild($(<span class="string">'i'</span>, &#123;</span><br><span class="line">    id : <span class="string">'fav-icon-'</span> + item_id,</span><br><span class="line">    className : item.favorite ? <span class="string">'fa fa-heart'</span> : <span class="string">'fa fa-heart-o'</span></span><br><span class="line">  &#125;));</span><br><span class="line"></span><br><span class="line">  li.appendChild(favLink);</span><br><span class="line"></span><br><span class="line">  itemList.appendChild(li);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Yanpeng Luo</p>
              <div class="site-description motion-element" itemprop="description">Notes of study, work and life</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">26</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/YanpengQi" title="GitHub &rarr; https://github.com/YanpengQi" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:YanpengQi@gmail.com" title="E-Mail &rarr; mailto:YanpengQi@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  
    <div id="sidebar-dimmer"></div>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yanpeng Luo</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="Symbols count total">202k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="Reading time total">3:04</span>
  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.0.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  



  
    
    
  
  <script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>











  



  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script>

  
  <script src="/lib/reading_progress/reading_progress.js"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/schemes/muse.js?v=7.0.1"></script>



  

  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  



  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('-1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  
  
  
  <script src="/lib/bookmark/bookmark.min.js?v=1.0"></script>
  <script>
  
    bookmark.loadBookmark();
  
  </script>


  

  

  

</body>
</html>
